<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Vlad Faust">
<title>The Onyx programming language</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>The Onyx programming language</h1>
<div class="details">
<span id="author" class="author">Vlad Faust</span><br>
<span id="email" class="email"><a href="mailto:mail@vladfaust.com">mail@vladfaust.com</a></span><br>
<span id="revnumber">version 0.0.0,</span>
<span id="revdate">August 23, 2020</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_foreword">Foreword</a></li>
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_scope">1. Scope</a></li>
<li><a href="#_normative_references">2. Normative references</a></li>
<li><a href="#_terms_and_definitions">3. Terms and definitions</a></li>
<li><a href="#_symbols_and_abbreviated_terms">4. Symbols and abbreviated terms</a></li>
<li><a href="#_conventions">5. Conventions</a>
<ul class="sectlevel2">
<li><a href="#_specification_units">5.1. Specification units</a></li>
<li><a href="#_examples">5.2. Examples</a></li>
</ul>
</li>
<li><a href="#_terms">6. Terms</a>
<ul class="sectlevel2">
<li><a href="#_syntax">6.1. Syntax</a></li>
</ul>
</li>
<li><a href="#_design">7. Design</a>
<ul class="sectlevel2">
<li><a href="#_annotations_vs_keywords">7.1. Annotations VS keywords</a></li>
</ul>
</li>
<li><a href="#_syntax_2">8. Syntax</a></li>
<li><a href="#_variables">9. Variables</a>
<ul class="sectlevel2">
<li><a href="#_declaration">9.1. Declaration</a></li>
<li><a href="#_variable_storage">9.2. Variable storage</a></li>
<li><a href="#_static_variables">9.3. Static variables</a></li>
<li><a href="#_instance_variables">9.4. Instance variables</a></li>
<li><a href="#_local_variables">9.5. Local variables</a></li>
<li><a href="#_final_variables">9.6. Final variables</a></li>
<li><a href="#_non_final_variables">9.7. Non-final variables</a></li>
<li><a href="#_lifetime">9.8. Lifetime</a>
<ul class="sectlevel3">
<li><a href="#_moving_variables">9.8.1. Moving variables</a></li>
</ul>
</li>
<li><a href="#_assignment">9.9. Assignment</a></li>
</ul>
</li>
<li><a href="#_functions">10. Functions</a>
<ul class="sectlevel2">
<li><a href="#_declaration_2">10.1. Declaration</a></li>
<li><a href="#_storage">10.2. Storage</a></li>
<li><a href="#_mutability">10.3. Mutability</a></li>
<li><a href="#_manipulating_definitions">10.4. Manipulating definitions</a>
<ul class="sectlevel3">
<li><a href="#_unimplementation">10.4.1. Unimplementation</a></li>
<li><a href="#_reimplementation">10.4.2. Reimplementation</a></li>
</ul>
</li>
<li><a href="#_generators">10.5. Generators</a></li>
<li><a href="#_returning">10.6. Returning</a></li>
<li><a href="#_pure_functions">10.7. Pure functions</a></li>
</ul>
</li>
<li><a href="#_safety">11. Safety</a>
<ul class="sectlevel2">
<li><a href="#_safety_statements">11.1. Safety statements</a></li>
<li><a href="#_safety_modifiers">11.2. Safety modifiers</a></li>
</ul>
</li>
<li><a href="#_types">12. Types</a>
<ul class="sectlevel2">
<li><a href="#_members">12.1. Members</a></li>
<li><a href="#_generic_types">12.2. Generic types</a></li>
<li><a href="#_type_specialization">12.3. Type specialization</a></li>
<li><a href="#_type_completeness">12.4. Type completeness</a></li>
<li><a href="#_type_inheritance">12.5. Type inheritance</a></li>
<li><a href="#_reopening">12.6. Reopening</a></li>
<li><a href="#_refining">12.7. Refining</a></li>
<li><a href="#_restriction">12.8. Restriction</a></li>
<li><a href="#_float">12.9. Float</a></li>
<li><a href="#_fixed_point_numbers">12.10. Fixed-point numbers</a>
<ul class="sectlevel3">
<li><a href="#_binary_fixed_point_number_encoding">12.10.1. Binary fixed-point number encoding</a></li>
<li><a href="#_decimal_fixed_point_number_encoding">12.10.2. Decimal fixed-point number encoding</a></li>
</ul>
</li>
<li><a href="#_units">12.11. Units</a></li>
</ul>
</li>
<li><a href="#_structs">13. Structs</a>
<ul class="sectlevel2">
<li><a href="#_members_2">13.1. Members</a></li>
<li><a href="#struct-lifetime">13.2. Lifetime</a>
<ul class="sectlevel3">
<li><a href="#struct-initialization">13.2.1. Initialization</a></li>
<li><a href="#struct-finalization">13.2.2. Finalization</a></li>
</ul>
</li>
<li><a href="#struct-reopening">13.3. Reopening</a></li>
<li><a href="#_completeness">13.4. Completeness</a></li>
<li><a href="#_extending">13.5. Extending</a></li>
<li><a href="#_memory_layout">13.6. Memory layout</a>
<ul class="sectlevel3">
<li><a href="#ordering">13.6.1. Ordering</a></li>
<li><a href="#_packing">13.6.2. Packing</a></li>
</ul>
</li>
<li><a href="#_anonymous_structs">13.7. Anonymous structs</a>
<ul class="sectlevel3">
<li><a href="#_anonymous_struct_literals">13.7.1. Anonymous struct literals</a></li>
<li><a href="#_anonymous_struct_destruction">13.7.2. Anonymous struct destruction</a></li>
<li><a href="#_anonymous_struct_member_ordering">13.7.3. Anonymous struct member ordering</a></li>
<li><a href="#_packed_anonymous_structs">13.7.4. Packed anonymous structs</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_traits">14. Traits</a>
<ul class="sectlevel2">
<li><a href="#_declaring_a_trait">14.1. Declaring a trait</a></li>
<li><a href="#_trait_arithmetic">14.2. Trait arithmetic</a></li>
<li><a href="#_deriving_from_a_trait">14.3. Deriving from a trait</a>
<ul class="sectlevel3">
<li><a href="#_behavioral_erasure">14.3.1. Behavioral erasure</a></li>
</ul>
</li>
<li><a href="#_abstract_traits">14.4. Abstract traits</a></li>
</ul>
</li>
<li><a href="#_core_api">15. Core API</a></li>
<li><a href="#_directives">16. Directives</a>
<ul class="sectlevel2">
<li><a href="#_file_dependency_directives">16.1. File dependency directives</a>
<ul class="sectlevel3">
<li><a href="#_require_directive">16.1.1. <code>require</code> directive</a></li>
<li><a href="#_import_directive">16.1.2. <code>import</code> directive</a></li>
</ul>
</li>
<li><a href="#_using_directive">16.2. <code>using</code> directive</a></li>
</ul>
</li>
<li><a href="#_literals">17. Literals</a>
<ul class="sectlevel2">
<li><a href="#literal-constrainment">17.1. Literal constrainment</a></li>
<li><a href="#_underscores">17.2. Underscores</a></li>
<li><a href="#_literal_suffixes">17.3. Literal suffixes</a></li>
<li><a href="#_scalar_literals">17.4. Scalar literals</a>
<ul class="sectlevel3">
<li><a href="#_numeric_literals">17.4.1. Numeric literals</a></li>
<li><a href="#_text_literals">17.4.2. Text literals</a></li>
<li><a href="#_symbol_literals">17.4.3. Symbol literals</a></li>
</ul>
</li>
<li><a href="#_aggregate_literals">17.5. Aggregate literals</a>
<ul class="sectlevel3">
<li><a href="#_array_literals">17.5.1. Array literals</a></li>
<li><a href="#_tensor_literals">17.5.2. Tensor literals</a></li>
<li><a href="#_tuple_literals">17.5.3. Tuple literals</a></li>
<li><a href="#_range_literals">17.5.4. Range literals</a></li>
</ul>
</li>
<li><a href="#_magic_literals">17.6. Magic literals</a>
<ul class="sectlevel3">
<li><a href="#_word_literals">17.6.1. Word literals</a></li>
<li><a href="#_quoted_string_literals">17.6.2. Quoted string literals</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_interoperability">18. Interoperability</a>
<ul class="sectlevel2">
<li><a href="#c-standard">18.1. C standard</a></li>
<li><a href="#importing">18.2. Importing</a>
<ul class="sectlevel3">
<li><a href="#c-type-mapping">18.2.1. Type mapping</a></li>
<li><a href="#importing-variables">18.2.2. Importing variables</a></li>
<li><a href="#importing-functions">18.2.3. Importing functions</a></li>
<li><a href="#importing-enums">18.2.4. Importing enums</a></li>
<li><a href="#importing-unions">18.2.5. Importing unions</a></li>
<li><a href="#importing-structs">18.2.6. Importing structs</a></li>
<li><a href="#importing-typedefs">18.2.7. Importing typedefs</a></li>
<li><a href="#importing-macros">18.2.8. Importing preprocessor macros</a></li>
</ul>
</li>
<li><a href="#exporting">18.3. Exporting</a>
<ul class="sectlevel3">
<li><a href="#exporting-functions">18.3.1. Exporting functions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_compiled_syntax">Appendix A: Compiled Syntax</a></li>
<li><a href="#_optimization">Appendix B: Optimization</a></li>
<li><a href="#_nxapi">Appendix C: NXAPI</a>
<ul class="sectlevel2">
<li><a href="#_schema">C.1. Schema</a></li>
<li><a href="#_structure">C.2. Structure</a></li>
<li><a href="#_nodes">C.3. Nodes</a>
<ul class="sectlevel3">
<li><a href="#_special_nodes">C.3.1. Special nodes</a></li>
<li><a href="#_delayed_macro_expr">C.3.2. <code>delayed_macro_expr</code></a></li>
<li><a href="#_namespace_decl">C.3.3. <code>namespace_decl</code></a></li>
<li><a href="#_var_decl">C.3.4. <code>var_decl</code></a></li>
<li><a href="#_function_decl">C.3.5. <code>function_decl</code></a></li>
<li><a href="#_forall_element">C.3.6. <code>forall_element</code></a></li>
<li><a href="#_arg_decl">C.3.7. <code>arg_decl</code></a></li>
<li><a href="#_arg_pass">C.3.8. <code>arg_pass</code></a></li>
<li><a href="#_type_expr">C.3.9. <code>type_expr</code></a></li>
<li><a href="#_type_expr_op">C.3.10. <code>type_expr_op</code></a></li>
<li><a href="#_type_ref">C.3.11. <code>type_ref</code></a></li>
<li><a href="#_trait_decl">C.3.12. <code>trait_decl</code></a></li>
<li><a href="#_struct_decl">C.3.13. <code>struct_decl</code></a></li>
<li><a href="#_enum_decl">C.3.14. <code>enum_decl</code></a></li>
<li><a href="#_enum_val_decl">C.3.15. <code>enum_val_decl</code></a></li>
<li><a href="#_annotation_decl">C.3.16. <code>annotation_decl</code></a></li>
<li><a href="#_annotation_call">C.3.17. <code>annotation_call</code></a></li>
<li><a href="#_intrinsic_decl">C.3.18. <code>intrinsic_decl</code></a></li>
<li><a href="#_delayed_intrinsic_call">C.3.19. <code>delayed_intrinsic_call</code></a></li>
</ul>
</li>
<li><a href="#_examples_2">C.4. Examples</a></li>
</ul>
</li>
<li><a href="#_core_api_2">Appendix D: Core API</a></li>
<li><a href="#_macros_api">Appendix E: Macros API</a></li>
<li><a href="#_glossary">Glossary</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_foreword"><a class="link" href="#_foreword">Foreword</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>NXSF (the Onyx Software Foundation) is an international non-profit organization with a mission to develop the Onyx programming language and its ecosystem.
More information on NXSF can be found at <a href="https://nxsf.org" class="bare">https://nxsf.org</a>.</p>
</div>
<div class="paragraph">
<p>This document is developed by the NXSF Onyx Standard Committee.
Any feedback or questions on this document should be directed to the NXSF Onyx Standard Committee at <a href="mailto:onyx@nxsf.org">onyx@nxsf.org</a>.</p>
</div>
<div class="paragraph">
<p>A entity willing to become a member of the NXSF Onyx Standard Committee or any other NXSF Committee to obtain voting rights on developing documents should consult to the information found at <a href="https://nxsf.org/membership" class="bare">https://nxsf.org/membership</a>.</p>
</div>
<div class="paragraph">
<p>The procedures used to develop this document and those intended for its further maintenance are described in the NXSF Directives found at <a href="https://nxsf.org/directives" class="bare">https://nxsf.org/directives</a>.</p>
</div>
<div class="paragraph">
<p>This document follows the <a href="https://semver.org/spec/v2.0.0.html">Semantic Versioning 2.0</a> scheme.
Multiple major versions of this document may co-exist simultaneously, but every revision replaces previous minor and patch versions of this document.</p>
</div>
<div class="paragraph">
<p>Attention is drawn to the possibility that some of the elements of this document may be the subject of patent rights.
NXSF shall not be held responsible for identifying any or all such patent rights.
Details of any patent rights identified during the development of the document will be in the Introduction and/or on the NXSF list of patent declarations received found at <a href="https://nxsf.org/patents" class="bare">https://nxsf.org/patents</a>.</p>
</div>
<div class="paragraph">
<p>Any trade name used in this document is information given for the convenience of users and does not constitute an endorsement.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="link" href="#_introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Onyx programming language is a statically-typed general purpose programming language with the following design goals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Performance in mind.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scope"><a class="link" href="#_scope">1. Scope</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This specification describes the form and establishes the interpretation of programs written in the Onyx programming language. It describes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The representation of Onyx programs;</p>
</li>
<li>
<p>The syntax and constraints of the Onyx language;</p>
</li>
<li>
<p>The semantic rules for interpreting Onyx programs;</p>
</li>
<li>
<p>The restrictions and limits imposed by a conforming implementation of Onyx.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This specification does not describe:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The mechanism by which Onyx programs are transformed for use by a data-processing system;</p>
</li>
<li>
<p>The mechanism by which Onyx applications are invoked for use by a data-processing system;</p>
</li>
<li>
<p>The mechanism by which input data are transformed for use by a Onyx application;</p>
</li>
<li>
<p>The mechanism by which output data are transformed after being produced by a Onyx application;</p>
</li>
<li>
<p>The size or complexity of a program and its data that will exceed the capacity of any specific data- processing system or the capacity of a particular processor;</p>
</li>
<li>
<p>All minimal requirements of a data-processing system that is capable of supporting a conforming implementation.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_normative_references"><a class="link" href="#_normative_references">2. Normative references</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following documents are referred to in the text in such a way that some or all of their content constitutes requirements of this document.
For dated references, only the edition cited applies.
For undated references, the latest edition of the referenced document (including any amendments) applies.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ISO 9000:2015, Quality management systems — Fundamentals and vocabulary</p>
</li>
<li>
<p>ISO/IEC 9899:2018, Information technology — Programming languages — C</p>
</li>
<li>
<p>IEEE 754-2008, IEEE Standard for Floating-Point Arithmetic</p>
</li>
<li>
<p>ISO/IEC 10967 (all parts), Information technology — Language independent arithmetic</p>
</li>
<li>
<p>ISO/IEC 10646, Information technology — Universal Coded Character Set (UCS)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terms_and_definitions"><a class="link" href="#_terms_and_definitions">3. Terms and definitions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the purposes of this specification, the following definitions apply.
Other terms are defined where they appear in italic type or on the left side of a syntax rule.
Terms explicitly defined in this specification are not to be presumed to refer implicitly to similar terms defined elsewhere.
Terms not defined in this specification are to be interpreted according to ISO/IEC 2382.1.
Mathematical symbols not defined in this specification are to be interpreted according to ISO 80000-2.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_symbols_and_abbreviated_terms"><a class="link" href="#_symbols_and_abbreviated_terms">4. Symbols and abbreviated terms</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_conventions"><a class="link" href="#_conventions">5. Conventions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes conventions used in this specification.</p>
</div>
<div class="paragraph">
<p>This specification may borrow terms and practices from different standards <em>on how to write standards</em>, such as <em>The ISO/IEC Directives, Part 2</em>.
However, it does not aim to fully comply with either, unless explicitly stated another.</p>
</div>
<div class="paragraph">
<div class="title">Specification language</div>
<p>The specification is written in English language with Oxford spelling.</p>
</div>
<div class="sect2">
<h3 id="_specification_units"><a class="link" href="#_specification_units">5.1. Specification units</a></h3>
<div id="term-specification-unit" class="dlist">
<dl>
<dt class="hdlist1">Specification unit</dt>
<dd>
<p>A specification unit is a paragraph, an example block, a syntax definition listing, a table or a figure.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A specification unit other than an example block may be either normative or informative.
An example block is always informative.</p>
</div>
<div class="paragraph">
<p>A specification unit other than an example block is normative by default.
The following notation is used for informative units:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is an informative paragraph.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A single paragraph contains a single statement or multiple closely related or logically bound statements.
To help clarify the contents of a paragraph, it may contain a number of examples.</p>
</div>
<div class="paragraph">
<p>A paragraph may not contain the same statements worded differently.
In other words, a paragraph shall be written in the most unambiguous and shortest form.</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples"><a class="link" href="#_examples">5.2. Examples</a></h3>
<div class="paragraph">
<p>An example contained in a specification unit other than an example block is called an inline example and inherits the normative status of the unit.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>This example is informative.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>An example block must not be indexed.
Instead, it is considered related to the previous specification unit, or the containing section.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terms"><a class="link" href="#_terms">6. Terms</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Contents of a specification unit exist in the context of parent sections, recursively.
For example, the term "specification unit" is contained in the same section as the current paragraph, thus considered already known.</p>
</div>
<div class="paragraph">
<p>A term written in <em>italic</em> with an adjacent index has an explicit definition in either this or another document at the index location.
For example, the term <em>grapheme</em> <sup>[T1]</sup>  may be found at index T1 of this document.
The term <em>specification</em> <sup>[ISO 9000:2015 § 3.8.7]</sup>) should be looked up in the ISO document.
And this <em>term</em> <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> definition is to be found in the footnotes.</p>
</div>
<div class="sect2">
<h3 id="_syntax"><a class="link" href="#_syntax">6.1. Syntax</a></h3>
<div class="paragraph">
<p>Syntax definitions may contain semantic definitions in comments, but these semantic definitions are NOT normative, and are for convenience use only.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design"><a class="link" href="#_design">7. Design</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes design rationale of the Onyx language and accompanying standards.</p>
</div>
<div class="paragraph">
<p>Infer as much as possible, unless ambiguous.</p>
</div>
<div class="paragraph">
<p>Multiple syntaxes to achieve the same task is appropriate in some cases.</p>
</div>
<div class="paragraph">
<p>It is good to have full-character, short-character and symbolic representation of something so a developer could choose between readability and code size.
For example, <code>equals?</code>, <code>eq</code> and <code>==</code>.</p>
</div>
<div class="paragraph">
<p>The language is built on a finite set of simple rule blocks.
A lesser set is better.
For example, function and generic arguments follow the same semantics and syntax.</p>
</div>
<div class="sect2">
<h3 id="_annotations_vs_keywords"><a class="link" href="#_annotations_vs_keywords">7.1. Annotations VS keywords</a></h3>
<div class="paragraph">
<p>The less keywords are in the language, the better.</p>
</div>
<div class="paragraph">
<p>Reuse keywords as much as possible.</p>
</div>
<div class="paragraph">
<p>If an annotation is very often used, consider replacing it with a keyword.
However, low-level annotations should not be keywords.
For example, <code>@[Align]</code> and <code>@[Volatile]</code> are annotations and not variable modifiers.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_syntax_2"><a class="link" href="#_syntax_2">8. Syntax</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This specification uses <a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form">EBNF</a> for language and other syntax definition, unless mentioned another.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The entire compiled syntax can be found in <a href="#_compiled_syntax">Appendix A, <em>Compiled Syntax</em></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The specification extends EBNF with variables: a nonterminal may have a list of arguments prefixed with <code>$</code> with optional default values, wrapped in parentheses.
Once referenced within the nonterminal production rule, an argument is immediately replaced with its value.
Recursion and nested variables are allowed.
A nonterminal with arguments must always be used with parentheses, even if there are no actual arguments.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Using variables in EBNF syntax</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">foo($arg = "none") = "bar" | $arg;

a = foo();      (* Expands to `"bar" | "none";`)
b = foo("qux"); (* Expands to `"bar" | "qux";` *)
c = foo(b);     (* Expands to `"bar" | "bar" | "qux";` *)</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 1. Fundamental syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">binary = "0" | "1";
octal = binary | "2" | "3" | "4" | "5" | "6" | "7" | "8";
digit = octal | "8" | "9";

(* Design rationale: hexadecimals are in upper-case to clearly
  distingusigh them from exponents and prefixes (`Q` and `D`
  are exceptions). Multiplier prefixes can not be used in
  hexadecimal literals, so they don't mix. *)
hex = digit | "A" | "B" | "C" | "D" | "E" | "F";

(* Any Unicode abstract character, including
  those consisting of multiple codepoints. *)
unicode = (? A Unicode character ?);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_variables"><a class="link" href="#_variables">9. Variables</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A variable is a pointer to a region of memory containg a value.</p>
</div>
<div class="sect2">
<h3 id="_declaration"><a class="link" href="#_declaration">9.1. Declaration</a></h3>
<div class="paragraph">
<p>TODO: Declaring means setting an identifier and a type.
Defining is giving it a meaningful value.
Defining is done using the <code>:=</code> operator.</p>
</div>
<div class="paragraph">
<p>An Onyx variable always has an either impilcitly or explicitly defined storage.</p>
</div>
<div class="paragraph">
<p>Accessing an uninitialized variable is undefined behavior, hence unsafe.</p>
</div>
<div class="paragraph">
<p>It is possible to explicitly assign a variable to an <code>uninitialized T</code> value, where <code>T</code> is the variable type; such an assignment is unsafe.
Such an explicitly uninitialized variable would be considered safely initialized in the later code.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>let x = unsafe! uninitialized SInt32
# let x : SInt32 = unsafe! uninitialized # Ditto, the type is infered</p>
</div>
<div class="paragraph">
<p>puts(x) # OK from the point of a compiler view.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Prior to an access from a specialization, a variable must be explicitly declared.</p>
</div>
</div>
<div class="sect2">
<h3 id="_variable_storage"><a class="link" href="#_variable_storage">9.2. Variable storage</a></h3>
<div class="paragraph">
<p>A variable storage defines its location and lifetime boundaries.</p>
</div>
<div class="paragraph">
<p>There are three variable storage options: static, instance or local.</p>
</div>
<div class="paragraph">
<p>A variable declaration within a primitive, trait or enum requires an explicit <code>static</code> storage modifier.</p>
</div>
<div class="paragraph">
<p>Variables declared within a struct have implicit <code>instance</code> storage by default.
An explicit <code>instance</code> or <code>static</code> storage modifier can be specified for struct variables.</p>
</div>
</div>
<div class="sect2">
<h3 id="_static_variables"><a class="link" href="#_static_variables">9.3. Static variables</a></h3>
<div class="paragraph">
<p>A static variable lifetime spans to the lifetime of the containing process.
Therefore, a static variable is accessible at any point of the program execution.</p>
</div>
<div id="final-static-var-inline-assignment" class="paragraph">
<p>A final static variable must be both declared and assigned to in the same statement.</p>
</div>
<div id="final-static-const-var-readonly" class="paragraph">
<p>A final static variable containing a constant or scalar object may be placed into the read-only executable section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_instance_variables"><a class="link" href="#_instance_variables">9.4. Instance variables</a></h3>
<div class="paragraph">
<p>An instance variable exists in the state of a particular object instance.
All instance variables are finalized after the instance is finalized, in undefined order.</p>
</div>
<div id="final-instance-var-initialization" class="paragraph">
<p>A final instance variable must be defined at the moment of the containing object instance initialization.
Therefore, it must be defined either in the definition statement or in any initializer having access to the variable.</p>
</div>
<div class="paragraph">
<p>Only structs can contain instance variable declarations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_local_variables"><a class="link" href="#_local_variables">9.5. Local variables</a></h3>
<div class="paragraph">
<p>Local variables exist in the scope of a single function call.
Once the function returns, its local variables are finalized.</p>
</div>
<div id="final-local-var-separate-def" class="paragraph">
<p>A final local variable can have its definition separate from declaration.</p>
</div>
<div class="paragraph">
<p>Prior to read, a local variable must be explicitly defined.</p>
</div>
<div class="paragraph">
<p>Variables declared within functions have local storage by default.</p>
</div>
</div>
<div class="sect2">
<h3 id="_final_variables"><a class="link" href="#_final_variables">9.6. Final variables</a></h3>
<div class="paragraph">
<p>A final variable is declared using the <code>final</code> keyword.</p>
</div>
<div class="paragraph">
<p>A final variable can not be re-assigned to another object, but it can still contain a mutable, i.e. a partially changeable, object.</p>
</div>
<div class="paragraph">
<p>xcite:final-static-var-inline-assignment[]</p>
</div>
<div class="paragraph">
<p>xcite:final-static-const-var-readonly[]</p>
</div>
<div class="paragraph">
<p>xcite:final-instance-var-initialization[]</p>
</div>
<div class="paragraph">
<p>xcite:final-local-var-separate-def[]</p>
</div>
<div class="paragraph">
<p>A definition of a non-final static variable within a function is guaranteed to happen at most once per this variable specialization.</p>
</div>
</div>
<div class="sect2">
<h3 id="_non_final_variables"><a class="link" href="#_non_final_variables">9.7. Non-final variables</a></h3>

</div>
<div class="sect2">
<h3 id="_lifetime"><a class="link" href="#_lifetime">9.8. Lifetime</a></h3>
<div class="paragraph">
<p>Primitives and enums don&#8217;t have lifetime, but classes do.</p>
</div>
<div class="paragraph">
<p>In the end of their lifetime, a variable is finalized.</p>
</div>
<div class="sect3">
<h4 id="_moving_variables"><a class="link" href="#_moving_variables">9.8.1. Moving variables</a></h4>
<div class="paragraph">
<p>Only a <strong>local</strong> variable can be moved.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is hardly possible to detect use-after-move of a static or an instance variable, hence the restriction.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Only an lvalue can be moved.</p>
</div>
<div class="paragraph">
<p>A moved instance is an rvalue.</p>
</div>
<div class="paragraph">
<p>Moving a variable does not preserve previous its lifetime status: if disabled (for example, with <code>@setalive(var, false)</code>), it would be enabled again.</p>
</div>
<div class="paragraph">
<p>A moved variable is treated in the same way as an undefined one.
It is thus possible to define a previously moved variable again.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Moving variables</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">final a := Std::Twine("foo")
let b := unsafe! uninitialized Std::Twine

# If not disabling the lifetime, then `b` would be
# finalized  upon moving into it, which is dangerous
unsafe! @setalive(b, false)

b &lt;- a # Moving `a` into `b`; `b` could've been finalized here
# a # Panic! Use-after-move

unsafe! @setalive(b, true) # Make `b` alive again
assert(b.upcase == "FOO")

a := Std::Twine("bar") # Re-defining `a`

# This function accepts an instance
# rather than a pointer to one.
def foo(twine : Std::Twine);

foo(b)    # OK, would call a copy-initializer
foo(&lt;- b) # OK, move `b` instead of copying it
# b # Panic! Use-after-move</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It is not possible to move a varible into another local variable definition, as it is hardly practical.
Thus, there is only a copy-define operator <code>:=</code>, but no move-define.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. No move-defining</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">final a = Std::Twine("foo")
final b := a # OK, copy-define
# final c &lt;- a # Panic! `c` is not defined yet</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_assignment"><a class="link" href="#_assignment">9.9. Assignment</a></h3>
<div class="paragraph">
<p>An assignment to a variable is re-writing the memory region it is pointing to.</p>
</div>
<div class="paragraph">
<p>An assignment of a new value to a variable may be performed  by either copying the value or moving it, depending on the assignment operator.
The return value of an assignment operation itself may be either a copy of the new variable value or a moved instance of the old variable value, depending on the assignment operator.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top"><code>b</code> is&#8230;&#8203;</th>
<th class="tableblock halign-left valign-top"><code>r</code> is&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>final r := a = b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Copied</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <strong>copy</strong> of <code>a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;&lt;=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>final r := a &lt;&lt;= b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Copied</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Moved</strong> old instance of <code>a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;-</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>final r := a &lt;- b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Moved</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <strong>copy</strong> of <code>a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;&lt;-</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>final r := a &lt;&lt;- b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Moved</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Moved</strong> old instance of <code>a</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For consistency reasons, <code>&lt;=</code> would be a better choice for simple assignment instead of <code>=</code>.
But it is already taken by the "less than or equal" comparison operator, and <code>=</code> is preferable due to familiarity.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>&lt;&lt;</code> may be read as &#8220;push the old value from the variable&#8221;.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sval</code> (storage value): variables, dereferenced pointers</p>
</li>
<li>
<p><code>mval</code> (moved value): return values, <code>(&#8592; x)</code> results</p>
</li>
<li>
<p><code>rval</code> (right value (historical)): everything else</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">Allowed?</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sval = sval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes, implies copying</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x = shared</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sval = rval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes, implies moving</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x = Std::Shared(y)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sval = mval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes, implies moving</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x = copy(shared)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sval &lt;- sval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes, implies moving</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &lt;- shared</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sval &lt;- rval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes, implies moving (TODO: Do not allow?)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &#8592; 42</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sval &lt;- mval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes, implies moving (TODO: Do not allow?)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &#8592; (&#8592; 42)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A pair of defined variables of any storage can be swapped using the swap operator <code>&lt;-&gt;</code>.
Swapping implies simulatenous moving of variable values into each other, thus it does neither copy nor finalize nor lead to use-after-move behavior.
The return value of a swap operation itself is a copy of a new value of the left operand.</p>
</div>
<div class="paragraph">
<p>TODO: Taking an address of an undefined variable is unsafe.
It returns a pointer with defined storage, though.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Swapping variables</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">let a := 1
let b := 2

let new_a := a &lt;-&gt; b

assert(new_a == a == 2)
assert(b == 1)</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">(*
  A variable declaration. In different contexts, optional items
  may become mandatory; for example, a final static variable
  must have its definition in-line.
*)
var_decl =
  (* In most cases, it's implicitly `def` *)
  ["def" | "decl" | "impl"],

  (* A mandatory accessibility modifier *)
  ("final" | "let" | "get" | "set"),

  (* An optional storage modifier, otherwise infered *)
  ["static" | "instance" | "local" | "undefstor"],

  (* An optional `var` keyword *)
  ["var"],

  (* A mandatory variable identifier *)
  id,

  (* An optional type restriction, otherwise infered *)
  [":" | "~", type_expr],

  (* An optional inline definition of the variable *)
  ["=", expr];</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: <code>let x, y : T === let x : T, y : T; let x : ?, y : T === let x : Undef, y : T</code> VS. <code>let x, y : T === let x : Undef, y : T</code>.</p>
</div>
<div class="paragraph">
<p>TODO: final uninitialized variables MUST not be placed in read-only memory, thus unsafe initialization of them is possible.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_functions"><a class="link" href="#_functions">10. Functions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Can not user-declare non-operators ending with <code>=</code> (e.g. <code>name=</code> is invalid).</p>
</div>
<div class="sect2">
<h3 id="_declaration_2"><a class="link" href="#_declaration_2">10.1. Declaration</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">closure_arg_decl = (* TODO: *);

(* A closure declaration may be explicitly empty (e.g. `[]`). *)
closure_decl =
  "[",
  [closure_arg_decl, {",", closure_arg_decl}, [","]],
  "]";

(*
  ```
  ~&gt; || body # Any closure, types infered
  ~&gt; |[]| body # Explicitly empty closure
  ~&gt; |[C] A : R|
  ```
*)

block_restriction = "=&gt;", [block_proto];

type_restriction = WS, (":" | "~"), WS, type_expr;

(*
  For declarations, at least either identifier or restriction
  must be specified, whereas aliasing is not possible.

  For implementations, at least either of three must be specified.
*)
arg_decl =
  (* Optional alias, unapplicable to function declarations *)
  [id, NB, ":"],

  (* An optional argument identifier *)
  [id],

  (* An optional argument restriction *)
  [type_restriction | block_restriction];

(*
  An named argument declaration with restriciton.
  If type of the restriction is omitted, it is assumed to be concrete.
  So that, `(arg: T)` == `(arg: : T)` != `(arg: ~ T)` == `(arg ~ T)`.
*)
arg_decl =
  [id, NB, ":"], (* Optional argument alias *)
  [var_decl], (* Optional argument variable declaration *)
  [":" | "~"], id;

(*
  An anonymous argument declaration
  with restriction, e.g. `(: T)` != `(~ T)`.
*)
arg_decl = (":" | "~"), id;

fun_decl = "decl", id, "(", {arg_decl}, ")";</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_storage"><a class="link" href="#_storage">10.2. Storage</a></h3>
<div class="paragraph">
<p>Function storage may be <code>static</code>, <code>instance</code> or <code>undefstor</code>.
The latter is only applicable to function declarations with traits.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mutability"><a class="link" href="#_mutability">10.3. Mutability</a></h3>
<div class="paragraph">
<p>Function mutability may be <code>mut</code>, <code>const</code> or <code>undefmut</code>.
The latter is only applicable to function declarations with traits.</p>
</div>
</div>
<div class="sect2">
<h3 id="_manipulating_definitions"><a class="link" href="#_manipulating_definitions">10.4. Manipulating definitions</a></h3>
<div class="sect3">
<h4 id="_unimplementation"><a class="link" href="#_unimplementation">10.4.1. Unimplementation</a></h4>
<div class="paragraph">
<p>An implementation may be fully or partially erased using an <code>unimpl</code> clause.</p>
</div>
<div class="paragraph">
<p>Only an existing implementation may be unimplemented.</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Unimplementing</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">def foo(x ~ Int);

# unimpl foo(x ~ FBin) # Panic! Can not find matching implementation

unimpl foo(x : SInt32) # OK, now we don't have an implementation
                       # for this particular type
# foo(42)              # Panic!
foo(42i16)             # OK

unimpl foo(x ~ SInt) # OK, now we only have implementation for `UInt`
# unimpl foo(x ~ SInt32) # Panic! Can not find matching implementation

foo(42) # OK
# foo(-1) # Panic! Can not find overload for `foo(x : SInt32)`</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_reimplementation"><a class="link" href="#_reimplementation">10.4.2. Reimplementation</a></h4>

</div>
</div>
<div class="sect2">
<h3 id="_generators"><a class="link" href="#_generators">10.5. Generators</a></h3>
<div class="paragraph">
<p>Generator is like macro, but bound to specific instance.</p>
</div>
<div class="paragraph">
<p>A function accepting a block argument is called a generator function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx"># `=&gt;` is a special "block restriction"
decl foo(=&gt;) # An anonymous block arg

# If block arity &gt; 1, requires all block args to be named
decl bar(success: =&gt;, failure: =&gt;) # Named block args

# Having a label in argument declaration
# always expects it to be a block label.
impl foo(%block: =&gt;) { %block(42) }
# foo(block: =&gt; { }) # Panic! Declaration prohibits named argument
foo(=&gt; { }) # OK

# Aliasing
impl foo(block: %blk =&gt;) { %blk(42) }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_returning"><a class="link" href="#_returning">10.6. Returning</a></h3>
<div class="paragraph">
<p>A returned value is always moved.</p>
</div>
<div class="paragraph">
<p>Variants are treated specially.
If returned value <em>r</em> is rval or mval, then <code>return r</code> is a shortcut to <code>T?(r)</code>.
If returned value <em>r</em> is sval, then <code>return r</code> is a shorcut to <code>T?(&lt;- r)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">@[Trivial]
class Klass
end

def foo : Klass
  final klass := Klass()
  return klass # Directly returned, thus implicitly moved
  # return Klass() # Ditto
end

def bar : Klass?
  if @rand?
    final klass := Klass()
    return klass # Shortcut to `.(&lt;- klass)`
    # return Klass() # Ditto
  else
    return void # Shortcut to `.(void)`
  end

  # An absence of `return` is implicitly `return void`
end

def baz : (Klass, Klass)
  final klass := Klass()

  # Can not imply moving in a
  # non-directly returned expression,
  # thus by default `klass` is copied
  return (klass, &lt;- klass)
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: Hidden (non-public) functions should be treated as public.
For example, it may be better to mark them <code>unsafe</code> rather then wrap their bodies in <code>unsafe!</code>.</p>
</div>
<div class="paragraph">
<p>TODO: Can overload: visibility, storage, mutability.
Can not: safety, throwing-ness, purity.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pure_functions"><a class="link" href="#_pure_functions">10.7. Pure functions</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section is to be discussed yet.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Only a function can be pure, neither generator nor proc.</p>
</div>
<div class="paragraph">
<p>A function can be marked as pure using the <code>pure</code> modifier.
Without that modifier, a function is implicitly <code>impure</code>, even if a compiler can prove it is pure.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A pure function does not have side effects:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>It only writes to local storage;</p>
</li>
<li>
<p>It does not call impure functions.</p>
</li>
</ol>
</div>
</li>
<li>
<p>A pure function only reads from caller, local or temporal storages.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If any of the statements above is false for a function marked <code>pure</code>, a compiler panics.</p>
</div>
<div class="paragraph">
<p>A pure function can be throwing: modifying a backtrace is not considered a side-effect.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Pure functions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">pure def sum([]: a, []: b)
  return a + b
end

def global_add([]: a)
  static let global = 42
  return global + a # Reading from static storage, thus impure
end</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_safety"><a class="link" href="#_safety">11. Safety</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are three levels of runtime safety in descending order, namely <code>threadsafe</code>, <code>fragile</code> and <code>unsafe</code>.</p>
</div>
<div class="paragraph">
<p>The following operations are <code>threadsafe</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Calling a method with at least <code>fragile</code> safety modifier on a value with local storage.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following operations are <code>unsafe</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Coercion, unless special conditions are met;</p>
</li>
<li>
<p>Some of pointer operations, depending on its storage.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All other operations are <code>fragile</code> by default.</p>
</div>
<div class="sect2">
<h3 id="_safety_statements"><a class="link" href="#_safety_statements">11.1. Safety statements</a></h3>
<div class="paragraph">
<p>A program shall not invoke a lesser-safe code from a higher safety environment.
Instead, a lower safety statement shall be used to wrap the lesser-safe code.</p>
</div>
<div class="listingblock">
<div class="title">Listing 2. Safety statements</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">fragile_statement =
  "fragile!",
  expr | block();

unsafe_statement =
  "unsafe!",
  expr | block();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A safety statement itself becomes of the specified safety level.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Safety statements transfer the safety responsibilities from the compiler to a developer.
It is easy then to debug the program by grepping source files with <code>unsafe!</code> and <code>fragile!</code> patterns.</p>
</div>
<div class="paragraph">
<p>For example, calling an <code>unsafe</code> function from a <code>fragile</code> context would require wrapping the call into an <code>unsafe!</code> statement like so: <code>unsafe! foo()</code>.
Here, a developer explicitly stated that they are fully responsible for consequences caused by calling <code>foo</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_safety_modifiers"><a class="link" href="#_safety_modifiers">11.2. Safety modifiers</a></h3>
<div class="paragraph">
<p>There are <code>threadsafe</code>, <code>fragile</code>, <code>unsafe</code> and <code>undefsafe</code> safety modifiers.
An <code>undefsafe</code> safety modifier implies that the modified entity has undefined safety.
A type, function or macro declaration has a safety modifier.</p>
</div>
<div class="listingblock">
<div class="title">Listing 3. Safety modifiers</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">safety_modifier =
  "threadsafe" |
  "fragile" |
  "unsafe" |
  "undefsafe";</code></pre>
</div>
</div>
<div class="paragraph">
<p>The global namespace implicitly has the <code>fragile</code> safety modifier.</p>
</div>
<div class="paragraph">
<p>Declarations other than macro declarations implicitly inherit the containing declaration safety modifier unless overriden.
A macro declaration always has an implicit <code>undefsafe</code> safety modifier unless overriden.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For example, a <code>struct Foo</code> declared in the top-level namespace would be implicitly <code>fragile struct Foo</code>.</p>
</div>
<div class="paragraph">
<p>Similarly, an instance method declared in a <code>threadsafe struct Bar</code> would be implicitly <code>def threadsafe foo</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A trait function declaration with undefined storage has the <code>undefsafe</code> safety modifier unless explicitly overriden.
A <code>derive</code> statement inherits the containing declaration safety modifier unless explicitly overriden.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">trait Foo
  # Implicitly `undefstor undefsafe`.
  decl foo : Void
end

struct Bar
  derive Foo
    # Implicitly `instance fragile`.
    impl foo;
  end

  threadsafe derive Foo
    # Implicitly `instance threadsafe`.
    impl foo;
  end
end</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_types"><a class="link" href="#_types">12. Types</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A type is a fundamental qualia of a entity determining its characteristics.</p>
</div>
<div class="openblock info">
<div class="content">
<div class="paragraph">
<p>The definition of <em>type</em> given by Wikipedia:</p>
</div>
<div class="quoteblock">
<blockquote>
[&#8230;&#8203;], a <strong>data type</strong> or simply <strong>type</strong> is an attribute of data which tells the compiler or interpreter how the programmer intends to use the data.
</blockquote>
<div class="attribution">
&#8212; Wikipedia contributors<br>
<cite><a href="https://en.wikipedia.org/wiki/Data_type">Data Type</a> at July 20, 2020</cite>
</div>
</div>
<div class="paragraph">
<p>is different from that used in this document.
Instead, this document has the aforementioned specialized <em>data type</em> definition, which aligns closely with the Wikipedia&#8217;s.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>A type is uniquely identified with a fully-qualified identifier.</p>
</div>
<div class="paragraph">
<div class="title">Type kinds</div>
<p>A type is either a <em>namespace</em>, <em>trait</em>, <em>unit</em>, <em>enum</em>, <em>struct</em>, <em>class</em> or an <em>annotation</em>; this classification is known as the <em>type kind</em>.
A type kind is a keyword.</p>
</div>
<div class="paragraph">
<div class="title">Data types</div>
<p>A <em>data type</em> may have <em>instances</em> of that type known as <em>objects</em> which are deemed to physically exist in the space-time continuum, including stack memory, processing unit registers or sections within an executable file.
info:[In practice, an object existence may be elided during translation for optimization purposes.
Also, an object may be present in superposition, e.g. a quantum bit, which is not clearly a definition of existence.
However, a human always considers an object existing somewhere and sometime.]
Enum, struct and class types are considered data types.</p>
</div>
<div class="paragraph">
<p>TODO: A struct type may be named or anonymous.
Anonymous struct also allow method declarations with reopening.</p>
</div>
<div class="paragraph">
<p>TODO: A class type has optional mutability.
Read more in classes.</p>
</div>
<div class="paragraph">
<p>TODO: Entity declaration, implementation and definition.</p>
</div>
<div class="paragraph">
<p>A namespace, trait or unit type shall not be declared, but defined only.
info:[An implementation statement requires a prior declaration statement, therefore these types can not be implemented either.
The design decision is driven by the fact that these types do not have runtime state to be finalized.
The annotation type kind is not included in that list because it may actually be defined with hooks.]</p>
</div>
<div class="sect2">
<h3 id="_members"><a class="link" href="#_members">12.1. Members</a></h3>
<div class="paragraph">
<p>A type contains zero or more <em>members</em>.
A member may be a function, value, macro, or a type.
This classification is known as <em>member kind</em>.</p>
</div>
<div class="openblock info">
<div class="content">
<div class="paragraph">
<p>Every type is a name-space in sense of that it can have members declared.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 4. Member reference syntax</div>
<div class="content">
<pre>value = "variable" | "constant"; (* TODO: Move away *)
member_storage = "instance" | "static";
member_kind = "function" | "value" | value | "macro" | "type";
member = [member_storage], member_kind, "member";</pre>
</div>
</div>
<div class="paragraph">
<p>Any type may contain type and macro members.</p>
</div>
<div class="paragraph">
<div class="title">Member storage</div>
<p>A function or value member has <em>storage</em>.
The storage is either static or instance.
A static member has lifetime aligned with the program execution.
An instance member lifetime spans to the object&#8217;s.
In a data or trait type, the storage is instance by default, and can be altered with a storage modifier.
Only struct and class types may contain instance value members.
In a enum type, a value member declaration shall explicitly contain the static storage modifier.
In a namespace, annotation, or a unit type, a member storage is always implicitly static and can not be altered.</p>
</div>
</div>
<div class="sect2">
<h3 id="_generic_types"><a class="link" href="#_generic_types">12.2. Generic types</a></h3>
<div class="paragraph">
<p>A <em>generic type</em> is a type containing at least one generic argument declaration.</p>
</div>
<div class="paragraph">
<p>A generic argument is accessible from within the generic type scope.
info:[A generic argument is not accessible from type members nested in the generic type.]</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">struct Foo&lt;T&gt;
  struct Bar
    let x : T # Panic! `T` is not declared in `Bar`

  struct Bar&lt;T&gt;
    let x : T # OK, but distinct from `Foo`'s `T`</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Upon identifier qualification, a generic argument has higher precedence over the outer scope.</p>
</div>
<div class="openblock info">
<div class="content">
<div class="paragraph">
<p>By convention, generic argument identifiers consist of the smallest reasonable number of uppercase Latin letters, e.g. <code>Array&lt;T&gt;</code> or <code>Encoding&lt;BitSize: BZ, CodeunitSize: CZ&gt;</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>A generic argument may be queried from a generic type using the <code>t::&lt;name&gt;</code> accessor, where <code>name</code> is the name (or alias, with higher precedence) of the argument.
info:[Because of that, <code>&lt;&gt;</code> is in the list <a href="#TODO:">restricted names</a> for a user function declaration.]</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Querying a generic argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">decl struct Array&lt;Type: T, Size: S&gt;;
@assert(Array&lt;SInt32&gt;::&lt;Type&gt; == SInt32)

final ary = FBin64[3](1, 2, 3)
@assert(ary::&lt;Size&gt; == 3)

# Also works for variants!
final var = Std@rand(%i[1 2 3], %f[1 2 3 4])
# @assert(var::&lt;Size&gt; == 3) # Would work in 50% of cases</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_type_specialization"><a class="link" href="#_type_specialization">12.3. Type specialization</a></h3>
<div class="paragraph">
<p>A <em>type specialization</em> is the process of establishing a distinct type with a unique generic arguments combination from a type definition for the first time when a compiler determines that there is a possibility for either an object or a type instance of the type to exist in runtime.
info:[Simply referencing a type, for example from within a <code>reopen</code> statement or restriction, does not trigger type specialization.
For the specialization to be triggered, there shall be a possibility of that the type would actually exist in runtime as an object or type instance.]
A non-generic type is considered to have zero generic arity, which is a unique combination; therefore a non-generic type specializes at most once.</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Type specialization</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">struct Foo&lt;T&gt;
  val x : T
  \{% print "Spec'd with " .. nx.scope.T:dump() %}
end

let f1 = Foo&lt;SInt32&gt;() # =&gt; Spec'd with SInt32
let f2 = Foo&lt;SInt32&gt;() # =&gt; (already spec'd)
let f3 = Foo&lt;FBin64&gt;() # =&gt; Spec'd with FBin64
# let f4 = Foo&lt;Real&gt;() # Panic! Field `Foo:x : Real` has incomplete type

decl bar(foo: Foo&lt;FBin32&gt;) # Do not specialize, it's just a reference

let f5 = \Foo&lt;FBin32&gt; # =&gt; Spec'd with FBin32</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Type specialization is recursive; that is, if a type \$T\$ containing a field of type \$U\$ specializes, \$U\$ also specializes during \$T\$'s specialization.</p>
</div>
<div class="paragraph">
<p>A type specialization triggers specialization of each trait from its traits set, in the same order as in the set.</p>
</div>
<div id="spec-of-child-type-triggers-parent" class="paragraph">
<p>A specialization of a <a href="#_type_inheritance">child</a> type triggers specialization of its parent.</p>
</div>
<div class="paragraph">
<div class="title">Delayed macros</div>
<p>ditto:[Delayed macro calls and blocks] written directly within a type declaration body are evaluated on every containing type specialization.
ditto:[] within a trait type declaration are copied into every deriving non-trait type.</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Delayed macro evaluation during specialization</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">trait Container&lt;Type: T&gt;
  \{%
    -- This macro block would evaluate on every deriving type
    -- specialization, unique per deriving type.
    print "Spec'd"

    -- Would only declare if `T` is of `Int`
    if nx.scope.T.type &lt; nx.lookup("Int") then
  %}
    # Return a sum of all of
    # the container's elements.
    decl sum() : T
  \{% end %}
end

decl struct Array&lt;Type: T, Size: S ~ %z&gt;
  derive Container&lt;T&gt;
end

decl struct List&lt;Type: T&gt;
  derive Container&lt;T&gt;
end

final ary = Array&lt;SInt32, 3&gt;(1, 2, 3) # =&gt; Spec'd
final list1 = List&lt;SInt32&gt;()          # =&gt; Spec'd
final list2 = List&lt;SInt32&gt;()          # =&gt; (already spec'ed)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_type_completeness"><a class="link" href="#_type_completeness">12.4. Type completeness</a></h3>
<div class="paragraph">
<p>A <em>complete type</em> is a data type specialization with defined size of occupied space, or a unit type specialization.
Only a complete type can be used as a value type in runtime.</p>
</div>
<div class="paragraph">
<p>An <em>incomplete type</em> is a namespace type, annotation type, or a data type specialization with undefined size.
A data type specialization is deemed to be incomplete if it contains a field of an incomplete type.
info:[A complete type may have an incomplete generic argument, e.g. <code>Pointer&lt;SInt&gt;</code>.
What matters is the runtime representation of a data type; if a data type does not contain fields of incomplete types, it is complete.]
info:[For Core primitives, there are rules for every primitive regarding on how to infer its completeness.]</p>
</div>
<div class="openblock proposal">
<div class="title">Incompleteness modifier</div>
<div class="content">
<div class="paragraph">
<p>It may be possible to define structs, classes and enums with <code>incompl</code> modifier, which makes the type incomplete and disallows to use it in runtime unless reopened with <code>compl</code> modifier.
The <code>compl</code> modifier is default for definitions and reopenings then.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_type_inheritance"><a class="link" href="#_type_inheritance">12.5. Type inheritance</a></h3>
<div class="paragraph">
<p>TODO: Classes can extend classes and structs; structs can extend structs only.</p>
</div>
<div class="paragraph">
<p>TODO: Shall only extend a defined type, so we know its layout.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reopening"><a class="link" href="#_reopening">12.6. Reopening</a></h3>
<div class="paragraph">
<p>A type may be reopened using the <code>reopen</code> statement.</p>
</div>
<div class="paragraph">
<p><code>reopen Foo&lt;T&gt; forall T</code> is similar to <code>decl Foo&lt;T&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Can reopen Variants, Unions, anonymous structs, tuples, enums, primitives.</p>
</div>
<div class="listingblock">
<div class="title">Listing 5. The <code>reopen</code> statement syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">(* TODO: Move. *)
compl_mod =
  (* !keyword(mod) *) "compl" |
  (* !keyword(mod) *) "incompl";

reopen_statement =
  [compl_mod],

  (* !keyword(statement) *)
  "reopen",

  type_ref,
  ";" | block();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>reopen</code> statement block semantics is similar to the declaration block semantics of the reopened type.</p>
</div>
<div class="paragraph">
<p>It is not possible to implement fields within a reopen statement.</p>
</div>
<div class="paragraph">
<p>It is a error to try reopening a non-existing type declaration.</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Reopening a type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">decl struct Foo&lt;T&gt; forall T ~ Int
  let x : T
  \{% print "Specialized the " .. nx.scope.T:dump() %}
end

# reopen Foo&lt;T: FBin64&gt;; # Panic! `Foo&lt;T&gt;` istype
reopen Foo&lt;SInt32&gt;;
# =&gt; Specialized a SInt
# =&gt; Specialized the SInt32</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Type expressions may also be reopened.
info:[This gives a powerful and flexible mechanism for declaring members on trait sums, for example.]</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Reopening type expressions</div>
<div class="content">
<div class="paragraph">
<p>Given these traits and struct:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">trait Drawable
  decl draw(Canvas)
end

trait Colorized
  decl color : UInt8
  decl color=(UInt8)
end

struct Line
  &lt;~ Drawable, Colorized

  let color : UInt8

  # impl ~Drawable.draw
  impl draw(canvas)
    # Draw without considering the color
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>One option would be to reopen the traits sum with another-named method declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">reopen (Drawable &amp;&amp; Colorized)
  decl draw_colorized(Canvas)
end

reopen struct Line
  # impl ~(Drawable &amp;&amp; Colorized).draw_colorized(canvas)
  impl draw_colorized(canvas)
    # Draw with color!
  end
end

final line = Line()

# W/ color
line~(Drawable &amp;&amp; Colorized).draw_colorized(canvas)
line.draw_colorized(canvas)

# W/o color
line~Drawable.draw(canvas)
line.draw(canvas)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option would be to reopen the sum with the same-named method declaration.
But this would require solving the arising collision problem in the struct.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">reopen (Drawable &amp;&amp; Colorized)
  decl draw(Canvas)
end

reopen struct Line
  impl ~(Drawable &amp;&amp; Colorized).draw(canvas) as draw_colorized
    # Draw with color!
  end
end

final line = Line()

# W/ color
line~(Drawable &amp;&amp; Colorized).draw(canvas)
line.draw_colorized(canvas)

# W/o color
line~(Drawable).draw(colorized)
line.draw(canvas)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reopening may also happen right within a type; it shall be then referenced with <code>self</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">reopen Drawable
  reopen (self &amp;&amp; Colorized)
    # Draw colorized.
    #
    # NOTE: It's not a part of `Drawable`,
    # but rather of `Drawable &amp;&amp; Colorized`,
    # hence no collision if deriving `Drawable` only.
    decl draw(Canvas)
  end
end

# The semantics is similar to the
# second option mentioned above.
line~(Drawable &amp;&amp; Colorized).draw(canvas)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The in-type reopening comes in particularly useful when dealing with generic arguments and namespaced types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">trait Container::Indexable&lt;K, V&gt;
  reopen (self &amp;&amp; Enumerable&lt;V&gt;)
    decl each(-&gt; |(index: K, value: V)|)
  end
end

# An alternative would be (quite wordy):
#

reopen (
  Container::Indexable&lt;K, V&gt; &amp;&amp;
  Container::Enumerable&lt;V&gt;
) forall K, V
  decl each(-&gt; |(index: K, value: V)|)
end</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refining"><a class="link" href="#_refining">12.7. Refining</a></h3>
<div class="paragraph">
<p>TODO: <code>using refinement</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_restriction"><a class="link" href="#_restriction">12.8. Restriction</a></h3>
<div class="paragraph">
<p>Behavioural bias is applied whenever a compiler can prove it.
In every scope, a type restriction invests into the bias.
The bias is reduced outside of the context.
The bias does not exist in runtime.</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. Behavioural bias</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx"># In this example, `Drawable` is root trait for both `Drawable2D` and
# `Drawable3D`, causing name collision in a type deriving from both,
# because if we bias `point` to `Drawable` and call `draw` on it,
# which dimension-draw call would it be?
#
# A) Can not bias to `Drawable`, only `p~Drawable2D~Drawable`.

# Abstract traits, which are not deriveable directly?
indirect trait Drawable
  decl draw
end

trait Drawable2D &lt;~ Drawable
end

trait Drawable3D &lt;~ Drawable
end

struct Point
  derive Drawable2D
    impl ~draw as draw2d
  &lt;~ Drawable3D

  impl ~Drawable2D.draw as draw2d;
  impl ~Drawable3D.draw as draw3d;

  def do_pointy_stuff;
end

# The argument is required to derive from `Drawable2D`.
# def draw2d(x : T) forall T ~ Drawable2D # Ditto (need e.g. for `sum`)
# def draw2d(x : T) forall T where T &lt;~ Drawable2D # Ditto, allows more complex expressions
# TODO: Have formal algorithm for that.
def draw2d(x ~ Drawable2D)
  \{%
    # `x` is biased to `Drawable2D` only
    nx.assert(nx.scope.x.type.bias ==
      nx.typexpr("Drawable2D"))
  %}

  x.draw() # OK, equivalent to `x~Drawable2D`
end

# An argument is required to derive from at
# least one trait deriving from `Drawable`.
def draw(x ~ Drawable)
  \{%
    # `x` is biased to `Drawable`
    nx.assert(nx.scope.x.type.bias ==
      nx.typexpr("Drawable"))
  %}

  # x.draw() # Panic! `~Drawable.draw()` is indirect declaration

  if x ~? Drawable2D
    # It may also derive from any other `Drawable`,
    # but here we're biased to `Drawable2D` only
    # an do not care about other possible traits.
    #

    \{%
      # `x` is biased to `Drawable2D`
      nx.assert(nx.scope.x.type.bias ==
        nx.typexpr("Drawable2D"))
    %}

    x.draw() # OK, eq. to `x~Drawable2D.draw()`
  end
end</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_float"><a class="link" href="#_float">12.9. Float</a></h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In computing, floating-point arithmetic (FP) is arithmetic using formulaic representation of real numbers as an approximation to support a trade-off between range and precision.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Wikipedia
</div>
</div>
<div class="paragraph">
<p>A particular built-in <code>Float</code> type specialization maps to a valid IEEE 754-2008 (further referenced as <em>IEEE 754</em>) floating-point interchange format.</p>
</div>
<div class="paragraph">
<p>A <code>Float</code> specialization representation in memory is defined in accordance to IEEE 754.</p>
</div>
<div class="paragraph">
<p>An implementation must implement five basic <code>Float</code> specializations in accordance to basic formats specified by IEEE 754, either natively or in software.</p>
</div>
<div class="paragraph">
<p>In addition to that, two non-basic specializations are declared, but are optional to implement.</p>
</div>
<table id="float-basic-formats" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Basic <code>Float</code> specializations</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">IEEE 754 format</th>
<th class="tableblock halign-left valign-top">Bitsize</th>
<th class="tableblock halign-left valign-top">Alias</th>
<th class="tableblock halign-left valign-top"><code>Float</code> specialization</th>
<th class="tableblock halign-left valign-top">Is basic?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>binary16</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin16</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Float&lt;2, 11, 15&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>binary32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Float&lt;2, 24, 127&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>binary64</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin64</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Float&lt;2, 53, 1023&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>binary128</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin128</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Float&lt;2, 113, 16383&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>decimal32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FDec32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Float&lt;10, 7, 96&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>decimal64</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FDec64</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Float&lt;10, 16, 384&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>decimal128</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FDec128</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Float&lt;10, 32, 6144&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If a target natively supports an IEEE 754 format, then the type under the ISA namespace must alias to the according <code>Float</code> specialization, for example <code>alias SPARC::FQuad = FBin128</code>.</p>
</div>
<div class="paragraph">
<p>If a target natively supports a non-basic format (even with a limited operations set), an Onyx compiler implementation must implement that format.
For example, the <code>binary16</code> format is not basic, but often implemented, including some ARM and NVPTX targets; the <code>FBin16</code> specialization must be implemented for such targets.</p>
</div>
<div class="paragraph">
<p>If a target natively supports an extended precision format, then it must be defined by the implementation.
The naming convention for an extended precision format alias is <code>F{Base}E</code>, where <code>{Base}</code> is the extended basic format, for example <code>FBin64E</code>.
For example, on x87 a target, the extended precision floating point format may be aliased as  <code>alias X87::Float80 = FBin64E = Float&lt;2, 64, 16383&gt;</code>, and the <code>Float&lt;2, 64, 16383&gt;</code> specialization would map natively to that format.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The C18 § F.2 standard states the following:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The <code>long double</code> type matches an IEC 60559[:1989] extended format, else a non-IEC 60559 extended format, else the IEC 60559 double format.</p>
</div>
<div class="paragraph">
<p>[&#8230;&#8203;]</p>
</div>
<div class="paragraph">
<p>"Extended" is IEC 60559’s double-extended data format.
Extended refers to both the common 80-bit and quadruple 128-bit IEC 60559 formats.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Therefore, <code>long double</code> in C does not neccessarily maps to <code>FBin64E</code>.
Instead, it may map to <code>FBin128</code>.
An implementation (and a user) should keep that in mind upon providing a C-Onyx floating type mapping.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An implementation must provide a way to specify mapping from three C floating-point types <code>float</code>, <code>double</code> and <code>long double</code> to Onyx types, for particular target, prior to compilation.
However, an explicit coercion or conversion is still required to interoperate with C types.
The mapping defines according <code>as</code> methods, for example <code>float &lt;&#8658; FBin32</code> mapping defines <code>$float.as(FBin32)</code> and <code>FBin32.as($float)</code> methods.</p>
</div>
<div class="paragraph">
<p>An implementation should provide a pre-defined default mapping from C floating-point types to Onyx types for every target it supports.</p>
</div>
<div class="paragraph">
<p>If a target type has the same arithmetic format as an IEEE 754 format, then it must be aliased to an according <code>Float</code> specialization.
Otherwise, it may be mapped to an extended-precision floating-point as dictated by IEEE 754, iff it matches the extended-precision format requirements; x87 conforms this requirement, for example <code>alias FBin64E = Float&lt;2, 64, 15&gt; = X87::Float80</code>.
Implementations not conforming to IEEE 754 must not be mapped to a <code>Float</code> specialization; for example, PowerPC extended precision type does not conform to IEEE 754, as it&#8217;s merely a software emulation. Thus, no mapping must exist, even for <code>FBin64E</code>.</p>
</div>
<div class="paragraph">
<p>A particular <code>Float</code> specialization implementation may be ensured during compilation using the <code>@@impl?</code> built-in compiler intrinsic and the <code>nx.Node:is_implemented</code> macro method, for example <code>if @@impl?(FBin16)</code> or <code>{% if nx.lkp("FBin16").is_implemented %}</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixed_point_numbers"><a class="link" href="#_fixed_point_numbers">12.10. Fixed-point numbers</a></h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In computing, a fixed-point number representation is a real data type for a number that has a fixed number of digits after (and sometimes also before) the radix point (after the decimal point '.' in English decimal notation).</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>A fixed-point number is defined by its natural base \$b\$ (either binary or decimal), natural integral part size \$i\$ (in the base), and integer fractional part size \$f\$ (in the base).
For example, the number \$-3.625\$ may be encoded exactly as <code>-0b11.101Q8f4 : XBin&lt;Integral: 3, Fractional: 4&gt;</code>.</p>
</div>
<div class="paragraph">
<p>\$f &lt;= 0 =&gt; i &gt; 0\$.</p>
</div>
<div class="paragraph">
<p>A fixed-point number is always signed.</p>
</div>
<div class="paragraph">
<p>A negative value of \$f\$ implies absence of the fractional part in the fixed-point number, and a power in the number&#8217;s base equal to the absolute value of \$f\$ is applied to the fixed-point number value.
A negative \$f\$ does not contribute to the resulting bitsize of a fixed-point number.
For example, <code>-25kD5f-3 : XDec&lt;Integral: 2, Fractional: -3&gt;</code> is read as \$-25 xx 10^3\$, but internally comprised of only two digits <code>25</code> and a sign bit, thus occupying exactly 8 bits.</p>
</div>
<div class="paragraph">
<p>An implementation is required to implement an arbitrary-sized fixed-point number in any of the defined bases with a reazonable maximum bitsize limit.</p>
</div>
<div class="listingblock">
<div class="title">Listing 6. Fixed Core API</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">require "./fractional.nx"

# A fixed-point number.
decl primitive Fixed&lt;
  Base: 2 || 10,

  # Size of the integral part in `Base`.
  Integral: ~%Natural = 0,

  # Size of the fractional part in `Base`.
  # May be negative for right-shift.
  Fractional: ~%Integer = 0
&gt;
end

alias XBin&lt;*&gt; = Fixed&lt;2, *&gt;
alias XDec&lt;*&gt; = Fixed&lt;10, *&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_binary_fixed_point_number_encoding"><a class="link" href="#_binary_fixed_point_number_encoding">12.10.1. Binary fixed-point number encoding</a></h4>
<div class="paragraph">
<p>In a binary fixed-point number, \$f\$ defines the amount of bits the represented value is shifted <strong>left</strong> by.
If \$f &lt; 0\$, then the value is shifted <strong>right</strong> instead.</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Binary fixed-point numbers</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">@[Entry]
export void main() {
  let q = 96Q8f-4 : XBin&lt;Integer: 7, Fraction: -4&gt;

  assert(q == 0b00000110 &lt;&lt; 4)
  assert(q == 0b01100000)
  assert(q == 96)
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_decimal_fixed_point_number_encoding"><a class="link" href="#_decimal_fixed_point_number_encoding">12.10.2. Decimal fixed-point number encoding</a></h4>
<div class="paragraph">
<p>\${(f &gt;= 0 =&gt; a = i + f), (f &lt; 0 =&gt; a = i):}\$, where \$a\$ is the total amount of digits in a decimal fixed-point number.</p>
</div>
<div class="paragraph">
<p>Digits in a decimal fixed-point number are encoded using the <a href="https://en.wikipedia.org/wiki/Densely_packed_decimal">Densely Packed Decimal encoding</a>.
An additional bit is occupied by the sign.</p>
</div>
<div class="listingblock">
<div class="title">Listing 7. Decimal fixed-point number encoding scheme</div>
<div class="content">
<pre>Failed to generate image: Could not find the 'bytefield-svg' executable in PATH; add it to the PATH or specify its location using the 'bytefield-svg' document attribute
(def boxes-per-row 8)
(def row-labels ["0", "1", "2", "3", "4", "5", "6", "7", "8"])
(draw-column-headers)
(draw-box "Sign" [:box-first])
(draw-gap "DPD" [:box-related])
(draw-bottom)</pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Given <code>17.42Q4f2 : XDec&lt;2, 2&gt;</code>, <code>0</code> is for sign, and <code>1742</code> is <code>1001 1000 0011 00</code> in DPD encoding.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Failed to generate image: no implicit conversion of nil into String
(def boxes-per-row 15)
(def left-margin 0)
(draw-column-headers {:labels (map str (range 15))})
(draw-box (text "0" :hex))
(draw-box (text "1" :hex) [:box-first])
(draw-box (text "0" :hex) [:box-related])
(draw-box (text "1" :hex) [:box-related])
(draw-box (text "0" :hex) [:box-related])
(draw-box (text "0" :hex) [:box-related])
(draw-box (text "1" :hex) [:box-related])
(draw-box (text "0" :hex) [:box-related])
(draw-box (text "1" :hex) [:box-related])
(draw-box (text "1" :hex) [:box-related])
(draw-box (text "0" :hex) [:box-related])
(draw-box (text "1" :hex) [:box-related])
(draw-box (text "1" :hex) [:box-related])
(draw-box (text "1" :hex) [:box-related])
(draw-box (text "0" :hex) [:box-last])
(draw-bottom)</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following table compiles sizes required for the first ten digits in a decimal fixed-point number.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"># of digits</th>
<th class="tableblock halign-left valign-top">DPD bitsize</th>
<th class="tableblock halign-left valign-top">Resulting bitsize</th>
<th class="tableblock halign-left valign-top">Required bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">34</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">35</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_units"><a class="link" href="#_units">12.11. Units</a></h3>
<div class="paragraph">
<p>A unit type is an object, but it only exists in a single instance and does not occupy any memory in runtime.</p>
</div>
<div class="listingblock">
<div class="title">Listing 8. Unit type declaration syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">(* A unit type declaration. *)
unit =
  type_visibility_mod,

  (* !keyword(Unit type declaration) *)
  "unit",

  id,
  [generic_args_decl],

  ";" | block();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A unit type may derive from a trait.</p>
</div>
<div class="paragraph">
<p>A unit type shall not extend any other types.</p>
</div>
<div class="paragraph">
<p>Unit members do not have storage.
Unit members may be accessed both in namespace- and object-access styleinfo:[, for example <code>Unit.foo()</code> is equivalent to <code>Unit::foo()</code>].</p>
</div>
<div class="openblock info">
<div class="content">
<div class="paragraph">
<p>Akin to instance members in an object, unit functions are also referenced as <em>(unit) methods</em>, and unit values&#8201;&#8212;&#8201;as <em>(unit) fields</em>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Within a unit method implementation, <code>this</code> is equivalent to <code>self</code>.</p>
</div>
<div class="paragraph">
<p>TODO: An instance storage bound to a unit always expands to the static storage.</p>
</div>
<div class="paragraph">
<p>A unit type is a functor with zero arity.
A call to a unit type returns itself.</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Unit types</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">unit Foo
  let x = 42

  def get_x
    return x
  end
end

assert(Foo == Foo())
assert(Foo.x == Foo::x)
assert(Foo.get_x == Foo::get_x)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_structs"><a class="link" href="#_structs">13. Structs</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Can only define <code>val</code> fields, which mutability depends on the containing struct. Struct have default initializer, can not have finalizers.</p>
</div>
<div class="paragraph">
<p>TODO: <code>: this</code> in function returns control exactly to <code>this</code>.</p>
</div>
<div class="paragraph">
<p>TODO: Returning or throwing an alive struct does not require moving it, as the act the passing an argument to the caller implicitly moves the lifetime responsibility to it. {#lifetime-return-move}</p>
</div>
<div class="sect2">
<h3 id="_members_2"><a class="link" href="#_members_2">13.1. Members</a></h3>
<div class="paragraph">
<p>A member is a struct instance variable.</p>
</div>
</div>
<div class="sect2">
<h3 id="struct-lifetime"><a class="link" href="#struct-lifetime">13.2. Lifetime</a></h3>
<div class="sect3">
<h4 id="struct-initialization"><a class="link" href="#struct-initialization">13.2.1. Initialization</a></h4>

</div>
<div class="sect3">
<h4 id="struct-finalization"><a class="link" href="#struct-finalization">13.2.2. Finalization</a></h4>

</div>
</div>
<div class="sect2">
<h3 id="struct-reopening"><a class="link" href="#struct-reopening">13.3. Reopening</a></h3>
<div class="paragraph">
<p>An already defined struct may be defined again.
Instead of a complete redefining, the definition continues as if it was the original definition.
Thus, instead of redefinition it is called <em>reopening</em>.</p>
</div>
<div class="paragraph">
<p>A struct reopening may be either complete or incomplete, set by <code>compl</code> or <code>incompl</code> definition modifiers accordingly.
Following the usual definition rules, reopening a struct is implicitly complete by default.</p>
</div>
<div class="paragraph">
<p>Declaring new members is limited by the reopened struct&#8217;s completeness.</p>
</div>
</div>
<div class="sect2">
<h3 id="_completeness"><a class="link" href="#_completeness">13.4. Completeness</a></h3>
<div class="paragraph">
<p>A complete struct has all its members declared, thus having a defined memory layout (unless <a href="#ordering">reordered</a>).</p>
</div>
<div class="paragraph">
<p>Only a complete struct may be initialized (see <a href="#struct-lifetime">Section 13.2, &#8220;Lifetime&#8221;</a>).</p>
</div>
<div class="paragraph">
<p>Once complete, a struct may not be <a href="#struct-reopening">reopened</a> as incomplete.</p>
</div>
<div class="paragraph">
<p>A complete reopening of an already complete struct prohibits declaring new members and extending from structs.</p>
</div>
<div class="paragraph">
<p>By default, a struct definition is implicitly complete.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extending"><a class="link" href="#_extending">13.5. Extending</a></h3>
<div class="paragraph">
<p>A struct may extend at most one another struct.</p>
</div>
<div class="paragraph">
<p>An extending struct inherits all of the extended struct declarations, excluding type declarations, in the same order of declaration.
Also see <a href="#ordering">Section 13.6.1, &#8220;Ordering&#8221;</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. The possibility of an extension based on the completeness status of a struct</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Extending struct</th>
<th class="tableblock halign-left valign-top">Extended struct</th>
<th class="tableblock halign-left valign-top">Extension possible?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incomplete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incomplete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incomplete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes <sup>1</sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An <code>extend</code> statement shall be placed before any field implementations in a struct.</p>
</div>
<div class="paragraph">
<p>Regardless of where an <code>extend</code> statement is placed, the extending struct members follow the extended struct members in memory unless the extending struct is unordered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">struct Foo
  let x
end

# Memory layout of `Bar`
# would be `x, y, z`
struct Bar
  extend Foo;
  let y
  let z
end</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_memory_layout"><a class="link" href="#_memory_layout">13.6. Memory layout</a></h3>
<div class="sect3">
<h4 id="ordering"><a class="link" href="#ordering">13.6.1. Ordering</a></h4>
<div class="paragraph">
<p>The order of a struct fields in memory is undefined.</p>
</div>
<div class="paragraph">
<p>A struct may be reordered.
In that case, the order of its members is not defined.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A reordered struct memory layout is a subject to compiler optimizations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To make a struct reordered, the built-in zero-arity <code>Reorder</code> annotation shall be applied to it.</p>
</div>
<div class="paragraph">
<p>A struct extending from a reordered struct has undefined order of extended struct members only, in the boundaries of memory occupied by extended struct members.
Applying the <code>Reorder</code> annotation to an extending struct mixes the boundaries of memory occupied by all members, thus allowing for more optimal reordering.</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Deriving from a reordered struct</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">@[Reorder]
struct Foo
  let foo_a : SInt32
  let foo_b : FBin64
  let foo_c : SInt32
end

# The memory layout would be the following:
# `[foo_*]x3, bar_a, bar_b, bar_c`,
# where `foo_*` have undefined order.
struct Bar
  extend Foo;

  let bar_a : SInt32
  let bar_b : FBin64
  let bar_c : SInt32
end

# In this case, the order of members
# of `Baz` is totally undefined.
@[Reorder]
struct Baz
  extend Foo;

  let bar_a : SInt32
  let bar_b : FBin64
  let bar_c : SInt32
end</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_packing"><a class="link" href="#_packing">13.6.2. Packing</a></h4>

</div>
</div>
<div class="sect2">
<h3 id="_anonymous_structs"><a class="link" href="#_anonymous_structs">13.7. Anonymous structs</a></h3>
<div class="paragraph">
<p>An anonymous struct may only declare indexed or named members.</p>
</div>
<div id="explicit-indexing-rule" class="paragraph">
<div class="title">Explicit indexing rule</div>
<p>Indexed member declarations following a named or an explicitly indexed member declaration must be explicitly indexed.</p>
</div>
<div class="paragraph">
<p>An anonymous struct member can not have a default value, thus each member must be restricted to a concrete type.</p>
</div>
<div class="paragraph">
<p>The memory layout of a non-reordered anonymous struct matches its members declaration order.
Thus, the order of members (even named) in a non-reordered anonymous struct matters.</p>
</div>
<div class="sect3">
<h4 id="_anonymous_struct_literals"><a class="link" href="#_anonymous_struct_literals">13.7.1. Anonymous struct literals</a></h4>
<div class="paragraph">
<p>An anonymous struct literal consists of an arbitrary amount of implicitly or explicitly indexed or explicitly named values, wrapped in parentheses.</p>
</div>
<div class="paragraph">
<p>Values declaration follows the <a href="#explicit-indexing-rule">Explicit indexing rule</a>.</p>
</div>
<div class="paragraph">
<p>Trailing commas are allowed in anonymous struct literals.</p>
</div>
<div class="paragraph">
<p>A single implicitly indexed value without a trailing commas is treated as an expression rather than an anonymous struct.</p>
</div>
</div>
<div class="sect3">
<h4 id="_anonymous_struct_destruction"><a class="link" href="#_anonymous_struct_destruction">13.7.2. Anonymous struct destruction</a></h4>
<div class="paragraph">
<p>An anonymous struct may be destructed using the splat operator.</p>
</div>
<div class="paragraph">
<p>A destructed anonymous struct may be multi-assigned to a set of variables, or become a varg restriction.</p>
</div>
<div class="paragraph">
<p>Upon multi-assignment, an anonymous struct member can be referenced by either its implicit or explicit index, or by its name. References follow the <a href="#explicit-indexing-rule">Explicit indexing rule</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Multi-assignment of an anonymous struct</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx"># Members `[0]` and `[1]` are referenced
# by their implicit indices 0 and 1.
# Members `foo` and `[2]` are referenced explicitly.
let a, b, foo: c, [2]: d = *('a', [1]: 'b', foo: 'c', [2]: 'd')</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_anonymous_struct_member_ordering"><a class="link" href="#_anonymous_struct_member_ordering">13.7.3. Anonymous struct member ordering</a></h4>
<div class="paragraph">
<p>An anonymous struct may become reordered by setting its <code>Reordered</code> generic argument to <code>true</code> (<code>false</code> by default).</p>
</div>
<div class="paragraph">
<p>The memory layout of a reordered anonymous struct may not match its members declaration order due to possible reordering of its memebers.</p>
</div>
<div class="paragraph">
<p>Two reordered anonymous structs containing the same set of members but in different order of declarations are guaranteed to have the same memory layout.</p>
</div>
<div class="paragraph">
<p>An anonymous struct literal may become reordered if appended with <code>r</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_packed_anonymous_structs"><a class="link" href="#_packed_anonymous_structs">13.7.4. Packed anonymous structs</a></h4>
<div class="paragraph">
<p>An anonymous struct may become packed by setting its <code>Packed</code> generic argument to <code>true</code> (<code>false</code> by default).</p>
</div>
<div class="paragraph">
<p>A packed struct and its members have alignment of 1.</p>
</div>
<div class="paragraph">
<p>An anonymous struct literal may become packed if appended with <code>p</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_traits"><a class="link" href="#_traits">14. Traits</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A trait is a composable unit of behaviour.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The traits implementation is inspired by <a href="https://en.wikipedia.org/wiki/Trait_(computer_programming)#cite_note-2"><em>Traits: A mechanism for fine-grained reuse</em></a> by Ducasse et al., 2006.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>TODO: Only units and objects may derive from a trait.
Namespaces do not have behaviour.</p>
</div>
<div class="sect2">
<h3 id="_declaring_a_trait"><a class="link" href="#_declaring_a_trait">14.1. Declaring a trait</a></h3>
<div class="listingblock">
<div class="title">Listing 9. Trait declaration syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">trait_decl =
  trait_decl_mod,
  ["decl"],
  "trait",
  id,
  [nb, generic_arguments_decl],
  ";" | body();

trait_decl_mod = [type_visibility_mod];</code></pre>
</div>
</div>
<div class="paragraph">
<p>A trait type can not be implemented; instead, it is continuously declared.
A <code>trait T</code> statement is a shortcut to <code>decl trait T</code>.
A trait declaration statement may include a type visibility modifier and a generic arguments declaration.</p>
</div>
<div class="paragraph">
<p>A trait type is always an incomplete type.
A trait type declaration statement can not contain a completeness modifier.</p>
</div>
<div class="paragraph">
<p>A trait type function and value members have storage.
The storage is implicitly instance.</p>
</div>
<div class="paragraph">
<p>A trait type allows method declaration and implementation.
A trait method implementation is specialized for every deriving type separately.
A trait method implementation may use <code>this</code> and <code>super</code> keywords, which evaluate in accordance to the context the method is specialzied within.</p>
</div>
</div>
<div class="sect2">
<h3 id="_trait_arithmetic"><a class="link" href="#_trait_arithmetic">14.2. Trait arithmetic</a></h3>
<div class="paragraph">
<p>An object or trait type conveys a set of traits it derives from, which is empty by default for object types and contains itself for trait types.</p>
</div>
<div class="paragraph">
<p>Deriving from a trait adds the trait term to the deriving type traits set.</p>
</div>
<div class="paragraph">
<p>Trait set composition is commutative: the ordering of adding traits to the set does not matter.</p>
</div>
<div class="paragraph">
<p>Nested traits are equivalent to flattened traits; the trait set composition hierarchy does not affect the traits behaviour.</p>
</div>
<div class="paragraph">
<p>The same trait may be derived multiple times by the same object; it would still count as a single traits set entry.</p>
</div>
<div class="paragraph">
<p>Recursive derivations are allowed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deriving_from_a_trait"><a class="link" href="#_deriving_from_a_trait">14.3. Deriving from a trait</a></h3>
<div class="paragraph">
<p>A type which has a <code>derive T</code> clause is said to <em>derive from</em> <code><em>T</em></code>.</p>
</div>
<div class="listingblock">
<div class="title">Listing 10. The <code>derive</code> clause syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">derive =
  ["undefstor" | "static" | "instance"],
  "derive",
  id,
  ";" | block();</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Deriver, deriving (type), derivative</dt>
<dd>
<p>The type deriving from a trait.</p>
</dd>
<dt class="hdlist1">Derivee, derived (type)</dt>
<dd>
<p>The trait a type derives from.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A deriving type may contain multiple <code>derive</code> statements.</p>
</div>
<div class="paragraph">
<p>Deriving from a trait includes all of its members with undefined storage into the deriving type as if they were defined within the deriving type itself, which may lead to name collisions.
The storage of an included member depends on the storage modifier of the according <code>derive</code> clause.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. <code>derive</code> clause storage modifiers</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Deriving type</th>
<th class="tableblock halign-left valign-top">Allowed modifiers</th>
<th class="tableblock halign-left valign-top">Default modifier</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Namespace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trait</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static</code>, <code>undefstor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>undefstor</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primitive, class, enum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static</code>, <code>instance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instance</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Therefore, <code>static derive T</code> from type <code>U</code> is identical to reopening a <code>Type&lt;U&gt;</code> type and then instance-deriving it from <code>T</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. Multiple ways to statically derive</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 11. Static derive in T</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">reopen SInt32
  static derive Debuggable
    impl debug(stream) { stream &lt;&lt; "SInt32" }
  end
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 12. Instance derive in Type&lt;T&gt;</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">reopen Type&lt;SInt32&gt;
  derive Debuggable
    impl debug(stream) { stream &lt;&lt; "SInt32" }
  end
end</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Only statements allowed within a <code>derive</code> statement are <code>impl</code>, <code>reimpl</code>, <code>alias</code> and <code>moveimpl</code>.</p>
</div>
<div class="paragraph">
<p>A <code>derive</code> statement may be early-terminated with a semicolon, left without any inner statements.</p>
</div>
<div class="paragraph">
<p>Lookups within a <code>derive</code> statement check the trait&#8217;s scope at first, and then go up to the deriving type.</p>
</div>
<div class="paragraph">
<p>A derived trait type may be referenced using the <code>derived</code> keyword.
The deriving type may still be referenced using the <code>self</code> keyword.</p>
</div>
<div class="paragraph">
<p>Technically, it is allowed to reference other traits' members within a <code>derive</code> statement, e.g. <code>self~OtherTrait:foo</code> (see behavioral erasure below) or <code>~OtherTrait:foo</code> or even <code>foo</code> (unless there is an ambiguity).</p>
</div>
<div class="paragraph">
<p>A <code>derive</code> statement does not require all included members' implementations to be contained within it (the <code>derive</code> statement).</p>
</div>
<div class="paragraph">
<p>As any other, derived implementations are lazily checked upon specialization.
If a declaration is not implemented at all, the implementation responsibility is passed to the next deriving type, if any.</p>
</div>
<div class="sect3">
<h4 id="_behavioral_erasure"><a class="link" href="#_behavioral_erasure">14.3.1. Behavioral erasure</a></h4>
<div class="paragraph">
<p>A derived trait&#8217;s members are always accessible via their original identifiers with behavioral erasure achieved with fuzzy restriction.</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Using fuzzy restriction to access original trait identifiers</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx"># In this example, both `Drawable2D` and `Drawable3D`
# have `draw` method declaration. A deriving type has
# to deal with the collision. One way would be to
# alias (both) methods under different names.
trait Drawable2D
  decl draw
end

trait Drawable3D
  decl draw
end

@[Trivial]
class Point
  derive Drawable2D
    impl draw;

    # Must use `self` here, otherwise
    # would attempt to declare a new
    # identifier within a `derive` clause,
    # which is prohibited.
    alias self:draw2d to draw
  end

  derive Drawable3D
    impl draw;
    alias self:draw3d to draw
  end
end

final p = Point()

p.draw2d # OK
p.draw3d # OK

# p.draw # Panic! Ambiguous choice between
         # `Point~Drawable2D.draw` and
         # `Point~Drawable3D.draw`

p~Drawable2D.draw     # OK
(p ~ Drawable3D).draw # OK

def draw2d(x ~ Drawable2D)
  x.draw # OK. Thanks to behavior erasure, exactly
         # `Drawable2D~draw` is always referenced
end

draw2d(p) # OK

def draw_or(x ~ Drawable2D || Drawable3D)
  # x.draw # Panic! `x` may be BOTH `Drawable2D` and `Drawable3D`,
           # hence unable to choose right implementation

  if not x ~? Drawable2D
    x.draw # OK. The compiler can prove that it can only
           # be `Drawable3D`. Even if we add `Drawable4D`
           # with the same `draw` declaration,
           # the behavior erasure feature would always
           # reference `~Drawable3D.draw` exactly.
  end
end

draw_or(p) # OK

def draw_and(x ~ Drawable2D ^ Drawable3D)
  x.draw # OK. There will never be an ambiguity
end

# draw_and(p) # Panic! Point contains BOTH traits, but they're XORed</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_abstract_traits"><a class="link" href="#_abstract_traits">14.4. Abstract traits</a></h3>
<div class="paragraph">
<p>A trait may be declared as <code>abstract</code>.
An abstract trait shall not be derived by a non-trait type.
An abstract trait may be extended by a trait type.
info:[Effectively, an abstract trait is merged into the extending trait instead of being treated as a separate term participating in the traits sum.
All instance members of an abstract trait are treated as if they were declared in the deriving trait itself.]
Biasing to an abstract trait does not treat its methods as ever implemented.</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Abstract traits</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">abstract trait Drawable
  decl draw()

  def double_draw
    draw()
    draw()
  end
end

trait Drawable2D &lt; Drawable;
trait Drawable3D &lt; Drawable;

struct Point
  derive Drawable2D
    impl draw() as self~draw2d;
  end

  derive Drawable3D
    impl draw() as self~draw3d;
  end
end

struct Line
  derive Drawable2D
    impl draw()
  end
end

def double_draw2d(x ~ Drawable)
  # x.draw() # Panic! Can not call an abstract trait method declaration

  if x ~? Drawable2D
    x.double_draw() # Eq. to `x~Drawable2D.double_draw()`
  else
    throw "Not a 2D, rejecting"
  end
end

double_draw2d(Point()) # Calls `Point~Drawable2D:double_draw`
double_draw2d(Line())  # Calls `Line:double_draw`</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>Drawable</code> was not an abstract trait, but rather a simple trait, it would participate in the trait sum, leading to unwanted collisions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">trait A
  decl foo;

  def double_foo
    foo()
    foo()
  end
end

# Effectively, `B` = 0 + `A`.
trait B &lt;~ A;

# Effectively, `C` = 0 + `A`.
trait C &lt;~ A;

struct Foo
  # `B + C = 0 + A + 0 + A = A`
  &lt;~ B, C

  # Either one of these would
  # suffice, but exactly one.
  impl A~foo;
  impl B~foo;
  impl C~foo;

  # An attempt to implement
  # either again would panic.
  impl A~foo; # Panic!
  impl B~foo; # Panic!
  impl C~foo; # Panic!
end

struct Bar
  &lt;~ B
  impl A~foo;
end

Foo~A:foo # OK
Foo~B:foo # Nope.

reopen (A &amp;&amp; B)
  decl foo
end</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>TODO: <code>decl let color : UInt8</code> vs. <code>decl color : UInt8</code> &amp;&amp; <code>decl color=(UInt8) : Void</code>.
<code>line..color=(42).color</code> is acceptable?</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_api"><a class="link" href="#_core_api">15. Core API</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Onyx Core API is the <code>Core::</code> namespace including types, functions and macros built into the language.</p>
</div>
<div class="paragraph">
<p>The <code>Core::</code> namespace is available from <strong>every</strong> Onyx source code file.</p>
</div>
<div class="paragraph">
<p>Criteria for being included in the Core API are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Have a great chance of being implemented on hardware level.
For example, integers are ubiquitous, floating points are common, and tensors are typical for GPUs.
For the same reason most basic math operations are in the Core API;</p>
</li>
<li>
<p>Have literals built into the language.
For example, ranges;</p>
</li>
<li>
<p>Have traits otherwise impossible to express using the language.
For example, blocks, lambdas, functions, unions, variants, void etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Core API types' memory layout is usually undefined.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/core-scalar-types.svg" alt="core scalar types" width="1024" height="680">
</div>
<div class="title">Figure 1. Core API scalar types diagram</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/core-aliases.svg" alt="core aliases" width="640" height="840">
</div>
<div class="title">Figure 2. Core API aliases diagram</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./img/core-aggregate-types.svg" alt="core aggregate types" width="832" height="200">
</div>
<div class="title">Figure 3. Core API aggregate types diagram</div>
</div>
<div class="paragraph">
<p>Other than types deriving from <code>Scalar</code> and <code>Aggregate</code>, the Core API also includes freestanding <code>Void</code>, <code>Union</code>, <code>Vector</code> and <code>Quire</code> types.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_directives"><a class="link" href="#_directives">16. Directives</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>directive</em> is an instruction to the compiler.</p>
</div>
<div class="sect2">
<h3 id="_file_dependency_directives"><a class="link" href="#_file_dependency_directives">16.1. File dependency directives</a></h3>
<div class="paragraph">
<p>File dependency directives are <code>require</code> and <code>import</code> directives.</p>
</div>
<div class="paragraph">
<p>A file dependency directive makes the program depend on a source file at the provided pathname.
The same file may be referenced from multiple file dependency directives, but it is guaranteed to be processed exactly once first time it is referenced.
If the same file is referenced both from a <code>require</code> and <code>import</code> directive, then it is processed exactly twice.</p>
</div>
<div class="paragraph">
<p>The order in which files are referenced both from inside a single file dependency directive and the global order matter.
A user should keep in mind the actual entities structure so they do not reference an undeclared yet entity.</p>
</div>
<div class="paragraph">
<p>A single file dependency directive may contain multiple pathnames, as well as patterns in pathnames.</p>
</div>
<div class="paragraph">
<p>Filename and pathname resolution rules in a file dependency directive shall conform to sections 4.7, 4.8 and 4.13 of IEEE Std 1003.1-2017.
Pathname pattern matching notation shall conform to section 2.13 of IEEE Std 1003.1-2017.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The IEEE Std 1003.1-2017 is known as the POSIX standard.
Pathnames in file dependency directives shall conform to the POSIX standard so they stay cross-platform.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An optional <code>at</code> clause in a file dependency directive substitutes the provided pathname with every pathname listed in the <code>from</code> clause in a file dependency directive.
If an <code>at</code> clause is present, then <code>from</code> clause shall be present with the explicit <code>from</code> keyword.
For example, <code>require "bar/foo.nx"</code> is equivalent to <code>require from "foo.nx" at "bar"</code>.</p>
</div>
<div class="paragraph">
<p>An implementation shall provide a way to add to the list of base lookup paths for every file dependency directive class in the manner similar to <code>-I</code> and <code>-L</code> flags ubiquitous in C compilers.</p>
</div>
<div class="paragraph">
<p>The Macro API provides ways to both invoke a file dependency directive as well as alter the base lookup paths.</p>
</div>
<div class="sect3">
<h4 id="_require_directive"><a class="link" href="#_require_directive">16.1.1. <code>require</code> directive</a></h4>
<div class="paragraph">
<p>A <code>require</code> directive makes the program to include an Onyx source file into the program source.</p>
</div>
<div class="paragraph">
<p>Recursive <code>require</code> directives are allowed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">require_directive =
  "require",

  @unord(
    (* Path(s) of the required file *)
    (["from"], path, {",", path}),

    (* The base path *)
    ["at", path]
  );</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_import_directive"><a class="link" href="#_import_directive">16.1.2. <code>import</code> directive</a></h4>
<div class="paragraph">
<p>An <code>import</code> directive makes the program aware of entities contained in the imported file such that those entities are not a part of the program itself, but rather can be referenced from the program.</p>
</div>
<div class="paragraph">
<p>An imported file may contain source code in a language other than Onyx.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Standard defines interoperability specifications for the following languages: Onyx, C, Lua.
However, an implementation is not limited to those languages defined in the Standard.</p>
</div>
<div class="paragraph">
<p>Read more about interoperability in Interoperability.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">(*
  Import a file written possibly
  in a language other than Onyx.

  ```
  import from "stdio.h" in "C"
  import in "Rust" from "main.rs", "aux.rs" at "/mypath/"
  ```
*)
import_directive =
  "import",

  @unord(
    (* The source language of an imported file *)
    ("in", string),

    (* Paths to the imported files *)
    ("from", string, {",", string}),

    (* The base path for the imported files *)
    ["at", string]
  );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_directive"><a class="link" href="#_using_directive">16.2. <code>using</code> directive</a></h3>
<div class="paragraph">
<p>The <code>using</code> directive either injects a namespace <code>N</code> into the local scope, so that members of <code>N</code> are directly accessible from the local scope; or applies a refinement <code>R</code> in the local scope; or defines an alias <code>A</code> to <code>B</code> effective in the local scope.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">using =
  using_namespace |
  using_refinement |
  using_alias;

using_namespace =
  "using",
  ["namespace"],
  type_ref;

using_refinement =
  "using",
  ["refinement"],
  type_ref;

using_alias =
  "using",
  ["alias"],
  decl,
  ("=", "to"),
  ref;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a <code>using</code> directive contains <code>=</code> or <code>to</code>, it is then implicitly treated as <code>using alias</code>.
Otherwise, the kind of <code>using</code> is inferred from the referenced identifier.
An explicit <code>namespace</code>, <code>reference</code> or <code>alias</code> clause may be present to enforce the kind of <code>using</code>.</p>
</div>
<div class="paragraph">
<p>For a <code>using</code> directive, the scope is limited to the containing source file.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">Listing 13. Using a namespace</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">namespace Foo
  let bar = 42
end

using Foo # `using namespace` is inferred
bar = 43  # OK</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 14. Explicit <code>using</code> kind</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">namespace Foo
end

using namespace Foo # OK
# using refinement Foo # Panic!</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 15. Using an alias</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">namespace Foo
  let bar = 42
end

using Baz = Foo # `using alias` inferred

Baz.bar = 43 # OK
Foo.bar = 44 # Still OK
# bar = 45   # Panic! `bar` is not declared in current scope</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_literals"><a class="link" href="#_literals">17. Literals</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A literal is a constant value known at compilation time, as opposed to a non-literal value computed at runtime.</p>
</div>
<div class="paragraph">
<p>Despite of the knowledge of existence of such a literal value, a compiler may decide to change its form or completely remove from a binary for optimization purposes.
In other words, for some kinds of literals, there is no guarantee that a literal would be stored anywhere in a resulting binary; but it must be transparent to a user of the program.</p>
</div>
<div class="paragraph">
<p>A literal is an rvalue.</p>
</div>
<div class="sect2">
<h3 id="literal-constrainment"><a class="link" href="#literal-constrainment">17.1. Literal constrainment</a></h3>
<div class="paragraph">
<p>Each literal conveys a certain amount of information, which determines its level of constrainment.</p>
</div>
<div class="paragraph">
<p>A literal constrainment determines the set of restrictions it can match.</p>
</div>
<div class="paragraph">
<p>A literal constrainment may be altered with literal prefixes and suffixes.</p>
</div>
<div class="paragraph">
<p>A literal without any prefixes or suffixes is said to be <em>unconstrained</em>.
Some literal kinds have default types defined for their unconstrained literals, e.g. an unconstrained integral literal is <code>SInt32</code> by default.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Even an unconstrained literal still have some constraints.
For example, a numeric literal can never become a string.
Or a negative whole number can never become an unsigned integer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A literal can be instance-restricted (both with concrete and fuzzy restrictions) to a type, e.g. <code>42 : SInt32</code>.
Applying an instance restriction to a literal takes into consideration and contributes into its constrainment level.
For example, <code>42f : SInt32</code> would be invalid, as the literal is already constrained to a binary floating-point value.
Or, <code>42 ~ FBin : SInt32</code> would also fail on the second restriction.</p>
</div>
<div class="paragraph">
<p>A literal can be type-restricted to either an exact literal value (e.g. <code>42 :\: @{42}</code>) or a built-in type having literals (e.g. <code>42 ~~ @{Size}</code>).
Such a restriction, where the right operand is wrapped in <code>@{}</code>, is called a <em>literal restriction</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Literal restrictions are ubiquitous in generic type arguments, e.g. <code>primitive Array&lt;Type: T, Size: S ~ @{Size}&gt;</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>TODO: Refine exact and fuzzy restrictions, standardize scalar and aggregate literals.</p>
</div>
<div class="paragraph">
<p>Only a type restriction may be a literal restriction.
Only a literal may be the left operand of a literal restriction.
A literal restriction returns its left operand, the literal.</p>
</div>
<div class="paragraph">
<p>An exact literal restriction must match a complete type literal.
For example, <code>@{42i}</code> and <code>@{FBin}</code> are invalid restrictions, because neither literal represents a complete type (despite of the fact that <code>i</code> defaults to <code>SInt32</code>; in a literal restriction it expands to simply <code>SInt</code>).
A valid example would be <code>@{42i32}</code>.</p>
</div>
<div class="paragraph">
<p>A fuzzy literal restriction may match an incomplete literal kind, but it erasures the left operand behavior, which affects the literal constainment.</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Literal constrainment</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx"># `1` is unconstrained. An unconstrained
# integral literal defaults to `SInt`.
# However, it may be further restricted to other types.
1 ~ Integer
1 ~ FloatingPoint
1 ~ Integer&lt;Signed: false&gt; : UInt8

# Adding `-` to the literal reduces the
# set of restrictions it can match
-1 ~ Integer&lt;Signed: true&gt;
-1 !~ Integer&lt;Signed: false&gt;
-1 ~ FloatingPoint

# Adding a fractional part turns
# a literal into a non-integer
1.0 ~ FloatingPoint
1.0 ~ Fixed
1.0 !~ Integer

1.0f ~ FBin
1.0f64 : FBin64</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 16. TODO:</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">def foo(x: L) forall L : %i
  \{{ nx.scope.L.value }} # `foo(42i) -&gt; 42i`
  \{{ nx.scope.L.number }} # `foo(42i) -&gt; 42`
end

def foo(x : L) forall L : %q
  \{{ nx.scope.L.value }} # `foo("x"utf8) -&gt; "x"utf8`
  \{{ nx.scope.L.string }} # `foo("x"utf8) -&gt; "x"`
end

%i, %si  # Integer
%ui      # Unsigned integer (natural)
%i32, %z # Limit values

%r, %ri32 # Any-end range

# For clarity with `()`, this is disallowed
# %ri[) # Specific-end range

%q # Any-encoding string, value is
%qucs # Accept `"foo"utf8` and `"foo"ucs2`, reject `"foo"ascii`

%ucs, %c, %cucs # A char

# Array of literals is prohibited?
# Because array becomes a runtime value?
# %c[] # An array of chars

%c(2) # Exactly 2 chars
%c(2..) # At least 2 chars
%c(1..3) # 1 to 3 chars

def foo(*x : L) forall L : %c(2)
foo(('a', 'b'), ('a', 'b'))

def foo(x : L) forall L : %c(2..)
foo('a', 'b', 'c')

def foo(*x : L) forall L : %c
foo('a', 'a', 'a') # Useless

def foo(*x : L) forall L in ('a', 'b', 'c')
foo('a', 'c') # OK</code></pre>
</div>
</div>
<div id="literal-restrictions" class="exampleblock">
<div class="title">Example 21. Literal restrictions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">42 ~ @{42} : @{42f} : FBin64
42 ~ @{42i} !: @{42f} # Can not further restrict `i` to `f`

struct Foo&lt;T : @{Size}&gt;
end

Foo&lt;42&gt; # OK
# Foo&lt;-42&gt; # Panic!

struct Bar&lt;T : (@{"foo"} || @{"bar"}) ~ @{String}&gt;
end

Bar&lt;"foo"&gt; # OK
# Bar&lt;"baz"&gt; # Panic!</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_underscores"><a class="link" href="#_underscores">17.2. Underscores</a></h3>
<div class="paragraph">
<p>Underscores can be used in a literal to either visually divide its parts without contributing into its value, or as a part of its value (true for text literals), or both.</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. Application of underscores in literals</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">1_000_i32     # Underscores do not contribute into the value
"Hello_world" # Underscore is a part of the value
"a_b"_u16     # Both</code></pre>
</div>
</div>
</div>
</div>
<div id="literal-suffix-prefix-no-underscore" class="paragraph">
<p>Literal suffixes and prefixes (see <a href="#literal-multiplier-prefix">[literal-multiplier-prefix]</a>, <a href="#literal-encoding-prefix">[literal-encoding-prefix]</a>) are treated as a whole and therefore can not contain underscores.</p>
</div>
<div class="paragraph">
<p>A preceding underscore is treated as (a part of) an identifier and therefore prohibited in literals, e.g. <code><em>1</code> is an identifier, and <code></em>'a'</code> is a error.</p>
</div>
<div class="paragraph">
<p>Sequential underscores are allowed, e.g. <code>1__000</code>.</p>
</div>
<div id="trailing-underscores-in-literals" class="paragraph">
<p>Trailing underscores are allowed in numeric and text literals, but only after a prefix.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to the fact that suffixes are read from the end, trailing underscores are required in cases when it is desired to emphasize the absence of a suffix, for example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. Using trailing underscores to emphasize the absence of suffix in literals</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">0z : Size     # "z" is "size" suffix
0z_ : FBin64  # "z" is "Zepto" multiplier prefix
0z_f : FBin64 # Ditto

# 0fz # Panic! Can not apply "Zepto" prefix to a `Size` literal
0fz_ : FBin64 # Prefixes: "f" for "Femto", "z" for "Zepto"

# # A compiler sees it as `'a'asci_i`
# 'a'ascii # Panic! Can not find encoding `ASCI`

'a'ascii_ : CPoint&lt;UCS2&gt;
'a'asciii : SInt32</code></pre>
</div>
</div>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_literal_suffixes"><a class="link" href="#_literal_suffixes">17.3. Literal suffixes</a></h3>
<div class="paragraph">
<p>A literal suffix is a combination of graphemes adjacent to a literal contributing into the literal&#8217;s <a href="#literal-constrainment">constrainment</a>.</p>
</div>
<div class="paragraph">
<p>Literal suffixes are only applicable to either scalar or magic literals.</p>
</div>
<div class="paragraph">
<p>TODO: A scalar literal is an nvalue.
A scalar literal wrapped in parentheses is still a literal instance.
Therefore, literal suffixes are applicable to scalar literals even wrapped in parentheses, e.g. <code>(42)i32</code>, <code>("foo")utf16be</code>.</p>
</div>
<div class="paragraph">
<p>In a non-<a href="#_magic-literals">magic</a> literal, literal suffixes follow the literal value, e.g. <code>1i</code>.
In a magic literal, literal suffixes precede the literal value(s), e.g. <code>%i[1]</code></p>
</div>
<div class="paragraph">
<p>The first literal suffix in a literal, if any, is <em>major</em>.
The following suffixes are <em>minor</em>.</p>
</div>
<div class="paragraph">
<p>In a literal, literal suffixes are parsed from right to left.
A literal suffix has higher priority than other parts of a literal.</p>
</div>
<div class="paragraph">
<p>A literal suffix can not contain underscores.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Underscores may be used to visually separate suffixes from other parts of a literal.
Moreover, the fact that a trailing underscore is not allowed after a suffix makes it possible to distinguish between suffixes and, say, prefixes, for example <code>5f == 5.0f64</code> but <code>5f_ ~= 0.5e-15f64</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A literal suffix may be defined for a type using the <code>LiteralSuffix</code> annotation.
A type with a literal suffix defined must be a functor accepting a literal instance.
Whichever literal kinds are accepted by the functor defines which literal kinds the suffix may be applied to.</p>
</div>
<div class="paragraph">
<p>A custom literal suffix has higher precedence than a built-in literal suffix.
For example, <code>ascii</code> would be parsed as <code>ascii</code> if defined, and not <code>asci + i</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Defaults for unsuffixed literals</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Examples</th>
<th class="tableblock halign-left valign-top">Restriction</th>
<th class="tableblock halign-left valign-top">Default type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>42</code>, <code>-42</code>, <code>2.5k</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Numeric</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.5</code>, <code>-1f_</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Fractional</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'f'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char&lt;UCS&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"foo"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String&lt;UTF8&gt;</code></p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Built-in literal suffixes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Regex</th>
<th class="tableblock halign-left valign-top">Applicable to</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Default type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/s?i(?&lt;Bitsize&gt;\d+)/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer</code>, <code>Char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt&lt;Bitsize&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/s?i/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer</code>, <code>Char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/ui?(?&lt;Bitsize&gt;\d+)/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer</code>, <code>Char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UInt&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UInt&lt;Bitsize&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/ui?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer</code>, <code>Char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UInt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UInt32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/c/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char&lt;UCS&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/s/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String&lt;UTF8&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/ucs/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char&lt;UCS&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char&lt;UCS&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/utf8/</code>, <code>/utf(16|32)[lb]e/</code>, <code>/ucs(2|4)/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String&lt;Encoding&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String&lt;Encoding&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/fb?(?&lt;Bitsize&gt;\d+)/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Numeric</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin&lt;Bitsize&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/fb?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Numeric</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/f?d(?&lt;Bitsize&gt;\d+)/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Numeric</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FDec&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FDec&lt;Bitsize&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/f?d/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Numeric</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FDec</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FDec64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/Q(?&lt;Bitsize&gt;\d+)?(e(?&lt;Exponent&gt;[-]?\d))?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>XBin&lt;Bitsize, Exponent&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Either <code>Bitsize</code> or <code>Exponent</code> is required</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/D(?&lt;Total&gt;\d+)?(f(?&lt;Fractional&gt;\d+))?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>XDec&lt;Total, Fractional&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Either <code>Total</code> or <code>Fractional</code> is required</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/j/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>Imaginary</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Turns a literal constrainment from <code>T</code> into <code>Imaginary&lt;T&gt;</code></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/p(?&lt;Bitsize&gt;\d+)?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Posit&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>Bitsize</code> defaults to <code>32</code></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/bf(?&lt;Bitsize&gt;\d+)?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BFloat&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>Bitsize</code> defaults to <code>16</code></code></p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Built-in literal suffixes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Regex</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Accepted literals</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">Integer literal suffixes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/s?i(?&lt;Bitsize&gt;\d+)?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Int)</code>, <code>\(Char)</code> (xnum:character-literal-integral-suffix[]), <code>\(String)</code> (xnum:string-literal-integral-suffix[])</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bitsize</code> defaults to <code>32</code>. Default constraint for a signed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/ui?(?&lt;Bitsize&gt;\d+)?</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UInt&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Int)</code>, <code>\(Char)</code> (xnum:character-literal-integral-suffix[]), <code>\(String)</code> (xnum:string-literal-integral-suffix[])</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bitsize</code> defaults to <code>32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/c/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char&lt;UCS&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Int)</code>, <code>\(Char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Turns a literal constrainment into <code>Char</code> with default charset of <code>UCS</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/ucs/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Char&lt;UCS&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constrains a character literal charset to <code>UCS</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">Real literal suffixes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/fb?(?&lt;Bitsize&gt;\d+)?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bitsize</code> defaults to <code>64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/f?d(?&lt;Bitsize&gt;\d+)?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FDec&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bitsize</code> defaults to <code>64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/Q(?&lt;Bitsize&gt;\d+)?(e(?&lt;Exponent&gt;[-]?\d))?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>XBin&lt;Bitsize, Exponent&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either <code>Bitsize</code> or <code>Exponent</code> is required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/D(?&lt;Total&gt;\d+)?(f(?&lt;Fractional&gt;\d+))?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>XDec&lt;Total, Fractional&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either <code>Total</code> or <code>Fractional</code> is required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/j/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>Imaginary</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Turns a literal constrainment from <code>T</code> into <code>Imaginary&lt;T&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/p(?&lt;Bitsize&gt;\d+)?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Posit&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bitsize</code> defaults to <code>32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/bf(?&lt;Bitsize&gt;\d+)?/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BFloat&lt;Bitsize&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bitsize</code> defaults to <code>16</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">String literal suffixes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/utf8/</code>, <code>/utf16[bl]e/</code>, <code>/utf32[bl]e/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String&lt;UTF8&gt;</code>, <code>String&lt;UTF16BE&gt;</code>, <code>String&lt;UTF16LE&gt;</code>, <code>String&lt;UTF32BE&gt;</code>, <code>String&lt;UTF32LE&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constrains a string literal encoding</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/ucs2/</code>, <code>/ucs4/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String&lt;UCS2&gt;</code>, <code>String&lt;UCS4&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constrains a string literal encoding</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">C integer literal suffixes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/\$[su]?h/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$short</code>, <code>$`unsigned short`</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Int)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/\$[su]?i/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$int</code>, <code>$`unsigned int`</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Int)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/\$[su]?l/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$long</code>, <code>$`unsigned long`</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Int)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/\$[su]?ll/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$`long long`</code>, <code>$`unsigned long long`</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Int)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/\$[su]?z/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$size_t</code>, <code>$ssize_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Int)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">C real literal suffixes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/\$f/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/\$d/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/\$ld/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$`long double`</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\(Real)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title"><code>to_*</code> and <code>as_*</code> lookup algorithm</div>
<p>If a receiver <code>R</code> does not have a <code>to_*</code> or <code>as_*</code> method defined explicitly, a compiler then looks up for a literal suffix identical to the <code>*</code> part.
If such a suffix exists for a type <code>T</code>, and <code>R</code> has method <code>to(:: T)</code> defined, it is called then.
Otherwise, a compiler panics because of missing method.
For example, if <code>FBin64</code> had <code>to(:: SInt32)</code> defined, then all <code>fbin.to(SInt32)</code>, <code>fbin.to_si32</code> and even <code>fbin.to_i</code> would be valid.
Presence of the algoritm effectively allows hyphens and dollar sign in exclusively in function names beginning with <code>to_</code> and <code>as_</code>, for example <code>to_Qe-7</code> and <code>as_$f</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scalar_literals"><a class="link" href="#_scalar_literals">17.4. Scalar literals</a></h3>
<div class="sect3">
<h4 id="_numeric_literals"><a class="link" href="#_numeric_literals">17.4.1. Numeric literals</a></h4>
<div class="paragraph">
<p>TODO: Literal structure: base prefix, value: (numeric representation (including multipliers)), suffix.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Literals are designed to not scream until needed: the syntax is almost invariant in regards to casing, and most things are in lower case.
Exceptions are the Q number that is widely known by its upper-case name, hexadecimals to distinguish them from other parts, and big multiplier prefixes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Listing 17. Numeric literals syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">multiplier_prefix_iec =
  "Yi" | "Zi" | "Ei" | "Pi" |
  "Ti" | "Gi" | "Mi" | "Ki";

multiplier_prefix_si =
  "Y" | "Z" | "E" | "P" | "T" | "G" | "M" | "k" | "h" | "da" |
  "d" | "c" | "m" | "u" | "μ" | "n" | "p" | "f" | "a" | "z" | "y";

sint_suffix = ["s"], "i", {digit}; (* 32 bits by default *)
uint_suffix = "u", ["i"], {digit}; (* 32 bits by default *)
size_suffix = ["s" | "u"], "z"; (* Unsigned by default *)

fbin_suffix = "f", ["b"], {digit}; (* 64 bits by default *)
fdec_suffix = ["f"], "d", {digit}; (* 64 bits by default *)

(*
  Design rationale: despite of the fact that `p` can only be in
  lowercase in Onyx, it'd be confusing to see `42P8` and treat it
  other than a "42 * 2 ** 8". Had to pick another symbol therefore.
*)
posit_suffix = "t", {digit};
posit_suffix = "p", {digit};

(*
  Design rationale: would not use `B`, because
  brain float is "smaller" than usual float.
*)
bfloat_suffix = "bf", {digit};

literal_suffix =
  sint_suffix |
  uint_suffix |
  size_suffix |
  fbin_suffix |
  fdec_suffix |
  xbin_suffix |
  xdec_suffix |
  posit_suffix |
  bfloat_suffix;

sign = "-" | "+";

non_decimal_value ($prefix, $base) =
  $prefix, {$base | "_"}, $base,
  [".", $base, {$base | "_"}],
  ["p", [sign], {digit}-]

numeric_literal =
  [sign],
  (
    non_decimal_value("0b", binary) |
    non_decimal_value("0o", octal) |
    non_decimal_value("0x", hex) |
    (
      digit, {
        (*
          Multiplier prefixes allow to
          have multiple radix points.
        *)
        ["."], digit,

        (* The prefix families must not be mixed. *)
        {digit | "_" | multiplier_prefix_iec | multiplier_prefix_si}
      },
      ["e", [sign], {digit}-]
    )
  ),
  {"_"},
  [literal_suffix];</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Underscores may be used to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Split literal numeric representation into chunks (<code>1_000_000</code>);</p>
</li>
<li>
<p>Split literal value and suffix parts (<code>1_f</code>);</p>
</li>
<li>
<p>Split literal numeric representation and exponent prefix parts (<code>1_M</code>);</p>
</li>
<li>
<p>Split literal exponent prefix and suffix parts (<code>1M_i</code>);</p>
</li>
<li>
<p>Designate an absence of suffix (<code>1z_</code>).</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A recommended chunk size should be preserved when applying underscores (e.g. <code>10_000_00</code> is confusing).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Numeric literals always have big-endian representation, i.e. most significant bits of data come first.
For example, <code>0x2a == 0x002a == 0b101010 == 0b0010_1010 == 42</code>.</p>
</div>
<div class="paragraph">
<p>TODO: Applying an exponent (<code>e</code> for decimal, <code>p</code> for other bases) makes a literal fractional. However, it still can be forced to be integral, if is allowed to.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Regardless of the literal representation endianess, the actual memory layout of a numeric value in runtime may be defined elsewhere.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Only the decimal base may be used for floating and fixed decimal literals.</p>
</div>
<div class="paragraph">
<p>TODO: Which bases and literals allow signs?</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Numeric literal bases summary</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Base prefix</th>
<th class="tableblock halign-left valign-top">Base</th>
<th class="tableblock halign-left valign-top">Recommended chunk size</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 (<a href="https://en.wikipedia.org/wiki/Nibble">nibble</a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0b1100_0001</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0o</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Octal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0o777_001</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Decimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 (a thousand)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>42_000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hexadecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xab_CD</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In decimal literals, <code>e</code> is used to denote a decimal <strong>e</strong>xponent (<code>* 10 <strong> e</code>).
In literals with other bases, <code>p</code> is used to denote a binary exponent, i.e. </strong>p<strong>ower of two (<code>* 2 </strong> p</code>).
An omitted exponent defaults to 0 (<code>* 2 <strong> 0</code> or <code>* 10 </strong> 0</code>, which is always <code>* 1</code>).</p>
</div>
<div class="paragraph">
<p>TODO: Non-decimal literals can be used for any number.
Rules are the same:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">0x10.1 == 16 + (1 * 16 ** -1) == 16.0625
0b10000.0001 = 16 + (1 * 2 ** -4) = 16.0625
0o20.04 = 16 + (4 * 8 ** -2) = 16.0625

0b101010f == 0b101010.0f
# , thus non-decimal literals are sometimes not exact representations.</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <em>integral literal</em> can be restricted to an integer type.</p>
</div>
<div class="paragraph">
<p>A <em>likely-fractional literal</em> still can be restricted to an integer type, but defaults to a non-integer type, e.g. <code>2e2 : SInt32</code> would be <code>FBin64</code> by default.
A likely-fractional literal can be turned into integral by applying an integral suffix, e.g. <code>2e2i</code> would be <code>SInt32</code> by default.</p>
</div>
<div class="paragraph">
<p>A <em>fractional literal</em> can not be restricted to an integer type, e.g. <code>2e-2 : FBin64</code>.</p>
</div>
<div class="paragraph">
<p>A literal with big multiplier prefixes (including multiplier radix points) and/or positive exponents is likely-fractional.</p>
</div>
<div class="paragraph">
<p>A literal with at least one small multipler prefix, or negative exponent, or fractional radix point; is fractional.</p>
</div>
<div class="sect4">
<h5 id="literal-multiplier-prefixes"><a class="link" href="#literal-multiplier-prefixes">Multiplier prefixes</a></h5>
<div class="paragraph">
<p>Numeric literals support both binary (<a href="https://en.wikipedia.org/wiki/Kibibyte">IEC</a>) and decimal (<a href="https://en.wikipedia.org/wiki/Metric_prefix#List_of_SI_prefixes">SI</a>) multiplier prefixes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>big</em> multiplier prefix</dt>
<dd>
<p>One having a positive exponent.</p>
</dd>
<dt class="hdlist1"><em>small</em> multiplier prefix</dt>
<dd>
<p>One having a negative exponent.</p>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Binary multiplier prefixes (IEC)</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Prefix</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Multiplier</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">Big prefixes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Yi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yobi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024⁸</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Zi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zebi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024⁷</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Ei</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024⁶</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Pi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pebi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024⁵</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Ti</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tebi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024⁴</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Gi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gibi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024³</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Mi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mebi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024²</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Ki</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kibi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024¹</p></td>
</tr>
</tbody>
</table>
<table id="literal-multiplier-prefixes-si" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Decimal multiplier prefixes (SI)</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Prefix</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Multiplier</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">Big prefixes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yotta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10²⁴</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Z</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zetta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10²¹</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10¹⁸</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>P</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Peta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10¹⁵</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tera</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10¹²</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>G</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Giga</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁹</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>M</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mega</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁶</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>k</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kilo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10³</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>h</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hecto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10²</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>da</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deca</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10¹</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">Small prefixes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deci</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻¹</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Centi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻²</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>m</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Milli</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻³</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>u, μ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Micro</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻⁶</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>n</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nano</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻⁹</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>p</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pico</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻¹²</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Femto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻¹⁵</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Atto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻¹⁸</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>z</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zepto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻²¹</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yocto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10⁻²⁴</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Multiplier prefixes are case-sensitive.</p>
</div>
<div class="paragraph">
<p>Multiplier prefixes can only be used in decimal-based literals.</p>
</div>
<div class="paragraph">
<p>Multiplier prefixes from different standards must not be mixed, i.e. no binary and decimal prefixes in a single literal.</p>
</div>
<div class="paragraph">
<p>Multiplier prefixes from the same standard may be mixed in a single literal.</p>
</div>
<div id="multiplier-prefix-order" class="paragraph">
<p>Multiple multiplier prefixes in a single literal must be in the same order as defined in the tables below.
For example, <code>10M300k == 10300000</code> is valid, but <code>300k10M</code> is not, because <code>M</code> precedes <code>k</code> in <a href="#literal-multiplier-prefixes-si">Table 9, &#8220;Decimal multiplier prefixes (SI)&#8221;</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to the <a href="#literal-suffix-priority">suffix priority</a> in literals, it may be desirable to split value and kind with an underscore for readability, e.g. <code>1Mi_i</code> and <code>1M_i</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. Readability of suffixes in literals</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">0xff64 == 0xf_f64 ~= 15.0
0xff64f64 == 0xff64_f64 ~= 65380.0

42d == 42_d32   # Simply "FDec"
42dd == 4.2_d32 # "Deci" + "FDec"

1Mii == 1_048_576‬_i32 # "Mebi" + "SInt"
1Mi == 1_000_000_i32  # "Mega" + "SInt"</code></pre>
</div>
</div>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_integer_literals"><a class="link" href="#_integer_literals">Integer literals</a></h5>
<div class="paragraph">
<p>An unconstrained integral literal default type is <code>SInt32</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_floating_point_literals"><a class="link" href="#_floating_point_literals">Floating-point literals</a></h5>
<div class="paragraph">
<p>An unconstrained likely-fractional and fractional literal default type is <code>FBin64</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="xbin-literals"><a class="link" href="#xbin-literals">Binary fixed-point literals</a></h5>
<div class="listingblock">
<div class="title">Listing 18. Q number literal suffix syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">(* For consistency, it is still
  referenced as "`XBin` suffix". *)
xbin_suffix =
  (* An optional signedness. *)
  ["s" | "u"],

  (* The binary fixed-point (a.k.a.
    Q number) literal symbol. *)
  "Q",

  (* An optional bitsize. *)
  {digit},

  (* An optional Fractional part size in bits. Can also
    be read as an amount of bits to left-shiFt by. *)
  ["f", [sign], {digit}-];</code></pre>
</div>
</div>
<div class="paragraph">
<p>xcite::term-q-number[]</p>
</div>
<div class="paragraph">
<p>A Q number literal is signed by default.</p>
</div>
<div class="paragraph">
<p>A Q number literal value may be in any base, contain optional multiplier prefixes, optional exponent and optional fractional radix point.</p>
</div>
<div class="paragraph">
<p>Either bitsize or _f_ractional part size is required in a Q number literal.
If bitsize is omitted, the nearest greater or equal byte size is inferred, e.g. <code>0Qe10 == 0Q16e10</code>, <code>0Qe-5 == 0Q8e-5</code>, <code>0Qe8 == 0Q16e8</code>.
If fractional part size is omitted, it equals to the bitsize minus one bit if signed, e.g. <code>0Q8 == 0Q8e7</code>, <code>0uQ8 == 0uQ8e8</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Q number literals</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">1Qf-8 == 2 ** 8 == 256

0.625uQ8 + 0.0078125uQ8 ==
  0b0.101uQ8 + 0b0.0000001uQ8 =
  0b0.10100001uQ8 == 0.6328125d

#   1010 0000
# + 0000 0010
# = 1010 0010

# In signed Q numbers, the most
# significant bit is the sign bit,
# if the implementation is 2's complement.
#
# TODO: Come up with a valid example.
#

-0.625Q8 + 0.0078125Q8 ==
  -0b0.101Q8e7 + 0b0.0000001Q8e7 =
  -0b0.10110010Q8 == −0.60546875d

#   1011 0000
# + 0000 0010
# = 1011 0010</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="xdec-literals"><a class="link" href="#xdec-literals">Decimal fixed-point literals</a></h5>
<div class="listingblock">
<div class="title">Listing 19. Decimal fixed-point literal syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">xdec_suffix =
  (* An optional signedness. *)
  ["s" | "u"],

  (* The decimal fixed-point literal symbol. *)
  "D",

  (* An optional total amount of digits. *)
  {digit},

  (* An optional amount of digits which are fractional. *)
  ["f", {digit}-];</code></pre>
</div>
</div>
<div class="paragraph">
<p>A decimal fixed-point literal can only be in decimal base.</p>
</div>
<div class="paragraph">
<p>A decimal fixed-point literal is signed by default.</p>
</div>
<div class="paragraph">
<p>A decimal fixed-point literal requires either total amount of digits or amount of digits which are fractional, or both, set.
In case if only the total amount is set, the fractional amount is deemed to be zero.
In case if only the fractional amount is set, the total amount is deemed to be equal to the fractional.</p>
</div>
<div class="paragraph">
<p>xcite::dpd-bitsize-omitted[]</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_text_literals"><a class="link" href="#_text_literals">17.4.2. Text literals</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Abstract character</dt>
<dd>
<p>A character from the Unicode character set, which may consist of one or many codepoints.</p>
</dd>
<dt class="hdlist1">Source-encoded abstract character</dt>
<dd>
<p>An abstract character encoded in the source file encoding, for example ⟨a⟩ encoded as <code>a</code> (U+0061); ⟨å⟩ encoded as <code>å</code> (U+61, U+030A) or <code>å</code> (U+00E5).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A text literal is a sequence of abstract characters which are either source-encoded or made up from <a href="#_numerical_codepoints">Section 17.4.2.1, &#8220;Numerical codepoints&#8221;</a>.</p>
</div>
<div class="paragraph">
<p>An abstract character is <a href="https://en.wikipedia.org/wiki/Unicode_equivalence#Normalization">normalized</a> upon parsing.
Then, the normalized abstract character is encoded into a single codepoint or a sequence of codepoints in the encoding the literal is constrained to, i.e. the target encoding, with preference given to a variant comprised of a lesser amount of codepoints.
When the target encoding supports multiple codepoint sequences for a single abstract character representation, and a specific sequence variant is desired, <a href="#_numerical_codepoints">numerical codepoints</a> shall be used instead of source-encoded abstract characters.
If the target encoding does not support the abstract character at all, a compiler panics.</p>
</div>
<div class="paragraph">
<p>The standard defined a number of escaped abstract character sequences consisting of a backslash (<code>\</code>, U+005C) followed by a single Latin letter, which expand to a predefined abstract character.</p>
</div>
<table id="escape-sequences-in-text-literals" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Escaped abstract character sequences</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sequence</th>
<th class="tableblock halign-left valign-top">Character</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+0007</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alert (Beep, Bell)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+0008</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backspace</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+001B</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Escape character</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+000C</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Formfeed Page Break</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\n</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+000A</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Line Feed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\r</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+000D</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Carriage Return</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+0009</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Horizontal Tab</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\v</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+000B</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vertical Tab</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>U+0020</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whitespace</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\⏎</code> (escaped newline in source file)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignores the newline</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following normalization scenarios are possible, yet to discuss.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Forced normalization.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>A combined grapheme is always attempted to be normalized, even if the target encoding supports the combination.</p>
</div>
<div class="paragraph">
<p>Pros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Abstract characters are always encoded in the most compact way.</p>
</li>
<li>
<p>If a editor displays a combined grapheme as a single glyph, then it would be natural to think of it as of a single codepoint in the target encoding.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A editor may display a combined grapheme as two distinct glyphs, and it would be confusing to think of it as of a single codepoint in the target encoding.</p>
</li>
<li>
<p>A developer must always keep Unicode normalization rules in mind.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Normalization on-demand.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>If a combined grapheme is directly supported by the target encoding, it is used.
Othwerise, if the target encoding supports a normalized grapheme variant only, it is used instead.</p>
</div>
<div class="paragraph">
<p>Pros:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The mapping stays as close to the source as possible, making use of suitable alternative grapheme representations only when required.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Even if a target encoding supports the normalized variant, and a editor displays it as a single glyph; the resulting grapheme would still be combined.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>No normalization at all.
If target encoding does not support this exact combination, it would panic.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_numerical_codepoints"><a class="link" href="#_numerical_codepoints">Numerical codepoints</a></h5>
<div class="paragraph">
<p>A numerical codepoint is a codepoint encoded as an explicit numerical value, e.g. ⟨f⟩ encoded as <code>\102</code>.</p>
</div>
<div class="paragraph">
<p>A numerical codepoint may be in either octal (<code>\o141</code>), decimal (<code>\96</code>) or hexadecimal (<code>\x61</code>) base.
In either base, regardless of the literal&#8217;s encoding, the numerical value has big endianess, for example <code>ф</code> is encoded as <code>\x84d1</code>.</p>
</div>
<div class="paragraph">
<p>A numerical codepoint may map to an invalid (i.e. not defined in) abstract character in the literal&#8217;s charset, but its bitsize must not exceed the maximum allowed by the charset.
For example, <code>'\xffffffffffffffff'</code> would trigger panic for the most of the possible charsets, because no charset defines 64 bits as its codepoint&#8217;s size.</p>
</div>
<div class="paragraph">
<p>A numerical codepoint value may be wrapped in curly brackets to clearly define its boundaries.
For example, <code>"{97}1" == "a1"</code>.
An unmatched bracket would trigger panic.</p>
</div>
<div class="paragraph">
<p>Without brackets, a numerical codepoint value is terminated either with a grapheme outside of the base&#8217;s allowed graphemes range, or at the end of the containing literal.
For example, in <code>"\97f" == "af"</code>, the numerical codepoint in decimal base is terminated with a non-decimal grapheme <code>f</code>.</p>
</div>
<div class="paragraph">
<p>Numerical codepoint values do not allow neither literal prefixes nor literal suffixes, for example <code>{1ki8}</code> would trigger panic.</p>
</div>
<div class="paragraph">
<p>Numerical codepoint values allow non-trailing underscores.</p>
</div>
<div class="listingblock">
<div class="title">Listing 20. Numerical codepoint syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">numerical_codepoint =
  ("\o", {octal, "_"}-, "_"-) |
  ("\o", "{", {octal, "_"}-, "_"-, "}") |

  ("\", {digit, "_"}-, "_"-) |
  ("\", "{", {digit, "_"}-, "_"-, "}") |

  ("\x", {hex, "_"}-, "_"-) |
  ("\x", "{", {hex, "_"}-, "_"-, "}");</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_character_literals"><a class="link" href="#_character_literals">Character literals</a></h5>
<div class="paragraph">
<p>A character literal is a text literal comprised of a single abstract character comprised of a single codepoint wrapped in single quotes (<code>'</code>), for example <code>'a' == '\97'</code>.</p>
</div>
<div class="paragraph">
<p>A character literal is considered a scalar literal.</p>
</div>
<div class="paragraph">
<p>An unconstrained character literal has type <code>Char&lt;UCS&gt;</code>.</p>
</div>
<div class="paragraph">
<p><code>UCS</code> is the language-defined default charset for a character literal.</p>
</div>
<div class="paragraph">
<p>A charset literal suffix is defined by applying the <code>@[LiteralSuffix]</code> annotation to a static functor constrained to a single <code>@(Char)</code> argument.
A charset suffix may be applied to a character literal, which alters the literal&#8217;s charset, for example <code>'a&#8217;ucs</code>.
Depending on the functor implementation, if the target charset does not contain the literal&#8217;s abstract character, a compiler should panic.</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Applying a charset suffix to a character literal</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">'a' == 'a'ucs : Char&lt;UCS&gt; # Default

@[LiteralSuffix(/(us)?ascii/, /iso646us/)]
namespace ISO646::US &lt;~ Charset&lt;7&gt;
  def (~@(Char)) ~@(Char&lt;self&gt;)
    # Basically, return the codepoint if it's less than 128.
    # Otherwise, panic!
  end
end

'a'ascii : Char&lt;ISO646::US&gt; # Another charset applied
# 'ф'ascii # Panic! `ISO646::US` does not contain this abstract character</code></pre>
</div>
</div>
</div>
</div>
<div id="character-literal-integral-suffix" class="paragraph">
<p>A character literal may have an integral literal suffix, which would constrain it to an integral literal of kind defined by the suffix equal to the codepoint&#8217;s numerical value.
For example, <code>'a&#8217;u8 == 97u8</code>, <code>'豈&#8217;i16 == (0xF900)i16 == -1792i16</code>.</p>
</div>
<div class="listingblock">
<div class="title">Listing 21. Character literal syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">character_literal = "'", unicode | {numerical_codepoint}, "'";</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_string_literals"><a class="link" href="#_string_literals">String literals</a></h5>
<div class="paragraph">
<p>A string literal is a text literal comprised of an arbitrary amount (including zero) of abstract characters wrapped in double quotes (<code>"</code>) or slashes (<code>/</code>), for example <code>"f"</code>, <code>"å\0"</code>, <code>/bar/</code>.</p>
</div>
<div class="paragraph">
<p>A string literal is considered a scalar literal.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The NUL character is NOT appended implicitly to a string literal.
Instead, it must be done manually.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A string literal has type <code>String&lt;E, Z&gt;</code>, where <code>Z</code> is the exact amount of codeunits in the literal, for example <code>"få\0" : String&lt;UTF8, 4&gt;</code>, <code>"foo"ucs2 : String&lt;UCS2, 6&gt;</code>.</p>
</div>
<div class="paragraph">
<p><code>UTF8</code> is the language-defined default encoding for a string literal.</p>
</div>
<div class="paragraph">
<p>An encoding literal suffix is defined by applying the <code>@[LiteralSuffix]</code> annotation to a static functor constrained to a single <code>@(String)</code> argument.
An encoding suffix may be applied to a string literal, which alters the literal&#8217;s encoding, for example <code>'a&#8217;utf8</code>.
Depending on the functor implementation, if the charset defined by the target encoding does not contain at least one abstract character from contained in the literal, a compiler should panic.</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Applying an encoding suffix to a string literal</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">"a" == "a"utf8 : String&lt;UTF8, 1&gt; # Default values

@[LiteralSuffix(/(us)?ascii/, /iso646us/)]
namespace ISO646::US &lt;~ Encoding&lt;self, 7&gt;
  def (~@(String)) ~@(String&lt;self&gt;)
    # Basically, build a string containing the same
    # codepoints while their values are less than 128.
    # Otherwise, panic!
  end
end

"a"ascii : String&lt;ISO646::US, 1&gt; # Another encoding applied
# "ф"ascii # Panic! `ISO646::US` does not contain this abstract character</code></pre>
</div>
</div>
</div>
</div>
<div id="string-literal-integral-suffix" class="paragraph">
<p>A string literal may have an integral suffix, which would constrain it to an array of integral literals of kind defined by the suffix equal to the numerical values of codeunits' making up the literal&#8217;s abstract characters.
If the type defined by the literal can not contain a codeunit value in the literal&#8217;s encoding, a compiler panics.
For example, <code>"aф"u8 == [0x61u8, 0xd1u8, 0x84u8] : UInt8[3]</code>.</p>
</div>
<div class="listingblock">
<div class="title">Listing 22. String literal syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">string_literal = "\"", {unicode | numerical_codepoint}, "\""
string_literal = "/", {unicode}, "/";</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_regex_literals"><a class="link" href="#_regex_literals">Regex literals</a></h6>
<div class="paragraph">
<p>A string literal wrapped in <code>//</code> is called a regex literal.</p>
</div>
<div class="paragraph">
<p>Neither of the <a href="#escape-sequences-in-text-literals">escape sequences</a> work in a regex literal, but <code>\/</code>.
Therefore, numerical codepoints are not usable in regex literals.</p>
</div>
</div>
<div class="sect5">
<h6 id="_heredocs"><a class="link" href="#_heredocs">Heredocs</a></h6>
<div class="paragraph">
<p>A heredoc is a string literal spanning through multiple lines.
It begins and terminates with the same sequence of ASCII characters.</p>
</div>
<div class="paragraph">
<p>A heredoc literal value (the text) must be wrapped in newlines.</p>
</div>
<div class="paragraph">
<p>A heredoc opening sequence may be wrapped in parentheses and optionally applied literal suffixes to.
Suffixes affect a heredoc literal in the same way as they would affect a simple string literal.</p>
</div>
<div class="paragraph">
<p>The first token of a heredoc terminating sequence must be the first non-control character in a source line.
Once the terminating sequence is matched, a compiler treates the heredoc literal as complete; it allows, for example, to call a method immediately after the terminating sequence, e.g. <code>SQL.upcase</code>.</p>
</div>
<div class="paragraph">
<p>A heredoc is aligned at the least indentation.
Escaping a newline (<code>\⏎</code>) may affect the least indentation.
The first line of a heredoc does not have a newline character prepended.
The last line of a heredoc does not have a newline character appended.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A good formatting practice is to always make the least indentation to align with the line containing the beginning heredoc sequence.
The terminating sequence should be placed on a new line.
Sequences should be in uppercase.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 28. Heredocs</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">assert(&lt;&lt;-SQL
SELECT foo
  FROM bar
SQL == "SELECT foo\n  FROM bar")

(
  # This is ill-formatted: the line containing `SELECT`
  # should be indented by four spaces instead of two.
  # Note that the indentation of the
  # terminating sequence does not matter.
  assert(&lt;&lt;-(sql)ascii
  SELECT foo
FROM bar
sql == "  SELECT foo\nFROM bar")
)

assert(&lt;&lt;-SQL

  SELECT
  FROM bar\
    WHERE SQL

SQL == "\nSELECT\nFROM bar  WHERE SQL\n"</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 23. Heredoc syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">(* NOTE: Opening and closing sequences must be equal! *)
heredoc =
  "&lt;&lt;-",
  (
    "(", seq(en | underscore), ")",
    {literal_suffix}
  ) | seq(en | underscore),
  nl,
  seq(unicode),
  nl,
  seq(en | underscore);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_symbol_literals"><a class="link" href="#_symbol_literals">17.4.3. Symbol literals</a></h4>
<div class="paragraph">
<p>For a type restriction <code>R</code>, a symbol literal may unambiguously match a type <code>T</code> satisfying the restriction <code>T ~ R</code>, whereas the symbol value matches the last element of full path identifier of <code>T</code> in accordance to the <a href="#symbol-literal-matching-algorithm">Symbol literal matching algorithm</a>.</p>
</div>
<div id="symbol-literal-matching-algorithm" class="paragraph">
<div class="title">Symbol literal matching algorithm</div>
<p>The algorithm is defined as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The exact value of a symbol is compared directly with the last part of every type path matching the expression, until equal.
If matched, success.</p>
</li>
<li>
<p>If the symbol value is not explicit:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The symbol value is lower-cased, any non-letter and non-digit abstract character is removed; this is called a normalized value.</p>
</li>
<li>
<p>Last parts of every type path to be compared with which is not an explicit identifier, is also normalized.</p>
</li>
<li>
<p>The normalized symbol value is compared with each normalized last part, until equal.
If matched, success.</p>
</li>
</ol>
</div>
</li>
<li>
<p>No match, thus failure.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If a symbol literal expands to a compile-time constant value, it may be then suffix-casted to another type, e.g. <code>(:max)u8 == 255u8</code>.</p>
</div>
<div class="paragraph">
<p>Symbols can only be used as literals and expand during compilation.
There is no built-in runtime <code>Symbol</code> type.</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Using symbols</div>
<div class="content">
<div class="paragraph">
<p>The following example demonstrates suffix-casting of a symbol literal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">assert((:max)u8 == UInt8::Max)
assert((:Min)i == SInt32::Min)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example demonstrates enum values lookup.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">enum Foo
  val Bar
  alias `Бар to Bar

  val Baz
end

def is_baz?(foo : Foo)
  # `Foo#==` expects `Foo`,
  # thus `:bar` properly
  # expands to `Foo::Bar`
  foo == :bar
end

# Using an explicit symbol value here
assert(not is_baz?(:`Бар))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example demonstrates symbol expansion in case branches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">struct A::B::C;

final var = Std@rand(42, C())

case var
when :int # Properly expands to `Int`, which is legal
  Std.out &lt;&lt; "Is int"
when :c # Expands to `A::B::C`
  Std.out &lt;&lt; "Is A::B::C"
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example demonstrates symbol ambiguity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">enum Foo
  val Bar
  val Baz
end

enum Qux
  val Bar
  val Quux
end

def is_bar?(e)
  e == :bar
end

# # It would go through every type matching
# # the restriction  (which is none), and panic
# # upon `Foo::Bar` vs. `Qux::Bar` ambiguity.
# assert(is_bar?(:bar)) # Panic!

# This works, because the specialization
# would have `e : Foo` restriction.
assert(is_bar?(Foo::Bar))

# # This would panic upon ambiguity between
# # `e == Foo::Bar` vs. `e == Qux::Bar`.
# assert(is_bar?(Std@rand(Foo::Bar, Qux::Bar))) # Panic!</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aggregate_literals"><a class="link" href="#_aggregate_literals">17.5. Aggregate literals</a></h3>
<div class="paragraph">
<p>TODO: Restrictions with aggregate types? <code>~ \(Array)</code>, <code>~ \(Array&lt;Size&gt;)</code>.</p>
</div>
<div class="paragraph">
<p>The generic argument determining the element type of the type an aggregate literal is constrained to is inferred to a variant of the literal&#8217;s values' types.
If an aggregate literal consists of likely-fractional and fractional literals, then the element type is inferred to be a fractional type.</p>
</div>
<div class="paragraph">
<p>For a tuple literal, the type is inferred for each element separately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">[1, 1] : SInt32[2]
[1i16, 1] : SInt16[2]
[1u, 1] : UInt32[2]
[1u, 1i] : ?&lt;UInt32, SInt32&gt;[2]
[1, 0.5] : FBin64[2]
[1, 0.5d32] : FDec32[2]
[1u, 0.5] : ?&lt;UInt32, FBin64&gt;[2]
[1u, 1f] : ?&lt;UInt8, FBin64&gt;[2]

[1, 1p32] : Posit32[2]
[1p, 1p32] : Posit32[2]

# [1, 1p32, 1u8] # Panic! Can not unambiguosly infer type
                 # of `1` -- must constrain explicitly
[1u, 1p32, 1u8] : ?&lt;Posit32, UInt8&gt;[2] # OK</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_array_literals"><a class="link" href="#_array_literals">17.5.1. Array literals</a></h4>
<div class="paragraph">
<p>An array literal is constrained to the <code>Array</code> type.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tensor_literals"><a class="link" href="#_tensor_literals">17.5.2. Tensor literals</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx"># r, l0 -- row
# c, l1 -- column

# It could work, because `(\SInt32)x2` is
# not allowed (must be a runtime type).
(SInt32)x4 : Vector&lt;SInt32, 4&gt; # (\i)x4
(FBin64)x4x4c : Matrix&lt;FBin64, 4, 4, 0&gt; # (\f)x4x4c
($double)x2x3x4l2 : Tensor&lt;$double, 2, 3, 4, 2&gt; # (\$d)x2x2x4l2
(XDec&lt;2, 2&gt;)x2 # (\Df2)x2
(XBin8)x3      # (\Q8)x3</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tuple_literals"><a class="link" href="#_tuple_literals">17.5.3. Tuple literals</a></h4>

</div>
<div class="sect3">
<h4 id="_range_literals"><a class="link" href="#_range_literals">17.5.4. Range literals</a></h4>

</div>
</div>
<div class="sect2">
<h3 id="_magic_literals"><a class="link" href="#_magic_literals">17.6. Magic literals</a></h3>
<div class="openblock">
<div class="title">TODO:</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx"># Quoted string
#

%q(), %qucs2[], %qutf16le&lt;&gt;
%utf32be[] # Works if `utf32be` is unambiguously `Charcoding`

%qutf16-EOF
Hello
EOF

# Range
#

%r[1 2], %ri(min 0), %fr[2 5), %ru8(1 max]

# Containers
#

%i[1 2] # Array
%i&lt;1 2&gt; # Vector
%i(1 2) # Tuple, but why?
%i(foo: 1, bar: 2) # That's why
%i|[1 2]|r # Tensor (row-major); `|m0` -- ditto
%c[hi] # Array of chars
%casciiu8&lt;hi&gt; # Vector of chars
%ucs[hello] # Works if `ucs` is unambiguous `Charset`
%w[hello world], %wutf16le(a b) # OK</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Magic literals is a unified syntax for:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Array, tuple and vector container literals, allowing:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To apply literal suffixes on the container itself instead of on each of its elements;</p>
</li>
<li>
<p>To avoid repeated typing of separating commas.</p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#_quoted_string_literals">Section 17.6.2, &#8220;Quoted string literals&#8221;</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A magic literal requires at least one literal suffix to be specified.</p>
</div>
<div class="paragraph">
<p>A magic literal which is a character container literal or a quoted string literal is a <em>magic text literal</em>.</p>
</div>
<div class="paragraph">
<p>Elements within a magic literal are separated by spaces, unless it is a magic text literal.
In a magic text literal, every character is meaningful, including spaces.</p>
</div>
<div class="paragraph">
<p>Outside of a magic text literal, a sequence of non-digit characters is considered a symbol literal (assuming that <code>:</code> is omitted).</p>
</div>
<div class="listingblock">
<div class="title">Listing 24. Magic literal syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">magic_literal_values =
  [
    literal_value,
    {" ", literal_value}
  ];

magic_tuple_literal =
  "(", magic_literal_values, ")";

magic_array_literal =
  "[", magic_literal_values, "]";

magic_vector_literal =
  "&lt;", magic_literal_values, "&gt;";

magic_tensor_literal =
  "|", magic_literal_values, "|",
  [tensor_literal_dimension_appendix];

(* If literal suffixes are missing, the container
  type is inferred from its values. *)
magic_literal =
  "%",
  {literal_suffix}-,
  (
    magic_tuple_literal |
    magic_array_literal |
    magic_vector_literal |
    magic_tensor_literal
  );</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_word_literals"><a class="link" href="#_word_literals">17.6.1. Word literals</a></h4>
<div class="paragraph">
<p>A magic literal allows special <code>w</code> and <code>*w</code> major suffixes.
Either turns the literal into a container of space-separated strings, i.e. <strong>w</strong>ords.
The <code>*w</code> variant expands to a container of hard string copies instead of pointers to strings.</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Word literals</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">assert(%wutf8(foo barbaz) ==
  ("foo", "barbaz") :
  Tuple&lt;
    String&lt;UTF8, 3&gt;*s,
    String&lt;UTF8, 6&gt;*s
  &gt;)

assert(%*w[foo barbaz] ==
  [*"foo", *"barbaz"] :
  Variant&lt;
    String&lt;UTF8, 3&gt;,
    String&lt;UTF8, 6&gt;
  &gt;[2])</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_quoted_string_literals"><a class="link" href="#_quoted_string_literals">17.6.2. Quoted string literals</a></h4>
<div class="paragraph">
<p>A <strong>q</strong>oted string literal begins with the <code>q</code> suffix.
In a quoted string literal brackets act as the string quotes.</p>
</div>
<div class="exampleblock">
<div class="title">Example 31. Quoted string literals</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">assert(%qutf8["foo"] == %q("foo") == "\"foo\"")</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interoperability"><a class="link" href="#_interoperability">18. Interoperability</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Onyx provides native means of interoperability with the <a href="https://en.wikipedia.org/wiki/C_(programming_language)">C programming language</a>.</p>
</div>
<div class="paragraph">
<p>TODO: An alternative would be to process C macro output, and if it&#8217;s a constant, update it accordingly.
So it&#8217;s like <code>foo($SOME_MACRO)</code> &#8658; <code>foo($('a'))</code>.
Panic if got a non-constant C expression.</p>
</div>
<div class="paragraph">
<p>In this section, C terms may use <em class="small">smaller italic script</em>; C keywords and types may use <span class="small"><code>smaller monoscript</code></span>.
For example, Onyx struct is different from C <span class="small"><em>struct</em></span>, and Onyx <code>const</code> is different from C <span class="small"><code>const</code></span>.</p>
</div>
<div class="sect2">
<h3 id="c-standard"><a class="link" href="#c-standard">18.1. C standard</a></h3>
<div class="paragraph">
<p>Onyx supports <a href="#importing">Section 18.2, &#8220;Importing&#8221;</a> and <a href="#exporting">Section 18.3, &#8220;Exporting&#8221;</a> a subset of C entities in accordance to <a href="https://www.iso.org/standard/74528.html">ISO/IEC 9899:2018</a> a.k.a. <a href="https://en.wikipedia.org/wiki/C18_(C_standard_revision)">C18</a>; herein <em>the C standard</em>.</p>
</div>
<div class="paragraph">
<p>An Onyx compiler MUST be able to compile imported and exported C code.</p>
</div>
<div class="paragraph">
<p>C features other than included in the C standard (e.g. a specific C compiler extension) are NOT required by the Onyx standard.</p>
</div>
</div>
<div class="sect2">
<h3 id="importing"><a class="link" href="#importing">18.2. Importing</a></h3>
<div class="paragraph">
<p>A C file may be imported using an <code>import</code> statement.</p>
</div>
<div class="listingblock">
<div class="title">Listing 25. The import statement syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">(*
  The `import` statement shares syntax and semantics
  with the `require statement`.

  The following statements are equivalent:

  ```
  # NOTE: `.h` is implicitly appended only if
  # a file missing its extension is not found
  import "foo", "bar" from "baz"

  import "foo.h", "bar.h" from "baz"
  import "baz/foo.h", "baz/bar.h"

  import "baz/foo.h"
  import "baz/bar.h"
  ```

  As with `require`, the order of importing matters.
*)
import = "import", path, {",", path}, ["from", path];</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>import</code> statement shares syntax and semantics with the <code>require</code> statement with the following differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instead of compilation-defined <em>require</em> paths it relies on <em>import</em> paths, possibly specified by passing an <code>-I</code> flag.</p>
</li>
<li>
<p>The default imported file extension is <code>.h</code> if missing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Akin to <code>require</code>, re-importing the same file at the same path multiple times is allowed, leading to an actual importing happening exactly once at the moment when the first <code>import</code> statement with the path is met.
Files with the same contents, but at different paths, are treated as distinct imports.</p>
</div>
<div class="paragraph">
<p>All <a href="#importing-variables">variable</a> declarations and definitions, <a href="#importing-functions">function</a> declarations and definitions, <a href="#importing-enums"><em class="small">enum</em></a> definitions, <a href="#importing-unions"><em class="small">union</em></a> declarations and definitions, <a href="#importing-structs"><em class="small">struct</em></a> declarations and definitions, <a href="#importing-typedefs"><em class="small">typedef</em></a> declarations with <em class="small">external linkage</em> and <a href="#importing-macros"><em class="small">preprocessor text macros</em></a> are imported from a C header into the Onyx scope.</p>
</div>
<div class="paragraph">
<p>A C entity declared outside of an imported C header, but availaible from within it (e.g. via a nested <span class="small"><code>#include</code></span> directive), is also imported.</p>
</div>
<div class="paragraph">
<p>An imported entity exists in the top-level Onyx namespace.</p>
</div>
<div class="paragraph">
<p>An imported entity can be referenced from the Onyx scope by prepending <code>$</code> to its identifier, e.g. <code>$int</code>.
Akin to Onyx identifiers, wrapping backticks may be used to reference multi-word entities, e.g. <code>$`unsigned long`</code>.</p>
</div>
<div class="paragraph">
<p>The Macro API has means to access an imported entity information.</p>
</div>
<div class="sect3">
<h4 id="c-type-mapping"><a class="link" href="#c-type-mapping">18.2.1. Type mapping</a></h4>
<div class="paragraph">
<p>All C <em class="small">fundamental types</em> are interchangeable with Onyx types.</p>
</div>
<div class="paragraph">
<p>Some C <em class="small">fundamental types</em> may be target-dependent. For example, <span class="small"><code>int</code></span> could map at least to <code>SInt16</code> or <code>SInt32</code> depending on the target data layout model.</p>
</div>
<div class="paragraph">
<p>The following table defines mapping rules between C <em class="small">fundamental types</em> and Onyx types.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Mapping between C and Onyx fundamental types</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">C type</th>
<th class="tableblock halign-left valign-top">Onyx type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>void</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void : Void</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>char</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TODO: Same as either <span class="small"><code>signed char</code></span> or <span class="small"><code>unsigned char</code></span>, depending on what?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>_Bool</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TODO: <code>Bool : Bit</code> or target-dependent? How to determine exactly?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>signed char</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt8</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>unsigned char</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UInt8 : Byte</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>(signed) short (int)</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 16 bits, usually <code>SInt16</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>unsigned short (int)</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 16 bits, , usually <code>UInt16</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>(signed) (int)</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 16 bits, usually <code>SInt16</code> or <code>SInt32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>unsigned (int)</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 16 bits, usually <code>SInt16</code> or <code>SInt32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>(signed) long (int)</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 32 bits, usually <code>SInt32</code> or <code>SInt64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>unsigned long (int)</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 32 bits, usually <code>UInt32</code> or <code>UInt64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>(signed) long long (int)</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 64 bits, usually <code>SInt64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>unsigned long long (int)</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At least 64 bits, usually <code>UInt64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>float</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>double</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>long double</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FBin128</code> or target-dependent types, e.g. <code>X86::FBin80</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>float _Complex</code></span> etc.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Complex&lt;$float&gt;</code> etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>float _Imaginary</code></span> etc.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Imaginary&lt;$float&gt;</code> etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>_Atomic int</code></span> etc.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Atomic&lt;$int&gt;</code> etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>int b : N</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt&lt;N&gt;</code> or <code>UInt&lt;N&gt;</code> depending on implementation. TODO: How to make it consistent?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>signed (int) b : N</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SInt&lt;N&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>unsigned (int) b : N</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UInt&lt;N&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>_Bool b : 1</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UInt1 : Bool : Bit</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>type*</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$type*</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="importing-variables"><a class="link" href="#importing-variables">18.2.2. Importing variables</a></h4>
<div class="paragraph">
<p>All imported variables are available in the Onyx scope as static variables mapped in accordance to the <a href="#c-type-mapping">Section 18.2.1, &#8220;Type mapping&#8221;</a> scheme.</p>
</div>
<div class="paragraph">
<p>An imported variable with <em class="small">const type qualifier</em> is a final and immutable (if applicable) variable in Onyx.</p>
</div>
<div class="paragraph">
<p>An imported variable with <em class="small">volatile type qualifier</em> is a <code>volatile</code> variable in Onyx.</p>
</div>
<div class="paragraph">
<p>The <em class="small">restrict type qualifier</em> is ignored by Onyx.</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. Importing a variable</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 26. variables.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">int i;
volatile const float j = 42;

struct point_t {
  int x, y;
};

struct point_t point;
const struct point_t cpoint = { 10, 20 };

char sa[] = "foo"; // The type is completed as `char[4]`
char* sb = "bar";

const char sc[] = "qux"; // The type is completed as `char[4]`
const char* sd = "kax";</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 27. main.nx</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">import "./variables.h"

@[Entry]
export void main () {
  assert($i is? $int)
  assert(&amp;$i is? $int*srw)
  assert($i == 0)

  assert($j is? $float)
  assert(&amp;$j is? $float*sr)
  assert($j == 42)
  assert({{ nx.c.j.is_volatile }})

  assert($point is? &lt;mut $point_t&gt;)
  assert(&amp;$point is? &lt;mut $point_t&gt;*srw)
  assert($point.x += 1 == 1)

  assert($cpoint is? &lt;const $point_t&gt;)
  assert(&amp;$cpoint is? $point_t*sr)
  assert($cpoint.y == 20)

  assert($sa is? &lt;mut $char[4]&gt;)
  assert(&amp;$sa is? &lt;mut $char[4]&gt;*srw)
  assert($sa == %c[foo], $sa[2] == 'o')

  assert($sb is? $char*srw)
  # assert($sb == "bar") # There is no such a guarantee
  assert((unsafe! $sb as String*sr)-&gt;eq?("bar"))

  assert($sc is? &lt;const $char[4]&gt;)
  assert(&amp;$sc is? $char[4]*sr)

  assert($sd is? $char*sr)
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="importing-functions"><a class="link" href="#importing-functions">18.2.3. Importing functions</a></h4>
<div class="paragraph">
<p>A function definition is compiled upon importing.</p>
</div>
<div class="paragraph">
<p>Calling an imported function is always unsafe.</p>
</div>
<div class="paragraph">
<p>An imported function argument can not be referenced by its name upon call.</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. Importing a function</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 28. functions.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// A function declaration.
int foo();

// A function definition.
int bar(int a, int b) {
  return a + b;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 29. main.nx</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">import "./functions.h"

@[Entry]
export void main () {
  # It's a linker's responsiblity to
  # ensure the symbol is actually defined
  unsafe! foo()

  # Calling an actual definition
  assert((unsafe! $bar(1, 2)) == 3)
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="importing-enums"><a class="link" href="#importing-enums">18.2.4. Importing enums</a></h4>
<div id="import-enum-as-macros" class="paragraph">
<p>Importing a <em class="small">enum</em> imports its values as <em class="small">macros</em>.</p>
</div>
<div class="paragraph">
<p>Imported <em class="small">enums</em> can not be reopened.</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. Importing a enum</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 30. enum.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">enum color_t { RED, GREEN = 2, BLUE };</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 31. main.nx</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">import "./enum.h"

@[Entry]
export void main () {
  final color = $GREEN # Would evaluate to literal `2`, hence `$int`
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="importing-unions"><a class="link" href="#importing-unions">18.2.5. Importing unions</a></h4>
<div class="paragraph">
<p>An imported <em class="small">union</em> may be initialized using the C <em class="small">struct initializer</em>.</p>
</div>
<div class="paragraph">
<p>Accessing an imported <em class="small">union&#8217;s</em> member is always unsafe.</p>
</div>
<div class="paragraph">
<p>Imported <em class="small">unions</em> can not be reopened.</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. Importing a union</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 32. union.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">union union_t {
  int a;
  double b;
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 33. main.nx</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">import "./union.h"

@[Entry]
export void main () {
  final union = $union_t{ .a = 42 }
  assert(unsafe! union.a == 42) catch return 1
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="importing-structs"><a class="link" href="#importing-structs">18.2.6. Importing structs</a></h4>
<div class="paragraph">
<p>An imported <em class="small">struct</em> may be initialized using the C <em class="small">struct initializer</em>.</p>
</div>
<div class="paragraph">
<p>Accessing a <em class="small">non-atomic</em> member of a <em class="small">non-atomic</em> imported <em class="small">struct</em> is fragile.
Accessing an <em class="small">atomic</em> member of a <em class="small">non-atomic</em> imported <em class="small">struct</em> is threadsafe.
Accessing a member of an <em class="small">atomic struct</em> is unsafe.
Accessing a member of a <em class="small">volatile struct</em> is volatile.</p>
</div>
<div class="paragraph">
<p>Mutability modifers are applicable to imported <em class="small">structs</em>.
By default, an imported <em class="small">struct</em> type is implicitly <code>const</code>.</p>
</div>
<div class="paragraph">
<p>Imported <em class="small">structs</em> can not be reopened.</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. Importing a struct</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 34. struct.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">struct struct_t {
  int a;
  double b;
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 35. main.nx</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">import "./struct.h"

@[Entry]
export void main () {
  final strukt = mut $struct_t{ .a = 42, .b = 0.5 }
  assert((strukt.a += 1) == 43) catch return 1
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="importing-typedefs"><a class="link" href="#importing-typedefs">18.2.7. Importing typedefs</a></h4>
<div class="paragraph">
<p>Referencing an imported <em class="small">typedef</em> is the same as referencing the type it <em class="small">aliases</em>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 37. Importing typedefs</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 36. typedef.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">typedef struct { double hi, lo; } range;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 37. main.nx</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">import "./typedef.h"

@[Entry]
export void main () {
  final range = $range {
    .hi = 0, .lo = 1 }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="importing-macros"><a class="link" href="#importing-macros">18.2.8. Importing preprocessor macros</a></h4>
<div class="paragraph">
<p>An imported <em class="small">preprocessor text macro</em> (hereby <em class="small">macro</em>) may be referenced from the Onyx scope as a regular C entity by prepending the <code>$</code> symbol to its identifier.</p>
</div>
<div class="paragraph">
<p>An imported <em class="small">macro</em> reference allows arguments to be passed to it.
It is a error to use parentheses on an <em class="small">object-like macro</em>.</p>
</div>
<div class="paragraph">
<p>Once referenced, a <em class="small">macro</em> is immediately <em class="small">evaluated</em> in accordance to the <a href="#c-standard">Section 18.1, &#8220;C standard&#8221;</a>.
The evaluation result is then embedded directly into the source code.</p>
</div>
<div class="paragraph">
<p>Therefore, the concept of safety is not applicable to a <em class="small">macro</em> reference itself.
Instead, code generated by its evaluation is a subject to safety judgement.</p>
</div>
<div class="paragraph">
<p>Imported <em class="small">macros</em> are also available from the Macro API.</p>
</div>
<div class="exampleblock">
<div class="title">Example 38. Importing macros</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 38. macros.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#define FOO "foo"
#define DOUBLE(arg) #arg * 2</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 39. main.nx</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">import "./macros"

@[Entry]
export void main () {
  assert($FOO == "foo")
  assert($DOUBLE(2) == 4)
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="exporting"><a class="link" href="#exporting">18.3. Exporting</a></h3>
<div class="paragraph">
<p>A C declaration, definition, <em class="small">preprocessor directive</em> or a block of C code may be exported using an <code>export</code> statement.</p>
</div>
<div class="paragraph">
<p>An exported entity is available in the assembly code iff it has <em class="small">external linkage</em>.</p>
</div>
<div class="paragraph">
<p>After a entity is exported, it is then treated in the same way as if it was <a href="#importing">imported</a> from a header.</p>
</div>
<div class="paragraph">
<p><a href="#exporting-functions">Exported functions</a> are compiled as soon as they&#8217;re met by an Onyx compiler.</p>
</div>
<div class="paragraph">
<p>Exported entities have their identifiers <a href="https://en.wikipedia.org/wiki/Name_mangling">unmangled</a>.</p>
</div>
<div class="paragraph">
<p>Exporting from within an Onyx namespace does not alter a entity&#8217;s identifier in any way.</p>
</div>
<div class="paragraph">
<p>An <code>export</code> statement contents may be preprocessed with Onyx macros.</p>
</div>
<div class="paragraph">
<p>Onyx annotations are applicable to <code>export</code> statements.</p>
</div>
<div class="paragraph">
<p>A non-block version of the <code>export</code> statement is terminated in accordance to the rules defined by the <a href="#c-standard">Section 18.1, &#8220;C standard&#8221;</a>.
For instance, a <em class="small">struct</em> definition must be terminated with a semicolon, but a function definition does not have to.
A <em class="small">preprocessor directive</em> is terminated with a newline unless it (the newline) is preceded by a backslash.</p>
</div>
<div class="paragraph">
<p>An exported block of code is enclosed in curly brackets and does not require a semicolon.</p>
</div>
<div class="listingblock">
<div class="title">Listing 40. The <code>export</code> statement syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">c = (? Raw C code ?)

c_var_decl = (? A C variable declaration ?);
c_var_def = (? A C variable definition ?);
c_struct_decl = (? A C struct declaration ?);
c_struct_def = (? A C struct definition ?);
c_union_decl = (? A C union declaration ?);
c_union_def = (? A C union definition ?);
c_enum = (? A C enumeration definition ?);
c_typedef = (? A C typedef ?);
c_directive = (? A C preprocessor directive ?);

export = "export",
  (* An export statement may accept a raw block of C code... *)
  ("{", c, "}"),

  (* or a single C declaration or definition... *)
  c_var_decl |
  c_var_def |
  c_union_def |
  c_struct_def |
  c_union_decl |
  c_struct_decl |
  c_enum |
  c_typedef |
  c_directive |

  (* or a function definition with C prototype, but Onyx body *)
  nxc_function_def;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An Onyx compiler SHOULD provide a way to generate a C header file from source Onyx files, which MUST contain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Declarations of exported function definitions.</p>
</li>
<li>
<p>Raw contents of any other <code>export</code> statement.</p>
</li>
<li>
<p>Onyx comments <a href="#TODO:">related</a> to <code>export</code> statements, as inline C comments.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="exporting-functions"><a class="link" href="#exporting-functions">18.3.1. Exporting functions</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Exported C function</dt>
<dd>
<p>A function definition contained in a block of C code, i.e. in the block version of the <code>export</code> statement.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An exported C function is written in C and compiled by an Onyx compiler.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Exported Onyx function</dt>
<dd>
<p>A function definition immediately following the <code>export</code> keyword.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An exported Onyx function begins with a prototype written in C.
The prototype ends with an opening curly bracket.</p>
</div>
<div class="paragraph">
<p>An exported Onyx function body is written in Onyx.</p>
</div>
<div class="paragraph">
<p>An exported Onyx function is terminated by a closing curly bracket matching the one the prototype ended with.</p>
</div>
<div class="paragraph">
<p>An exported Onyx function body has fragile environment.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Calling an exported Onyx function is always unsafe for consistency reasons.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If an exported Onyx function is within an Onyx namespace, Onyx lookup rules are still applicable within its body.</p>
</div>
<div class="paragraph">
<p>An exported Onyx function arguments are accessible within its body in accordance to the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Exported Onyx function argument mapping</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">C argument declaration</th>
<th class="tableblock halign-center valign-middle">Onyx argument declaration</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><span class="small"><code>T</code></span> is scalar (i.e. <em class="small">number</em> or <em class="small">union</em>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>T arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>let arg : T</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>const T arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>final arg : T</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>T* arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>let arg : T*urw</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>const T* arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>final arg : T*ur</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock"><span class="small"><code>T</code></span> is aggregate (i.e. <em class="small">array</em> or <em class="small">struct</em>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>T arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>let arg : mut T</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>const T arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>final arg : const T</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>T* arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>let arg : mut T*urw</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>const T* arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>final arg : const T*ur</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">Other</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>&#8230;&#8203;</code></span> (<em class="small">variadic function arguments</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accessible via <code>@varg</code> macro</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>volatile T arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>volatile let arg : T</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="small"><code>restrict T arg</code></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>let arg : T</code> (no effect)</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Listing 41. The exported Onyx function syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">c_proto = (? A C function prototype, e.g. `void main(void)` ?);
nxc_function_def = c_proto, "{", {expr}, "}";</code></pre>
</div>
</div>
<hr>
<div class="exampleblock">
<div class="title">Example 39. Exporting</div>
<div class="content">
<div class="listingblock">
<div class="title">Listing 42. main.nx</div>
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx"># This is an exported Onyx function.
@[Entry] # An Onyx annotation!
export void main() {
  # Onyx body
}

# Has a non-external linkage
export static _Alignas(8) const int i = 42;

# This comment is not going to be exported
# because it is not related to the statement

export struct struct_t {
  int a, b;
};

export #ifndef FOO
export #define FOO 42, \
                   43

export #endif

export {
  // All C comments would be exported
  // # Onyx comments aren't allowed here

  _Atomic _Alignas(double) int j;

  int k;

#define OUTPUT(arg) puts ( #arg );

  // This is an exported C function.
  static void foo () {
    // C code
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A possible variant of a generated C header:</p>
</div>
<div class="listingblock">
<div class="title">Listing 43. main.h</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This is an exported Onyx function.
void main();
static _Alignas(8) const int i = 42;
struct struct_t {
  int a, b;
};
#ifndef FOO
#define FOO 42, \
            43
#endif
  // All C comments would be exported
  // # Onyx comments aren't allowed here
  _Atomic _Alignas(double) int j;

  int k;

  #define OUTPUT(arg) puts ( #arg );

  // This is an exported C function.
  static void foo () {
    // C code
  }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compiled_syntax"><a class="link" href="#_compiled_syntax">Appendix A: Compiled Syntax</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following is the entire compiled Onyx language syntax.</p>
</div>
<div class="listingblock">
<div class="title">Listing 44. Onyx language syntax</div>
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">binary = "0" | "1";
octal = binary | "2" | "3" | "4" | "5" | "6" | "7" | "8";
digit = octal | "8" | "9";

(* Design rationale: hexadecimals are in upper-case to clearly
  distingusigh them from exponents and prefixes (`Q` and `D`
  are exceptions). Multiplier prefixes can not be used in
  hexadecimal literals, so they don't mix. *)
hex = digit | "A" | "B" | "C" | "D" | "E" | "F";

(* Any Unicode abstract character, including
  those consisting of multiple codepoints. *)
unicode = (? A Unicode character ?);

fragile_statement =
  "fragile!",
  expr | block();

unsafe_statement =
  "unsafe!",
  expr | block();

safety_modifier =
  "threadsafe" |
  "fragile" |
  "unsafe" |
  "undefsafe";

(* TODO: Move. *)
compl_mod =
  (* !keyword(mod) *) "compl" |
  (* !keyword(mod) *) "incompl";

reopen_statement =
  [compl_mod],

  (* !keyword(statement) *)
  "reopen",

  type_ref,
  ";" | block();

(* A unit type declaration. *)
unit =
  type_visibility_mod,

  (* !keyword(Unit type declaration) *)
  "unit",

  id,
  [generic_args_decl],

  ";" | block();

trait_decl =
  trait_decl_mod,
  ["decl"],
  "trait",
  id,
  [nb, generic_arguments_decl],
  ";" | body();

trait_decl_mod = [type_visibility_mod];

derive =
  ["undefstor" | "static" | "instance"],
  "derive",
  id,
  ";" | block();

require_directive =
  "require",

  @unord(
    (* Path(s) of the required file *)
    (["from"], path, {",", path}),

    (* The base path *)
    ["at", path]
  );

(*
  Import a file written possibly
  in a language other than Onyx.

  ```
  import from "stdio.h" in "C"
  import in "Rust" from "main.rs", "aux.rs" at "/mypath/"
  ```
*)
import_directive =
  "import",

  @unord(
    (* The source language of an imported file *)
    ("in", string),

    (* Paths to the imported files *)
    ("from", string, {",", string}),

    (* The base path for the imported files *)
    ["at", string]
  );

using =
  using_namespace |
  using_refinement |
  using_alias;

using_namespace =
  "using",
  ["namespace"],
  type_ref;

using_refinement =
  "using",
  ["refinement"],
  type_ref;

using_alias =
  "using",
  ["alias"],
  decl,
  ("=", "to"),
  ref;

multiplier_prefix_iec =
  "Yi" | "Zi" | "Ei" | "Pi" |
  "Ti" | "Gi" | "Mi" | "Ki";

multiplier_prefix_si =
  "Y" | "Z" | "E" | "P" | "T" | "G" | "M" | "k" | "h" | "da" |
  "d" | "c" | "m" | "u" | "μ" | "n" | "p" | "f" | "a" | "z" | "y";

sint_suffix = ["s"], "i", {digit}; (* 32 bits by default *)
uint_suffix = "u", ["i"], {digit}; (* 32 bits by default *)
size_suffix = ["s" | "u"], "z"; (* Unsigned by default *)

fbin_suffix = "f", ["b"], {digit}; (* 64 bits by default *)
fdec_suffix = ["f"], "d", {digit}; (* 64 bits by default *)

(*
  Design rationale: despite of the fact that `p` can only be in
  lowercase in Onyx, it'd be confusing to see `42P8` and treat it
  other than a "42 * 2 ** 8". Had to pick another symbol therefore.
*)
posit_suffix = "t", {digit};
posit_suffix = "p", {digit};

(*
  Design rationale: would not use `B`, because
  brain float is "smaller" than usual float.
*)
bfloat_suffix = "bf", {digit};

literal_suffix =
  sint_suffix |
  uint_suffix |
  size_suffix |
  fbin_suffix |
  fdec_suffix |
  xbin_suffix |
  xdec_suffix |
  posit_suffix |
  bfloat_suffix;

sign = "-" | "+";

non_decimal_value ($prefix, $base) =
  $prefix, {$base | "_"}, $base,
  [".", $base, {$base | "_"}],
  ["p", [sign], {digit}-]

numeric_literal =
  [sign],
  (
    non_decimal_value("0b", binary) |
    non_decimal_value("0o", octal) |
    non_decimal_value("0x", hex) |
    (
      digit, {
        (*
          Multiplier prefixes allow to
          have multiple radix points.
        *)
        ["."], digit,

        (* The prefix families must not be mixed. *)
        {digit | "_" | multiplier_prefix_iec | multiplier_prefix_si}
      },
      ["e", [sign], {digit}-]
    )
  ),
  {"_"},
  [literal_suffix];

(* For consistency, it is still
  referenced as "`XBin` suffix". *)
xbin_suffix =
  (* An optional signedness. *)
  ["s" | "u"],

  (* The binary fixed-point (a.k.a.
    Q number) literal symbol. *)
  "Q",

  (* An optional bitsize. *)
  {digit},

  (* An optional Fractional part size in bits. Can also
    be read as an amount of bits to left-shiFt by. *)
  ["f", [sign], {digit}-];

xdec_suffix =
  (* An optional signedness. *)
  ["s" | "u"],

  (* The decimal fixed-point literal symbol. *)
  "D",

  (* An optional total amount of digits. *)
  {digit},

  (* An optional amount of digits which are fractional. *)
  ["f", {digit}-];

numerical_codepoint =
  ("\o", {octal, "_"}-, "_"-) |
  ("\o", "{", {octal, "_"}-, "_"-, "}") |

  ("\", {digit, "_"}-, "_"-) |
  ("\", "{", {digit, "_"}-, "_"-, "}") |

  ("\x", {hex, "_"}-, "_"-) |
  ("\x", "{", {hex, "_"}-, "_"-, "}");

character_literal = "'", unicode | {numerical_codepoint}, "'";

string_literal = "\"", {unicode | numerical_codepoint}, "\""
string_literal = "/", {unicode}, "/";

(* NOTE: Opening and closing sequences must be equal! *)
heredoc =
  "&lt;&lt;-",
  (
    "(", seq(en | underscore), ")",
    {literal_suffix}
  ) | seq(en | underscore),
  nl,
  seq(unicode),
  nl,
  seq(en | underscore);

magic_literal_values =
  [
    literal_value,
    {" ", literal_value}
  ];

magic_tuple_literal =
  "(", magic_literal_values, ")";

magic_array_literal =
  "[", magic_literal_values, "]";

magic_vector_literal =
  "&lt;", magic_literal_values, "&gt;";

magic_tensor_literal =
  "|", magic_literal_values, "|",
  [tensor_literal_dimension_appendix];

(* If literal suffixes are missing, the container
  type is inferred from its values. *)
magic_literal =
  "%",
  {literal_suffix}-,
  (
    magic_tuple_literal |
    magic_array_literal |
    magic_vector_literal |
    magic_tensor_literal
  );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_optimization"><a class="link" href="#_optimization">Appendix B: Optimization</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Informative.</p>
</div>
<div class="paragraph">
<p>This section acts as a single source of expectations on when it is possible to rely on a compiler for certain optimizations rather than write optimized code manually.
This allows a user to write simpler code but be sure on that this code would be optimized.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nxapi"><a class="link" href="#_nxapi">Appendix C: NXAPI</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>An Onyx compiler is able to generate documentation for exported functions only in form of C headers.
C standard for header files is applied in such cases.</p>
</div>
<div class="paragraph">
<p>For Onyx language APIs, the current standard is applied, named NXAPI.</p>
</div>
<div class="paragraph">
<p>The NXAPI standard defines a schema to document entities declared in an Onyx program.
The standard also provides standards for common interchange formats, including binary, JSON, DSON, YAML, XML and TOML.</p>
</div>
<div class="paragraph">
<p>Herein "API" stays for Onyx language API if not mentioned another.</p>
</div>
<div class="paragraph">
<p>API documentation is intended to provide the exact information as in the source file.
Due to the inferring freedom of the Onyx language, it is often impossible to predetermine the conditions an API is going to be used in.</p>
</div>
<div class="paragraph">
<p>For example, a <code>Foo</code> type mentioned from within an API function arguments list could possibly mean another type if the namespace containing the functions gets an type also named <code>Foo</code> in a program-consumer of the API.
However, full path like <code>::Foo</code> is unambiguous and is considered a good practice.</p>
</div>
<div class="paragraph">
<p>Similarly, while it is possible to infer a function return type in the scope of the API, it (the return type) may turn out to be different when the API is used in a consumer program.
Therefore, library API authors are encouraged to provide concrete, unambiguous return types to their functions whenever possible.</p>
</div>
<div class="paragraph">
<p>In fact, Onyx compilers are expected to have some kind of a strict compilation mode, which would require concrete typing everywhere. {paper-noindex}</p>
</div>
<div class="paragraph">
<p>NXAPI schema includes documentation for namespaces, types, functions, annotations and macros.</p>
</div>
<div class="sect2">
<h3 id="_schema"><a class="link" href="#_schema">C.1. Schema</a></h3>
<div class="paragraph">
<p>NXAPI schema definition describes a set of available NXAPI nodes. {paper-excerpt=25,-1}</p>
</div>
<div class="paragraph">
<p>&lt;div class="toc" paper-noindex&gt;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{{ paper-toc }}</pre>
</div>
</div>
<div class="paragraph">
<p>&lt;/div&gt;</p>
</div>
</div>
<div class="sect2">
<h3 id="_structure"><a class="link" href="#_structure">C.2. Structure</a></h3>
<div class="paragraph">
<p>Each node in the schema definition has a <code>kind</code> value.
This value is used to determine the kind of a node in an NXAPI document.</p>
</div>
<div class="paragraph">
<p>In the schema definition, a node also has a set of <code>fields</code>, which defines the set of properties for the node.</p>
</div>
<div class="paragraph">
<p>The schema definition uses the DSON format for simplicity.</p>
</div>
<div class="paragraph">
<p>The implicit root object of a NXAPI document is the anonymous top-level namespace, therefore an NXAPI document is an array of the top-level namespace declarations.</p>
</div>
<div class="paragraph">
<p>Consider the following example: {paper-noindex}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson"># That is an actual NXAPI document
[
  {
    kind = namespace,    # Kind of this node is a namespace
    path = "::Foo::Bar", # A `path` field with some value
    declarations = []    # A `declaration` field with some values
  }
]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nodes"><a class="link" href="#_nodes">C.3. Nodes</a></h3>
<div class="paragraph">
<p>List of NXAPI nodes. {paper-excerpt=0,-1 paper-noindex}</p>
</div>
<div class="sect3">
<h4 id="_special_nodes"><a class="link" href="#_special_nodes">C.3.1. Special nodes</a></h4>
<div class="paragraph">
<p>There are some special nodes which can not be reasonably defined in the schema. {paper-excerpt=16,65 paper-noindex}</p>
</div>
<div class="paragraph">
<p>A <code>decl</code> node is one of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>[<code>namespace_decl</code>](#nxapi-namespace_decl){paper-link}; or</p>
</li>
<li>
<p>[<code>struct_decl</code>](#nxapi-struct_decl){paper-link}; or</p>
</li>
<li>
<p>[<code>var_decl</code>](#nxapi-var_decl){paper-link}; or</p>
</li>
<li>
<p>[<code>function_decl</code>](#nxapi-function_decl){paper-link}; or</p>
</li>
<li>
<p>[<code>annotation_decl</code>](#nxapi-annotation_decl){paper-link}; or</p>
</li>
<li>
<p>[<code>macro_decl</code>](#nxapi-macro_decl){paper-link}.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An <code>expr</code> node&#8230;&#8203;</p>
</div>
</div>
<div class="sect3">
<h4 id="_delayed_macro_expr"><a class="link" href="#_delayed_macro_expr">C.3.2. <code>delayed_macro_expr</code></a></h4>
<div class="paragraph">
<p>A delayed macro expression node could be used instead of any other node. {paper-excerpt=31}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = delayed_macro_expr,
  fields = [{
    name = expr,
    type = string,
    required = true
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_namespace_decl"><a class="link" href="#_namespace_decl">C.3.3. <code>namespace_decl</code></a></h4>
<div class="paragraph">
<p>A namespace declaration node contains its name and declarations. {paper-excerpt=28}</p>
</div>
<div class="paragraph">
<p>A namespace declaration can not be virtual.</p>
</div>
<div class="paragraph">
<p>Namespace and type declarations must have fully resolved paths, e.g. <code>::Foo::Bar</code>. {#nxapi-namespace-full-path}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = namespace_decl,
  fields = [{
    name = doc,
    type = string,
    required = false
  }, {
    name = path,
    type = string,
    required = true
  },{
    name = declarations,
    type = array&lt;decl&gt;,
    required = true # May be empty
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_var_decl"><a class="link" href="#_var_decl">C.3.4. <code>var_decl</code></a></h4>
<div class="paragraph">
<p>A variable declaration node may be virtual. {paper-excerpt=28}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = var_decl,
  fields = [{
    name = doc,
    type = string,
    required = false
  }, {
    name = virtual,
    type = bool,
    required = true
  }, {
    name = accessibility,
    type = enum&lt;let, get, set, final&gt;,
    required = true
  }, {
    name = storage,
    type = enum&lt;static, instance&gt;,
    required = undefined # Only applicable to struct variables
  }, {
    name = visibility,
    type = enum&lt;public, protected, private&gt;,
    required = false # Undefined if missing
  }, {
    name = name,
    type = string,
    required = true
  }, {
    name = restriction,
    type = type_ref,
    required = false
  }, {
    name = value,
    type = expr,
    required = false
  }, {
    name = annotations,
    type = array&lt;annotation_call&gt;,
    required = true # May be empty
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_function_decl"><a class="link" href="#_function_decl">C.3.5. <code>function_decl</code></a></h4>
<div class="paragraph">
<p>A function declaration node may be virtual. {paper-excerpt=27}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = function_decl,
  fields = [{
    name = doc,
    type = string,
    required = false,
  }, {
    name = virtual,
    type = bool,
    required = true,
  }, {
    name = implementation,
    type = enum&lt;decl, impl, def, redef&gt;,
    required = true,
  }, {
    name = storage,
    type = enum&lt;static, instance&gt;,
    required = undefined # Only applicable to trait,
                          # struct and enum functions
  }, {
    name = mutability,
    type = enum&lt;mut, const&gt;,
    required = false # Undefined if missing
  }, {
    name = visibility,
    type = enum&lt;public, protected, private&gt;,
    required = false # Undefined if missing
  }, {
    name = name,
    type = string,
    required = true
  }, {
    name = arguments,
    type = array&lt;arg_decl&gt;,
    required = true # May be empty
  }, {
    name = return,
    type = type_ref,
    required = false # Undefined if missing
  }, {
    name = annotations,
    type = array&lt;annotation_call&gt;,
    required = true # May be empty
  }, {
    name = foralls,

    # A function declaration may include multiple foralls, e.g.
    # `def foo(arg : T) forall T : List&lt;U&gt; forall U : Numeric`
    type = array&lt;array&lt;forall_element&gt;&gt;,

    required = true # May be empty
  }, {
    # An optional `where` macro expression,
    # e.g. `def foo() where \{{ expr }}`
    #

    name = where,
    type = delayed_macro_expr,
    required = false
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_forall_element"><a class="link" href="#_forall_element">C.3.6. <code>forall_element</code></a></h4>
<div class="paragraph">
<p>A <code>forall</code> element declaration, e.g. <code>forall T : U</code>. {paper-noindex}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = forall_element,
  fields = [{
    name = name,
    type = string,
    required = true
  }, {
    name = restriction,
    type = type_ref,
    required = false
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arg_decl"><a class="link" href="#_arg_decl">C.3.7. <code>arg_decl</code></a></h4>
<div class="paragraph">
<p>An argument declaration node. {paper-excerpt=0,-1 paper-noindex}</p>
</div>
<div class="paragraph">
<p>The semantics is shared for both function and generic type argument declarations, hence a single node. {#arg-shared-semantics}</p>
</div>
<div class="paragraph">
<p>TODO: Move these to main spec, and just reference from here.</p>
</div>
<div class="paragraph">
<p>Generic type arguments are always type-restricted, unlike function arguments which may be either instance- or type-restricted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">struct Int&lt;Bitsize: S :: %unum&gt;
  # `another` is instance-restricted.
  def add(another : T) forall T :: Int;

  # `target` is type-restricted.
  def to(target: :: T) forall T :: Int;
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = arg_decl,
  fields = [{
    name = doc,
    type = string,
    required = false
  }, {
    name = annotations,
    type = array&lt;annotation_call&gt;,
    required = true # May be empty
  }, {
    name = name,
    type = string,
    required = undefined # Must be absent if it is a
                         # `type_restricted` function argument
  }, {
    name = alias,
    type = string,
    required = false
  }, {
    # Determine whether is it a type-restricted argument,
    # e.g. `foo :: T`. A type-restricted argument must not have its
    # `restriction` field left empty and if it is a function argument,
    # it also can not have `name` field set.
    name = type_restricted,
    type = bool,
    required = true,
  }, {
    name = restriction,
    type = type_ref,
    required = undefined # Required only if it is
                         # a type-restricted argument
  }, {
    name = default_value,
    type = expr,
    required = false
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arg_pass"><a class="link" href="#_arg_pass">C.3.8. <code>arg_pass</code></a></h4>
<div class="paragraph">
<p>An argument node passed to a callee. {paper-excerpt=0,-1 paper-noindex}</p>
</div>
<div class="paragraph">
<p>Due to [the shared argument semantics](#arg-shared-semantics){paper-link} argument passing to a callee is defined as a single node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = arg_pass,
  fields = [{
    # An explicit name of an argument, e.g. `call(foo: bar)`
    name = explicit_name,
    type = string,
    required = undefined # Incompatible with `explicit_order`
  }, {
    # An explicit order of an argument, e.g. `call([0]: bar)`
    name = explicit_order,
    type = number,
    required = undefined # Incompatible with `explicit_name`
  }, {
    name = value,
    type = expr,
    required = true
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_type_expr"><a class="link" href="#_type_expr">C.3.9. <code>type_expr</code></a></h4>
<div class="paragraph">
<p>A valid type expression node. {paper-excerpt paper-noindex}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = type_expr,
  fields = [{
    name = expr,
    type = array&lt;variant&lt;type_expr_op, type_ref&gt;&gt;,
    required = true
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_type_expr_op"><a class="link" href="#_type_expr_op">C.3.10. <code>type_expr_op</code></a></h4>
<div class="paragraph">
<p>A type expression operator node. {paper-excerpt paper-noindex}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = type_expr_op,
  fields = [{
    name = op,

    # One of `(`, `)`, `&amp;`, `|`, `^` or `!`
    type = enum&lt;paren_open, paren_close, and, or, xor, not&gt;,

    required = true
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_type_ref"><a class="link" href="#_type_ref">C.3.11. <code>type_ref</code></a></h4>
<div class="paragraph">
<p>A reference to a type node. {paper-excerpt paper-noindex}</p>
</div>
<div class="paragraph">
<p>A type reference node <code>path</code> field may be unresolved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = type_ref,
  fields = [{
    name = path,
    type = string,
    required = true
  }, {
    name = generic_arguments,
    type = array&lt;arg_pass&gt;,
    required = true # May be empty
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_trait_decl"><a class="link" href="#_trait_decl">C.3.12. <code>trait_decl</code></a></h4>

</div>
<div class="sect3">
<h4 id="_struct_decl"><a class="link" href="#_struct_decl">C.3.13. <code>struct_decl</code></a></h4>
<div class="paragraph">
<p>A struct declaration node <code>name</code> field [must be a fully resolved path](#nxapi-namespace-full-path){paper-link}. {paper-excerpt="0,26,."}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = struct_decl,
  fields = [{
    name = doc,
    type = string,
    required = false
  }, {
    name = virtual,
    type = bool,
    required = true
  }, {
    name = path,
    type = string,
    required = true
  }, {
    name = mutability,
    type = enum&lt;mut, const&gt;,
    required = false # Undefined if missing
  }, {
    name = visibility,
    type = enum&lt;public, private&gt;,
    required = false # Undefined if missing
  }, {
    name = annotations,
    type = array&lt;annotation_call&gt;,
    required = true # May be empty
  }, {
    name = declarations,
    type = array&lt;decl&gt;,
    required = true # May be empty
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_enum_decl"><a class="link" href="#_enum_decl">C.3.14. <code>enum_decl</code></a></h4>
<div class="paragraph">
<p>A enum declaration node. {paper-excerpt paper-noindex}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = enum_decl,
  fields = [{
    name = statement,
    type = enum&lt;virtual, reopen, declare&gt;,
    required = true
  }, {
    name = is_flag,
    type = bool,
    required = true
  }, {
    name = doc,
    type = string,
    required = false
  }, {
    name = type,
    type = type_ref,
    required = undefined # Required if `is_flag`,
                         # otherwise `SInt32` if missing
  }, {
    name = values,
    type = array&lt;enum_val_decl&gt;,
    required = true # May be empty for virtual enums
  }, {
    name = declarations,
    type = array&lt;decl&gt;,
    required = true # May be empty
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_enum_val_decl"><a class="link" href="#_enum_val_decl">C.3.15. <code>enum_val_decl</code></a></h4>
<div class="paragraph">
<p>A enum value declaration node. {paper-excerpt paper-noindex}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = enum_val_decl,
  fields = [{
    name = doc,
    type = string,
    required = false
  }, {
    name = name,
    type = string,
    required = true
  }, {
    name = value,
    type = expr,
    required = false
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_annotation_decl"><a class="link" href="#_annotation_decl">C.3.16. <code>annotation_decl</code></a></h4>
<div class="paragraph">
<p>An annotation declaration node. {paper-noindex}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = annotation_decl,
  fields = [{
    name = is_virtual,
    type = bool,
    required = true
  }, {
    name = doc,
    type = string,
    required = false
  }, {
    name = path, # A fully resolved path
    type = string,
    required = true
  }, {
    name = arguments,
    type = array&lt;arg_decl&gt;,
    required = true # May be empty
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_annotation_call"><a class="link" href="#_annotation_call">C.3.17. <code>annotation_call</code></a></h4>
<div class="paragraph">
<p>An annotation call can not have any documentation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = annotation_call,
  fields = [{
    name = annotation,
    type = type_ref,
    required = true
  }, {
    name = arguments,
    type = array&lt;arg_pass&gt;,
    required = true # May be empty
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_intrinsic_decl"><a class="link" href="#_intrinsic_decl">C.3.18. <code>intrinsic_decl</code></a></h4>
<div class="paragraph">
<p>An intrinsic (i.e. <code>macro</code>) declaration node. {paper-excerpt paper-noindex}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = intrinsic_decl,
  fields = [{
    name = doc,
    type = string,
    required = false
  }, {
    name = annotations,
    type = array&lt;annotation_call&gt;,
    required = true # May be empty
  }, {
    name = is_virtual,
    type = bool,
    required = true
  }, {
    name = visibility,
    type = enum&lt;public, private&gt;,
    required = true
  }, {
    name = name,
    type = string, # Without `@`
    required = true
  }, {
    name = arguments,
    type = array&lt;argument_decl&gt;,
    required = true # May be empty
  }]
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_delayed_intrinsic_call"><a class="link" href="#_delayed_intrinsic_call">C.3.19. <code>delayed_intrinsic_call</code></a></h4>
<div class="paragraph">
<p>A delayed intrinsic call node may replace any non-declaration node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">{
  kind = delayed_intrinsic_call,
  fields = [{
    name = content,
    type = string,
    required = true
  }]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples_2"><a class="link" href="#_examples_2">C.4. Examples</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">require "io" from "std"

# This is the main function.
@[Entry]
def main
  @cout &lt;&lt; "Hello, world!"
end</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-dson" data-lang="dson">[{
  kind = function,
  implementation = def,
  name = main,
  documentation = "This is the main function."
  annotations = [{
    kind = annotation,
    type = Entry
  }]
}]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_api_2"><a class="link" href="#_core_api_2">Appendix D: Core API</a></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-nx" data-lang="nx">trait Core::Aggregate;

require "./aggregate.nx"

decl primitive Core::Array&lt;Type: T, Size ~ %z&gt;
  derive Core::Aggregate;

  # Return a reference to an element at *index*.
  decl def [](index: Size) : T&amp;ir(w: \mut?) throws Core::SizeError
end

require "./scalar.nx"

# Operations on atomic types may be synchronized, depending on
# provided memory ordering constraints and fences.
# Atomic operations are still `fragile` and require extra attention
# from the developer to become truly `threadsafe`.
#
# The memory layout of an atomic type is undefined.
#
# Theoretically, any `Numeric` type can be wrapped in `Atomic`.
# In practice, only `Int`, `Float`, `Fixed` and their
# `Imaginary` counterparts are expected to so.
#
# `Int` and `Float` variants are expected to be interchangeable
# with their `_Atomic` counterparts, where appropriate
# (see `as` method declarations in according reopenings).
decl primitive Core::Atomic&lt;Type: T ~ (Numeric)&gt;
  derive Scalar;

  # Non-atomically retreive the underlying value.
  # This method is allowed to be called on a `final` variable.
  decl raw_get : T

  # Non-atomically update the underlying value.
  # Does not return anything to avoid confusion with `swap`.
  decl raw_set(val : T) : Void

  # Atomically fetch the underlying value.
  # This method is allowed to be called on a `final` variable.
  #
  # ```
  # final a = Core::Atomic(42)
  # Core.assert(a == a.fetch == 42)
  # ```
  decl fetch(
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : T forall SS : @~string
  alias == to fetch

  # Atomically store the underlying value.
  # Does not return anything.
  # To store and also get the old value, use `swap` instead.
  #
  # ```
  # let a = Core::Atomic(42)
  # a.store(43)
  # Core.assert(a == 42)
  # ```
  #
  # TODO: Do we really need this method?
  decl store(
    val: T,
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : Void forall SS : @~string

  # Atomically swap the underlying value.
  # Returns the old value.
  #
  # ```
  # let a = Core::Atomic(42)
  # Core.assert(a = 43 == 42)
  # ```
  decl swap(
    val: T,
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : T forall SS : @~string
  alias = to swap

  # TODO:
  decl compare_and_exchange(
    old: T,
    new: T,
    success_ordering: Memory::Ordering = :seqcst,
    failure_ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : Bool forall SS : @~string
  alias cmpxchg to compare_and_exchange

  # Atomically add to the underlying value.
  # Returns the old value.
  #
  # Wraps if called on a `Rational`.
  #
  # ```
  # let a = Core::Atomic(127i8)
  # Core.assert(a += 1 == 127)
  # Core.assert(a == -128)
  # ```
  decl add(
    val: T,
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : T forall SS : @~string
  alias += to add

  # Atomically subtract from the underlying value.
  # Returns the old value.
  #
  # Wraps if called on a `Rational`.
  #
  # ```
  # let a = Core::Atomic(-128i8)
  # Core.assert(a -= 1 == -128)
  # Core.assert(a == 127)
  # ```
  decl subtract(
    val: T,
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : T forall SS : @~string
  alias sub, -= to subtract
end

reopen Core::Atomic&lt;Int&gt;
  # Atomically apply AND operation to the underlying value.
  # Returns the old value.
  #
  # ```
  # let a = Core::Atomic(0b1001_0110)
  # Core.assert(a &amp;= 0b0011_0011 == 0b1001_0110)
  # Core.assert(a == 0b0001_0010)
  # ```
  decl and(
    val: T,
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : T forall SS : @~string
  alias &amp;= to and

  # Atomically apply NAND operation to the underlying value.
  # Returns the old value.
  #
  # ```
  # let a = Core::Atomic(0b1001_0110)
  # Core.assert(a.nand(0b0011_0011) == 0b1001_0110)
  # Core.assert(a ==   0b1110_1101)
  # ```
  decl nand(
    val: T,
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : T forall SS : @~string

  # Atomically apply OR operation to the underlying value.
  # Returns the old value.
  #
  # ```
  # let a = Core::Atomic(0b1001_0110)
  # Core.assert(a |= 0b0011_0011 == 0b1001_0110)
  # Core.assert(a == 0b1011_0111)
  # ```
  decl or(
    val: T,
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : T forall SS : @~string
  alias |= to or

  # Atomically apply XOR operation to the underlying value.
  # Returns the old value.
  #
  # ```
  # let a = Core::Atomic(0b1001_0110)
  # Core.assert(a ^= 0b0011_0011 == 0b1001_0110)
  # Core.assert(a == 0b0100_1010)
  # ```
  decl xor(
    val: T,
    ordering: Memory::Ordering = :seqcst,
    syncscope: SS = ""
  ) : T forall SS : @~string
  alias ^= to xor

  # Convert to an `_Atomic` integer counterpart.
  #
  # MUST be implemented if the target supports `_Atomic` types,
  # i.e. `$__STDC_NO_ATOMICS__` is not defined.
  #
  # Non-fixed width integer types (e.g. `$int`) MUST be supported.
  # Fixed (from `stdint.h`) width integer types SHOULD be supported.
  #
  # Signednesses of the types must match. A `final` atomic type
  # can not be converted to a non-const type.
  #
  # It is not possible to directly convert to a lesser-bitsize type.
  # Target information contained in the Macro API may be used
  # to aid in implementing proper conversion logic.
  #
  # ```
  # final a = Core::Atomic(42) : Core::Atomic&lt;$int&gt;
  # a as $`const _Atomic int` # OK
  # # a as $`_Atomic int` # Panic! Constantness mismatch
  # # a as $`const _Atomic unsigned int` # Panic! Signedness mismatch
  # a as $`const _Atomic int32_t` # May work, depending on target
  #
  # let b = Core::Atomic(42u16)
  # a as $`const _Atomic unsigned short` # OK, turns into const
  # ```
  @[MayPanic("If target bitsize is less than the type's")]
  @[MayPanic("On signednesses mismatch")]
  @[MayPanic("On constantnesses mismatch")]
  virtual decl as(:: T) forall T
end

reopen Core::Atomic&lt;Float&gt;
  # Convert to an `_Atomic` C floating-point type.
  #
  # MUST be implemented if the target supports `_Atomic` types,
  # i.e. `$__STDC_NO_ATOMICS__` is not defined.
  #
  # The target memory layout is defined by the
  # `nx.c.const.[type].layout` macro constraint.
  #
  # Direct conversion is only possible to the same
  # or greater bitsize floating point type, defined by the
  # `nx.c.const.[type].bitsize` constraint.
  # Otherwise, the `as!` method should be used.
  #
  # ```
  # let a = Core::Atomic(42f64) : Core::Atomic&lt;FBin64&gt;
  #
  # # Is likely to succeed, unless `double`
  # # has bitsize greater than 64
  # a as $double # OK
  #
  # # as as $float # Most likely to fail
  # ```
  @[MayPanic("On a possibility of precision loss")]
  virtual decl as(:: T) forall T

  # Convert to an `_Atomic` C floatin-point type,
  # allowing possible precision loss.
  #
  # ```
  # let a = Core::Atomic(42f64) : Core::Atomic&lt;FBin64&gt;
  # a as! $float # OK, but lesser precision
  # ```
  virtual decl as!(:: T) forall T
end

require "./numeric.nx"
require "./hypercomplex.nx"
require "./imaginary.nx"

# The memory layout of a complex number matches such of an array
# of two numbers of the type `T`, whereas the first element
# is the real part, and the second element is the imaginary part.
decl primitive Core::Complex&lt;Type: T ~ Real&gt;
  # A complex number is a specialization of a hypercomplex number.
  derive Hypercomplex&lt;T&gt;;

  # A built-in constructor for a complex number.
  #
  # ```
  # using Core
  #
  # assert(Complex(1, 2j) : Complex&lt;$int&gt; == Complex(1, .(2)))
  # assert(Complex&lt;$double&gt;() == Complex(0.0, .(0))
  # ```
  static nothrow decl ()(
    real : T = 0,
    imaginary : Imaginary&lt;T&gt; = .(0))

  # Return a reference to the real part of the complex number.
  #
  # NOTE: Would return a read-only reference if the number is final.
  decl nothrow real() : T&amp;irw

  # Return a reference to the imaginary part of the complex number.
  #
  # NOTE: Would return a read-only reference if the number is final.
  decl nothrow imaginary() : Imaginary&lt;T&gt;&amp;irw

  # Convert the complex number to the same
  # or higher-bits representation.
  # Would call `as!` on its parts recusively.
  @[MayPanic("If data loss is possible")]
  @[MayPanic("In case of underlying type mismatch")]
  decl nothrow as(~ Complex)

  # Convert the complex number to another (including lower-)
  # bits representaion, allowing data loss.
  # Would call `as!` on its parts recusively.
  @[MayPanic("In case of underlying type mismatch")]
  decl nothrow as!(~ Complex)

  {% for t, _ in ipairs{"float", "double", "long double"} do %}
    # Convert to the same or higher-bits complex floating C type.
    #
    # NOTE: This method is only declared if `T ~ Float`.
    @[MayPanic("If data loss is possible")]
    virtual decl nothrow as(: $`{{ t }} _Complex`)

    # Convert to another (including lower-) bits
    # complex floating C type, allowing data loss.
    #
    # NOTE: This method is only declared if `T ~ Float`.
    virtual decl nothrow as!(: $`{{ t }} _Complex`)
  {% end %}
end

struct Core::SizeError;

require "./fractional.nx"

# A fixed-point number.
decl primitive Fixed&lt;
  Base: 2 || 10,

  # Size of the integral part in `Base`.
  Integral: ~%Natural = 0,

  # Size of the fractional part in `Base`.
  # May be negative for right-shift.
  Fractional: ~%Integer = 0
&gt;
end

alias XBin&lt;*&gt; = Fixed&lt;2, *&gt;
alias XDec&lt;*&gt; = Fixed&lt;10, *&gt;

require "./fractional.nx"

# An IEEE-754 floating-point number.
decl primitive Float&lt;
  Base: ~%Natural,
  Precision: ~%Natural,
  EMax: ~%Natural&gt;
  derive Fractional;
end

alias FBin&lt;
  SignificandBits: ~%Natural,
  ExponentBits: ~%Natural
&gt; = Float&lt;
  2,
  Precision: SignificandBits,
  EMax: \{{ nx.util.natural(2 ^ (nx.ctx.ExponentBits - 1) - 1) }}
&gt;

alias FBin16 = FBin&lt;11, 5&gt; # Not basic, but often implemented
alias FBin32 = FBin&lt;24, 8&gt;
alias FBin64 = FBin&lt;53, 11&gt;
alias FBin128 = FBin&lt;113, 15&gt;

alias FDec&lt;
  Digits: ~%Natural,
  ExponentBits: ~%Natural
&gt; = Float&lt;
  10,
  Precision: Digits,
  EMax: \{{ nx.util.natural(3 * 2 ^ (nx.ctx.ExponentBits - 2) / 2) }}
&gt;

alias FDec32 = FDec&lt;7, 8&gt; # Not basic, but often implemented
alias FDec64 = FDec&lt;16, 10&gt;
alias FDec128 = FDec&lt;34, 14&gt;

# It is only implemented for targets supporting the extended
# double-precision floating-point number format natively.
decl type FBin64E;

# The [Brain floating-point number format][1]
# is ubiquitous in AI computing.
#
# [1]: https://en.wikipedia.org/wiki/Bfloat16_floating-point_format.
alias BFloat16 = FBin&lt;8, 8&gt;

require "./real.nx"

# A fractional, i.e. non-whole, rational number.
trait Fractional
  derive Rational;
end

require "./numeric.nx"

trait Core::Hypercomplex&lt;Type: T ~ Real&gt;
  derive Numeric;
end

require "./real.nx"

# ```
# final i = 5j
# assert(i :? Imaginary&lt;SInt32&gt;)
# assert(i ** 2 == -25)
# ```
@[LiteralSuffix(/j/)]
decl primitive Imaginary&lt;Type: T ~ Real&gt;
  derive Numeric;

  decl initialize(~ T)

  # # Cast a `Real` literal into an `Imaginary` literal.
  # @[LiteralSuffix(/j/)]
  # static decl (~ %(Real)) : %(Imaginary)

  # Coerce to the same or higher bits.
  # Would call `as` on the underlying value.
  #
  # ```
  # 1uj.as_u64j : Imaginary&lt;UInt64&gt;
  # # 1uj.as_u16j # Panic!
  #
  # 1ij.as_i32 : SInt32
  # # 1ij.as_i16 # Panic!
  # ```
  @[MayPanic("If data loss is possible")]
  decl nothrow as(~ (\Imaginary | \Real))

  # Coerce to other (including lower) bits, allowing data loss.
  # Would call `as!` on the underlying value.
  #
  # ```
  # 1uj.as_u16j! : Imaginary&lt;UInt16&gt;
  # 1j.as_i16! : SInt16
  # ```
  decl nothrow as!(~ (\Imaginary | \Real))

  {% for t, _ in ipairs{"float", "double", "long double"} do %}
    # Convert to the same or higher-bits complex floating C type.
    @[MayPanic("If data loss is possible")]
    decl nothrow as(: $`{{ t }} _Complex`)

    # Convert to another (including lower-) bits
    # complex floating C type, allowing data loss.
    decl nothrow as!(: $`{{ t }} _Complex`)
  {% end %}
end

require "./integer.nx"

# You can go from `Natural` to `Integer`, but not vice versa
%!Rational, %!ℚ # -0.5, 1/3, ∞, ∅
%!Integer,  %!ℤ # -1, 0, 1
%!Natural,  %!ℕ # 0, 1
%!Boolean,  %!𝔹 # true, false

%!Range&lt;T&gt;  # 0..0.5

%!Tensor&lt;T&gt; # |[0, 0.5]|
%!Vector&lt;T&gt; # &lt;0, 0.5&gt; # Vector can be treated as `Tensor`

%!Character # 'f'
%!String    # "f"
%!Symbol    # :f

# A binary 2's complement integer.
decl primitive Int&lt;Signed ~ %Bool, Bitsize ~ %Size&gt;
  derive Integer;
  decl initialize(value : self)
end

alias SInt&lt;*&gt; = Int&lt;true, *&gt;
alias UInt&lt;*&gt; = Int&lt;false, *&gt;

alias SInt8 = SInt<i class="conum" data-value="8"></i><b>(8)</b>
alias SInt16 = SInt<i class="conum" data-value="16"></i><b>(16)</b>
alias SInt32 = SInt<i class="conum" data-value="32"></i><b>(32)</b>
alias SInt64 = SInt<i class="conum" data-value="64"></i><b>(64)</b>
alias SInt128 = SInt<i class="conum" data-value="128"></i><b>(128)</b>

alias UInt8 = UInt<i class="conum" data-value="8"></i><b>(8)</b>
alias UInt16 = UInt<i class="conum" data-value="16"></i><b>(16)</b>
alias UInt32 = UInt<i class="conum" data-value="32"></i><b>(32)</b>
alias UInt64 = UInt<i class="conum" data-value="64"></i><b>(64)</b>
alias UInt128 = UInt<i class="conum" data-value="128"></i><b>(128)</b>

alias Bit, Bool = UInt<i class="conum" data-value="1"></i><b>(1)</b>
alias Byte = UInt8

# # The following aliases are implementation-defined.
# # They must be interchangeable with according C types.
# #

# # Every valid character is valid integer, but not vice versa.
# # Therefore, character types are distinct aliases.
# #

# decl distinct alias UChar # Usually `UInt8`
# decl distinct alias SChar # Usually `SInt8`
# decl distinct alias Char  # `$char` (`SChar` or `UChar`)
# decl distinct alias WChar # `$wchar_t` (C17§7.19.2)

# virtual alias SShort    # Usually `SInt16`
# virtual alias SInt      # Usually `SInt16` or `SInt32`
# virtual alias SLong     # Usually `SInt32`
# virtual alias SLongLong # Usually `SInt32` or `SInt64`

# virtual alias UShort    # Usually `UInt16`
# virtual alias UInt      # Usually `UInt16` or `UInt32`
# virtual alias ULong     # Usually `UInt32` or `UInt64`
# virtual alias ULongLong # Usually `UInt64`

# virtual alias Size, USize # `$size_t` (C17§7.19.2)
# virtual alias SSize       # Signed version of `Size`

# # The `Fast` family aliases to the implementation-defined
# # fastest types with at least provided bitsize (C17§7.20.1.3).
# # They must be interchangeable with according C types,
# # for example `UFast16` and `$uint_fast16_t`.

# virtual alias SFast8
# virtual alias SFast16
# virtual alias SFast32
# virtual alias SFast64

# virtual alias UFast8
# virtual alias UFast16
# virtual alias UFast32
# virtual alias UFast64

# # The `Least` family aliases to the implementation-defined
# # smallest types with at least provided bitsize (C17§7.20.1.2).
# # They must be interchangeable with according C types,
# # for example `ULeast16` and `$uint_least16_t`.

# virtual alias SLeast8
# virtual alias SLeast16
# virtual alias SLeast32
# virtual alias SLeast64

# virtual alias ULeast8
# virtual alias ULeast16
# virtual alias ULeast32
# virtual alias ULeast64

# # Fixed-width character types
# # must be interchangeable with
# # according C types (C17§7.28).
# #

# decl distinct alias Char16 to ULeast16; # `$char16_t`
# decl distinct alias Char32 to ULeast32; # `$char32_t`

require "./real.nx"

# A whole number.
trait Integer
  derive Real;
end

require "./aggregate.nx"

decl primitive Core::Array&lt;Type: T, Size ~ %z&gt;
  derive Core::Aggregate;

  # Return a reference to an element at *index*.
  decl def [](index: Size) : T&amp;ir(w: \mut?) throws Core::SizeError
end

require "./tensor.nx"

# A matrix is a 2-dimensional specialization of `Tensor`.
#
# Matrices have literals:
#
# ```
# let m1 = |[1, 2],
#           [3, 4]|r ~ (\%n)x2x2r : (SInt32)x2x2r
#
# let m2 = %i|[1 2]
#             [3 4]|l1 : (SInt32)x2x2c
# ```
alias Core::Matrix&lt;
  Type: T,
  Rows: R,
  Columns: C,
  Leading: L
&gt; to Tensor&lt;T, R, C, L&gt;

require "./scalar.nx"

trait Core::Numeric
  derive Scalar;

  decl equals?(~ Numeric) : Bool
  alias eq?, == to equals?

  decl add(~ Numeric)
  alias + to add

  decl subtract(~ Numeric)
  alias sub, - to subtract

  decl multiply(~ Numeric)
  alias mul, * to subtract

  decl divide(~ Numeric)
  alias div, / to divide

  # Return the modulo operation result, where the result
  # is either zero or has the same sign as the argument.
  decl modulo(~ Numeric)
  alias mod, % to modulo

  # Return the remainder from the division, where the result
  # is either zero or has the same sign as the callee.
  decl remainder(~ Numeric)
  alias rem to remainder

  decl power(~ Numeric)
  alias pow, ** to power
end

# &gt; The quotient of two directed lines in a three-dimensional space.
# &gt; -- &lt;cite&gt;William Rowan Hamilton&lt;/cite&gt;
decl primitive Core::Quaternion&lt;Type: T ~ Real&gt;
  derive Hypercomplex&lt;T&gt;;
end

namespace Quantum
  primitive Bit
    # Set the qubit to a superposition,
    # i.e. apply the Hadamard gate.
    #
    # ```
    # let q = QBit()
    # q.unset()
    # q.get() # Returns either 0 or 1
    # ```
    decl mut unset()

    # Flip the qubit state,
    # i.e. apply the Pauli-X gate.
    #
    # ```
    # let q = QBit()
    # q = 1
    # assert(~q == 0)
    # ```
    decl mut flip()
    alias ~ to flip

    # Set the qubit state.
    #
    # ```
    # let q = QBit()
    # q = 1
    # assert(q == 1)
    # ```
    #
    # NOTE: Change the underlying variable value with `q := QBit()`.
    decl mut set(state : ::Bit)
    alias = to set

    # Measure the qubit value.
    # Returns a binary bit: either 0 or 1.
    #
    # #!see(set)
    decl get() : ::Bit

    # Measure the qubit value and compare it with another qubit's.
    decl equals?(qubit : self) : Bool

    # Measure the qubit value and compare it with another value.
    decl equals?(value : ::Bit) : Bool

    alias eq?, == to equals?
  end
end

alias QBit, Qubit to Quantum::Bit

require "./scalar.nx"

# TODO: IEEE-1788.

# 0..3.each(1).to_a == [0, 1, 2, 3] # %R[0, 3], %Rf[0 3]
# 0...3.each(1).to_a == [0, 1, 2]   # %R[0, 3), %Ri[0 3)
# 0....3.each(1).to_a == [1, 2]     # %R(0, 3), %Ri32j(0 3)
# Range&lt;SInt32, false, true&gt;(0, 3)  # %R(0, 3], %RQ8e-6(0 3]

decl primitive Range&lt;
  Type: T ~ Numeric,
  BoundLower: ~ %Boolean = true,
  BoundUpper: ~ %Boolean = true
&gt;
  derive Scalar;

  decl ()(lower: T,upper: T) : self

  decl .lower() : T
  decl .upper() : T

  decl lower=(self&amp;w, T) : T
  decl upper=(self&amp;w, T) : T

  decl .includes?(T) : Bool
  alias ∋ to includes?

  # Is self subset of another?
  decl .sub?(self) : Bool
  alias ⊆ to sub?

  # Is self superset of another?
  decl .super?(self) : Bool
  alias ⊇ to super?

  # Is self subset and not equals to another?
  decl .strictsub?(self) : Bool
  alias ⊊ to strictsub?

  # Is self superset and not equals to another?
  decl .strictsuper?(self) : Bool
  alias ⊋ to strictsuper?
end

# let range = %R[1, 10]
# range.lower = 0

# trait Foo
#   decl .foo()
# end

# struct Point
#   let (.x, .y, .z) : FBin64
#   let stat : SInt32 = 42

#   def .double: self
#     self(x * 2, y * 2)
#   end
# end

# TODO: A reference (T&amp;) does not neccessarily occupies any memory!

require "./fractional.nx"

# A rational number.
decl primitive Rational&lt;Type: T ~ Integer&gt;
  derive Fractional;

  # An arithmetic overflow.
  struct Overflow;
end

alias Rat&lt;Bitsize: B&gt;, SRat&lt;Bitsize: B&gt; = Rational&lt;SInt&lt;B&gt;&gt;
alias URat&lt;Bitsize: B&gt; = Rational&lt;UInt&lt;B&gt;&gt;

alias Rat8, SRat8 = SRat<i class="conum" data-value="8"></i><b>(8)</b>
alias Rat16, SRat16 = SRat<i class="conum" data-value="16"></i><b>(16)</b>
alias Rat32, SRat32 = SRat<i class="conum" data-value="32"></i><b>(32)</b>
alias Rat64, SRat64 = SRat<i class="conum" data-value="64"></i><b>(64)</b>

alias URat8 = URat<i class="conum" data-value="8"></i><b>(8)</b>
alias URat16 = URat<i class="conum" data-value="16"></i><b>(16)</b>
alias URat32 = URat<i class="conum" data-value="32"></i><b>(32)</b>
alias URat64 = URat<i class="conum" data-value="64"></i><b>(64)</b>

alias Rat, SRat = Rational&lt;SInt&gt;
alias URat = Rational&lt;UInt&gt;

alias ShortRat, SShortRat = Rational&lt;SShort&gt;
alias IntRat, SIntRat = Rational&lt;SInt&gt;
alias LongRat, SLongRat = Rational&lt;SLong&gt;
alias LongLongRat, SLongLongRat = Rational&lt;SLongLong&gt;

alias UShortRat = Rational&lt;UShort&gt;
alias UIntRat = Rational&lt;UInt&gt;
alias ULongRat = Rational&lt;ULong&gt;
alias ULongLongRat = Rational&lt;ULongLong&gt;

alias FastRat&lt;Bitsize: B&gt;, SFastRat&lt;Bitsize: B&gt; = Rational&lt;SFast&lt;B&gt;&gt;
alias UFastRat&lt;Bitsize: B&gt; = Rational&lt;UFast&lt;B&gt;&gt;

alias FastRat8, SFastRat8 = FastRat<i class="conum" data-value="8"></i><b>(8)</b>
alias FastRat16, SFastRat16 = FastRat<i class="conum" data-value="16"></i><b>(16)</b>
alias FastRat32, SFastRat32 = FastRat<i class="conum" data-value="32"></i><b>(32)</b>
alias FastRat64, SFastRat64 = FastRat<i class="conum" data-value="64"></i><b>(64)</b>

alias UFastRat8 = UFastRat<i class="conum" data-value="8"></i><b>(8)</b>
alias UFastRat16 = UFastRat<i class="conum" data-value="16"></i><b>(16)</b>
alias UFastRat32 = UFastRat<i class="conum" data-value="32"></i><b>(32)</b>
alias UFastRat64 = UFastRat<i class="conum" data-value="64"></i><b>(64)</b>

require "./numeric.nx"

# A real number.
trait Real
  derive Numeric;
end

trait Core::Scalar;

# Slice maintains a bit-list of defined elements.
#
# ```
# let s = mut Slice&lt;SInt8, 5&gt;()
#
# assert(@bitsizeof(s) == 45) # 5 * 8 + 5
# assert(@sizeof(s) == 6) # (45f / 8).ceil.to_z
# assert(s.size != s&lt;Size&gt;)
#
# assert(s.size == 0)
# # s[0] # Would throw, because no element is defined yet
# assert(s[0] = 42 == 42)
# assert(s.size == 1)
# assert(s.remove(0) == 42)
# # s[0] # Would throw again
# ```
decl primitive Slice&lt;Type: T, Size: S : @{Size}&gt;
  # Would throw if element is not defined.
  decl mut? get(index: Size): T&amp;i(w: \mut?) throws SizeError
  alias [] to get

  # Define or rewrite an element at *index*.
  decl mut set(index: Size, value: T): T&amp;iw throws SizeError
  alias []= to set

  # Un-define an element at *index*.
  # Further `get` calls would throw.
  decl mut remove(index: Size): T throws SizeError

  # Return an actual size.
  decl size: Size
end

require "./aggregate.nx"

# A growing stack of values.
decl mut primitive Core::Stack&lt;Type: T, Size: S : @~size&gt;
  derive Aggregate;

  # NOTE: The returned reference is temporal because the stack
  # may be shrinked, so the memory region becomes undefined.
  decl push(value: T) : T&amp;tw throws SizeError

  decl pop() : T throws SizeError
  decl pop?() : T?
  decl const size : $size

  # NOTE: The returned reference is temporal because the stack
  # may be shrinked, so the memory region becomes undefined.
  decl mut? [](index: Size) : T&amp;t(w = \mut?) throws SizeError
end

decl primitive String&lt;Encoding: E, Size: S : @{Size}&gt;
  # Access character at *index*. Depending on the encoding,
  # the operation has different complexity.
  # For example, `UTF8` has O(N), while `UCS2` has O(1).
  decl [](index: Size) : Char&lt;E&gt;
end

trait Char::Encoding&lt;
  # A size in bits of a single code unit.
  UnitSize: UZ : @{Size},

  # How many code units are at most
  # required to encode a code point.
  PointSize: PZ : @{Size}
&gt;
  enum Error
    val Encoding
  end

  # Re-encode *char* in this encoding.
  #
  # ```
  # UCS2.encode('a'ascii_) == 'a'ucs2
  # ```
  decl encode(char: Char&lt;E&gt;): Char&lt;this&gt; throws Error forall E

  # A literal initialize macro for this encoding.
  #
  # The macro is called implicitly for each char or string literal.
  #
  # The restriction argument is set in accordance to
  # the autocasting rules. A macro implementation is expected
  # to accept at least `Char&lt;this&gt;` and `Int` restrictions.
  #
  # By default, char and string literals have `UTF16` encoding.
  # Otherwise, the encoding type is calculated by upcasing
  # the literal prefix. A prefix can not contain underscores,
  # thus an encoding type name should not as well.
  #
  # This macro is likely to be implemented natively for built-in
  # encodings. Custom encodings, however, are expected to implement
  # it in user-code if literal suffix availability is desired.
  #

  decl macro @(literal ~ @{Char}, restriction :: Char&lt;this&gt; || Int)
end

# Represents a single codepoint in given `Encoding`.
# A char's size in bits equals to the encoding's
# codeunit size times codepoint size.
#
# ```
# assert(@sizeof('f'ascii_) == 1)
# assert(@sizeof('f'utf8) == 4)
# assert(@sizeof('f') == 2) # UCS2 by default
# ```
primitive Char&lt;Encoding: E ~ Encoding&gt;
  # Initialize from an explicit
  # integral codepoint value.
  #
  # ```
  # 'f'   # Calls `.initialize(literal)`
  # '\66' # Calls THIS initializer
  # ```
  decl initialize(codepoint~ Int);

  # Initialize from a character literal.
  #
  # ```
  # 'f'   # Calls THIS initializer
  # '\66' # Calls `.initialize(codepoint)`
  # ```
  #
  # An example implementation:
  #
  # ```
  # reopen Char&lt;Windows::CP1251&gt;
  #   @[Inline]
  #   impl initialize(literal ~~ L) forall L ~ @{Char}
  #     # Within macros, text values are normalized to Unicode.
  #     \{% if L.value == 'ф' then %}
  #       return self(0xF4)
  # ```
  decl initialize(literal~~ @{Char});

  # ```
  # final a = 'a'ascii_
  #
  # assert(a.to_utf16 == a to Char&lt;UTF16&gt; ==
  #   a.to(Char&lt;UTF16&gt;) == 'a'utf16)
  # ```
  decl to(:: C) : C forall C ~ Char

  # Compare to a character with the same encoding.
  decl equals?(: self&lt;E&gt;): Bool
  alias eq?, == to equals?
end

%utf8["Привет!\0"] : Char&lt;UTF8&gt;[10] # 40 bytes = 320 bits
%&lt;"Ditto"&gt; : Char&lt;UCS2&gt;[5] # 10 bytes = 80 bits
"Привет"utf8u8 # ?

# String and char literals can have encoding prefix and kind suffixes.
"foo" : Array&lt;Char&lt;UTF16&gt;, 3&gt;
"foo"u8 : Array&lt;UInt8, 3&gt; # Only if allowed to do so
# "фу"u8 # Panic!
"фу"utf8u8 : Array&lt;UInt8, 4&gt; # UTF-8 code units take one byte
"фу"utf8 : Array&lt;Char&lt;UTF8&gt;, 4&gt;

"Hello world" : Array&lt;Char&lt;UTF16&gt;, 11&gt;
# Char&lt;ASCII&gt;[12]* can be cast to $char*
# Char&lt;UTF8&gt;[]* as well.
# Any char with encoding unit size == 1 can be?
unsafe! $puts(&amp;"Hello world\0"ascii_) # Address of a passed rvalue

"Привет!\0"utf8
"Привет!\0" # 16 bytes (UCS-2)

module ASCII   &lt; Char::Encoding&lt;8, 1&gt;;
module UCS2    &lt; Char::Encoding&lt;16, 1&gt;;
module UCS4    &lt; Char::Encoding&lt;32, 1&gt;;
module UTF8    &lt; Char::Encoding&lt;8, 4&gt;;
module UTF16   &lt; Char::Encoding&lt;16, 2&gt;;
module UTF32   &lt; Char::Encoding&lt;32, 1&gt;;
module UTF16LE &lt; Char::Encoding&lt;16, 2&gt;;
module UTF32LE &lt; Char::Encoding&lt;32, 1&gt;;
module UTF16BE &lt; Char::Encoding&lt;16, 2&gt;;
module UTF32BE &lt; Char::Encoding&lt;32, 1&gt;;

decl primitive Codeunit&lt;Encoding&gt;;
decl primitive Codepoint&lt;Encoding&gt;;

'f' : CPoint&lt;UCS2&gt; # 2 bytes
"f" : Array&lt;CUnit&lt;UCS2&gt;, 1&gt; # 2 bytes
'f'utf8 : CPoint&lt;UTF8&gt; # 4 bytes
"f"utf8 : Array&lt;CUnit&lt;UTF8&gt;, 1&gt; # 1 byte

'ф'.cunits : Stack&lt;CPoint&lt;UCS2&gt;, 1&gt;
'ф'.cunits.each =&gt; Std.print(&amp;.to_u16) # 1 time
"ф".each =&gt; Std.print(&amp;) # 1 time
"ф"utf8.each =&gt; Std.print(&amp;) # 2 times

require "./aggregate.nx"

# A *D*-dimensional tensor of type *T*
# with *L* being the leading dimension.
#
# As an aggregate type, a tensor has optional mutability.
#
# Tensor types can be shortcut in the following form:
#
# ```
# let t = (SInt32)x2x3x4r
# ```
#
# Where `SInt32` is the type, `2`, `3` and `4` are dimensions,
# and `a` is from "aisle", which is shortcut for setting
# the third dimension leading. Explicit `lN` form can be used
# to specify leading dimension, beginning from 0.
# There are also `r` (`l0`) for "row" and `c` (`l1`) for "column".
decl primitive Tensor&lt;
  Type: T,
  Dimensions: *D ~ %z,
  Leading: L ~ %z
&gt;
  derive Aggregate;

  # TODO: It's not a product, but something else.
  # Nonetheless, it demonstrates passing index pairs:
  # `t1.product(t2, 1 =&gt; 2, 2 =&gt; 4)`.
  decl product(another: self, *index_pairs[D::Size]: %z =&gt; %z)
end

require "./fractional.nx"

# (Type III universal numbers)[1], also known as posits with quires.
#
# Currently, posits are rarely implemented in hardware, therefore
# they shall be used in cases when increased precision is preferable
# over performance loss.
#
# [1]: https://en.wikipedia.org/wiki/Universal_numbers_(data_format).
#

# Type III unums part, a posit.
# Used for floating-point numbers representation.
decl primitive Posit&lt;Bitsize: Z ~ %Size, Exponent: E ~ %Size&gt;
  derive Fractional;

  decl initialize(value : self)
  decl initialize(literal ~ %!Rational)

  # For floating-point numbers, precision loss is considered a norm.
  # Therefore, there is no need in distinct `to_*!` methods family.
  decl to([0]: \T): T forall T ~ Real
end

# The recommended posit sizes and corresponding
# exponent bits and quire sizes:
#
# Posit size (bits) | Number of exponent bits	 | Quire size (bits)
# ---               | ---                      | ---
# 8                 | 0                        | 32
# 16                | 1                        | 128
# 32                | 2                        | 512
# 64                | 3                        | 2048
#
# NOTE: 32-bit posit is expected to be sufficient to solve
# almost all classes of applications[citation needed].

alias Posit8&lt;Exponent = 0&gt; = Posit&lt;8, Exponent&gt;
alias Posit16&lt;Exponent = 1&gt; = Posit&lt;16, Exponent&gt;
alias Posit32&lt;Exponent = 2&gt; = Posit&lt;32, Exponent&gt;
alias Posit64&lt;Exponent = 3&gt; = Posit&lt;64, Exponent&gt;

# Type III unums part, a quire.
# Used for floating-point numbers computation.
#
# ```
# let q = Quire&lt;128&gt;()
# assert(q.add(10p, 20p).to_p == 30)
# ```
decl primitive Quire&lt;Bitsize: B ~ %Size&gt;
  # Fused-multiply–add, i.e. `a * b + c`.
  #
  # ```
  # let q = Quire&lt;128&gt;()
  # assert(q.fmadd(10p, 2p, 5p).to_p == 25)
  # ```
  decl fmadd(multiplied: P1, factor: P2, added: P3): self
  forall P1 ~ Posit, P2 ~ Posit, P3 ~ Posit

  # Fused-dot-product add *a* to *b*.
  #
  # ```
  # let q = Quire&lt;128&gt;()
  # assert(q.add(10p, 20p).to_p == 30)
  # ```
  decl add([0]: P1, [0]: P2): self
  forall P1 ~ Posit, P2 ~ Posit

  # Fused-dot-product subtract *b* from *a*.
  #
  # ```
  # let q = Quire&lt;128&gt;()
  # assert(q.sub(30p, 20p).to_p == 10)
  # ```
  decl subtract(minued: P1, subtrahend: P2): self
  forall P1 ~ Posit, P2 ~ Posit
  alias sub = subtract

  decl to([0]: \T): T forall T ~ Real
end

# TODO: Do we need variadic arguments in the core?
#
# ```
# export void simple_printf(const char* fmt, ...) {
#   final varg = CVArg.init
#
#   # We assume that the pointer is always valid
#   fmt = unsafe! fmt as! $char*cr
#
#   while (*fmt != '\0')
#     if (*fmt == 'd')
#       final i = unsafe! vargs.fetch($int)
#       unsafe! $printf("%d\n", i)
#     else if (*fmt == 'c')
#       final c = unsafe! vargs.fetch($int)
#       unsafe! printf("%c\n", c)
#     else if (*fmt == 'f')
#       final d = unsafe! vargs.fetch($double)
#       printf("%f\n", d)
#     end
#
#     fmt += 1
#   end
# }
#
# export int main() {
#   unsafe! $simple_printf("dcff", 3, 'a', 1.999, 42.5)
# }
# ```
virtual type CVArg
  # Initialize a `CVArg` instance.
  # Must panic if called from not within an exported function.
  # Can be called at most once from a function; panic othwerwise.
  virtual static def init : CVArg

  # Unsafely interpret the next variadic argument as *type*.
  virtual def unsafe fetch(type: :: T) forall T

  # Shallow-copy a `CVArg` instance.
  virtual def copy : CVArg
end

# A variant is considered a scalar object rather than a container,
# thus it does not have mutability. "Mutating" methods such as `set`
# are only callable on non-final variant instances. Check methods
# such as `is?` are subject to standard local behavioural erasure technics.
decl primitive Variant&lt;Types: *T&gt;
  # ```
  # # Would panic if `var` is not local,
  # # otherwise behavioural erasure is applied.
  # (var : Variant&lt;SInt32, FBin64&gt; = SInt32(2)) += 3
  # ```
  decl .set(U) : this forall U in T
  alias .= to .set

  # Check if the actual variant value is of exact *type*.
  #
  # ```
  # final v = @rand(42, "foo")
  # if v.is?(SInt32) then (v : SInt32) += 1
  # assert(v == 43 || v == "foo")
  # ```
  virtual def nothrow is?(type :: U) : Bool forall U

  # Check if the actual variant value is of *type*,
  # i.e. perform a fuzzy match.
  #
  # ```
  # final v = @rand(42, "foo")
  # if v.of?(Int) then (v : SInt32) += 1
  # assert(v == 43 || v == "foo")
  # ```
  virtual def nothrow of?(type :: U) : Bool forall U

  # Try interpreting the actual variant value as *type* exactly.
  # If the value is not the given *type*, returns `Void`.
  #
  # ```
  # final v = @rand(42, "foo")
  # final i = v.as?(SInt32)
  # if i then (i : SInt32) += 1
  # assert(v == 43 || v == "foo")
  # ```
  virtual def nothrow as?(type :: U) : U? forall U

  # Try interpreting the actual variant value as *type* exactly,
  # throwing `AssertionError` in case of mismatch.
  #
  # ```
  # final v = @rand &gt; 0 ? 42 : "foo"
  # v.as!(SInt32) += 1
  # assert(v == 42)
  # ```
  virtual def as!(type :: U) : U throws AssertionError forall U

  # Unsafely intepret actual variant value as *type*.
  #
  # PERFORMANCE: It is faster due to not checking the switch value.
  #
  # ```
  # final v = @rand &gt; 0 ? 42 : "foo"
  # unsafe! v.as!!(SInt32) += 1
  # assert(v == 42)
  # ```
  virtual unsafe def nothrow as!!(type :: U) : U

  # Check if the actual variant value is `Void`.
  #
  # ```
  # final v = @rand(42, Void) : Variant&lt;SInt32, Void&gt; : SInt32?
  # if not v.void? then (v : SInt32) += 1
  # assert(v == 43 || v.void?)
  # ```
  virtual def nothrow void? : Bool

  # Ensure that the actual variant value
  # is not `Void`, throwing otherwise.
  #
  # ```
  # final v = @rand &gt; 0 ? 42 : Void
  # v.novoid! += 1
  # assert(v == 43)
  # ```
  virtual def novoid! : Undef throws AssertionError

  # Check if the actual variant value equals to *value*.
  # It delegates `==` call to underlying types, which may throw.
  #
  # ```
  # final v = @rand(42, "foo")
  # assert(v == 42 or v == "foo")
  # if v == 42 then assert(v :? SInt32)
  # ```
  virtual def maythrow equals?(value : U) : Bool forall U
  alias eq?, == to equals?

  # Set the actual variant value to a new *value*.
  # The old value is finalized.
  # Copy-returns the **new** value if the call has a receiver.
  # Acts similarly to (simple) assignment (`=` or `&lt;-`).
  # Setting is not applicable to final variant instances.
  #
  # ```
  # let v := @rand(42, "foo")
  # assert((v = 43) == v.set(43))
  # ```
  virtual def set(value : U) : (\recv? ? U : Void)

  # Replace the actual variant value with a new *value*.
  # Move-returns the **old** value if the call has a receiver.
  # Otherwise, finalizes the old value.
  # Acts similarly to replace-assignment (`&lt;&lt;=` or `&lt;&lt;-`).
  # Replacing is not applicable to final variant instances.
  #
  # ```
  # let v := @rand(42, "foo")
  # final old := v &lt;&lt;= 43 # Or `v.replace(43)`, `v.replace(&lt;- 43)`
  # assert(old == 42 || old == "foo")
  # ```
  virtual def replace(value : U) : (\recv? ? (&lt;-U) : Void)

  # Swap the actual variant value with target's,
  # updating the switches accordingly.
  # Acts similarly to swap-assignment (`&lt;=&gt;`).
  # Swapping is not applicable to final variant instances.
  #
  # ```
  # let v1 := @rand(42, "foo")
  # let v2 := @rand(43, "bar")
  # final new := v1 &lt;=&gt; v2 # Or `v1.swap(v2)`, `v1.swap(&lt;- v2)`
  # assert(new == 43 || new == "bar")
  # ```
  virtual def swap(target : self*crw) : (\recv? ? U : Void)
end

require "./tensor.nx"

# A vector is a 1-D specialization of `Tensor`.
#
# ```
# let v : (SInt32)x4 = &lt;1, 2, 3, 4&gt;
# let v = %i&lt;1 2 3 4&gt;
# ```
alias Core::Vector&lt;Type: T, Size: S&gt; to Tensor&lt;T, S, 0&gt;
end</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_macros_api"><a class="link" href="#_macros_api">Appendix E: Macros API</a></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lua" data-lang="lua">-- This file defines the Onyx Macro API.
--
-- The following identifiers: `string`, `nil`, `boolean`, `number` and
-- `table`; represent fundamental Lua types. Additional identifiers
-- `int` and `uint` are used to represent whole numbers. Logical
-- operators may be used to express variativity of possible values.
-- Concrete literals may be used to represent exact possible values.
-- Arrays are represented using the `{ type }` notation,
-- e.g. `{ string }`.
--
-- For example, `{foo = { string } or 42 or nil}` means that the `foo`
-- entry may contain either an array of strings, exact number 42, or nil.
--
-- Sum of tables represents an extensions. For example,
-- `foo = bar + { baz = 42 }` means that the `foo` table
-- includes the contents of the `bar` table.
--
-- Special strings beginning from `@` are local to this documentation
-- and should not be implemented. Purposes of each special string are
-- documentented individually.

-- The global Onyx table accessible from any Onyx source code
-- file without any thread-safety considerations.
nx = {
  -- Access current compilation context; the contents may be
  -- sensitive to the position within a source file.
  ctx = {
    -- Access current function implementation, if any.
    impl = nx.Node.FunctionDef or nil,

    -- Access current type (which may
    -- also be the top-level namespace).
    type = nx.Node['@Type'],

    -- Access information about the source code
    -- file currently being compiled.
    file = {
      path = string
    },

    -- A function performing Onyx path lookup in accordance to
    -- the regular lookup rules, from the current context.
    lookup = function (path)
      -- Returns `nil` if lookup failed
      return nx.Node or nil
    end,
  },

  -- Access current compilation target information.
  target = {
    -- The target Instruction Set Architecture.
    -- It may contain additional fields
    -- defined in the Targets Appendix.
    isa = {
      id = string,
    },

    -- A list of deviant target Instruction Set Extensions,
    -- which may be empty. The list of possible ISEs
    -- is defined in the Targets Appendix.
    ise = { string },

    -- An exact target Processing Unit, which may be unknown.
    pu = string or nil,

    -- The target Operating System information,
    -- which may be empty. It may contain additional
    -- fields defined in the Targets Appendix.
    os = {
      id = { string },
    },

    -- A list of target Application Binary Interfaces,
    -- which may be empty. An ABI may have additional
    -- fields defined in the Targets Appendix.
    abi = { { id = string } }
  },

  -- C interoperability constraints and utilities. Note that these
  -- do not neccessarily align with the target's capatibilites.
  --
  -- The table defines some C constraints which are barely express-able
  -- by the C standard, e.g. signedness representation of integers.
  -- Additionally, this information is useful in cases when a program
  -- does not have access to target-specific _hosted_ C headers (§4.6).
  --
  -- Note that it should always be assumed that a program has access
  -- to the target-specific _freestanding_ C headers (§4.6):
  -- float.h, iso646.h, limits.h, stdalign.h, stdarg.h, stdbool.h,
  -- stddef.h, stdint.h and stdnoreturn.h.
  c = {
    -- A function performing C path lookup.
    lookup = function (path)
      -- Returns `nil` if lookup failed
      return nx.c.Node or nil
    end,

    -- Access C integer environment.
    integer = {
      -- "Sign and magnitude", two's, or one's complement.
      signedness = 'SM' or '2C' or '1C',

      -- &gt; ... is whether the value with sign bit 1 and all value bits
      -- zero (for the first two), or with sign bit and all value bits 1
      -- (for ones’ complement), is a trap representation or a normal
      -- value. In the case of sign and magnitude and ones’ complement,
      -- if this representation is a normal value it is called a
      -- negative zero.
      --
      -- Therefore, `{signedness = 'SM', can_trap = false}` means that
      -- negative zero is supported.
      can_trap = bool
    },

    -- TODO:
    -- -- Access C floating-point environment.
    -- floating_point = {
    --   -- Is `INFINITY` supported?
    --   infinity = boolean,

    --   -- Is negative zero supported?
    --   negative_zero = boolean,

    --   -- Are NaNs supported? Note that C treats all NaNs as qNaNs.
    --   nan = boolean,
    -- },

    type = {
      float = {
        format = 'IEEE-754'
      },
      double = {
        format = 'IEEE-754'
      },
      'long double' = {
        format = 'IEEE-754' or 'X87' or 'PPC'
      },
      char = {
        signed = bool -- A char's sign is not defined by the standard
      },
      short = {
        bitsize = int
      },
      int = {
        bitsize = int
      },
      long = {
        bitsize = int
      },
      'long long' = {
        bitsize = int
      }
    },

    Node = {
      Macro = {
        id = value,
        arity = int,
        call = function (args)
          -- Return the result of macro evaluation
          return string
        end
      },
      Constant = {
        Integer = {
          -- The type may be unknown for freestanding constants
          type = nx.c.Node.Type.Int or nil,

          base = 'decimal' or 'octal' or 'hex',
          value = int,
          suffixes = {'unsigned' or ('long' or 'long long')}
        },

        Char = {
          -- The type may be unknown for freestanding constants
          type = nx.c.Node.Type.Int or nil,

          value = string,

          -- TODO: &gt; (byte) If c-char is not representable as a single
          -- byte in the execution character set, the value is
          -- implementation-defined.
          -- TODO: &gt; (16bit, 32bit, wide) If c-char is not
          -- or maps to more than one 16-bit character, the behavior is
          -- implementation-defined.
          -- TODO: &gt; (multichar) has [...] implementation-defined value
          kind = 'byte' or -- E.g. `'a'` or `'\n'` or `'\13'`
            'utf8' or      -- E.g. `u8'a'`
            '16bit' or     -- E.g. `u'貓'`, but not `u'🍌'`
            '32bit' or     -- E.g. `U'貓'`, but not `U'🍌'`
            'wide' or      -- E.g. `L'β'` or `L'貓'`
            'multichar'    -- E.g. `'AB'`
        },

        Floating = {
          -- The type may be unknown for freestanding constants
          type = nx.c.Node.Type.Int or nil,

          base = 'decimal' or 'hex',

          significand = {
            whole = int,
            fraction = uint
          },

          exponent = int or nil,
          suffix = 'f' or 'l' or nil
        },

        String = {
          -- The type may be unknown for freestanding constants,
          -- e.g. `char* = "foo"` has type, but `"foo"` does not.
          type = nx.c.Node.Type.Pointer or nx.c.Node.Type.Array or nil,

          value = string,

          -- TODO: &gt; (byte) If c-char is not representable as a single
          -- byte in the execution character set, the value is
          -- implementation-defined.
          -- TODO: &gt; (16bit, 32bit, wide) If c-char is not
          -- or maps to more than one 16-bit character, the behavior is
          -- implementation-defined.
          -- TODO: &gt; (multichar) has [...] implementation-defined value
          kind = 'byte' or -- E.g. `'a'` or `'\n'` or `'\13'`
            'utf8' or      -- E.g. `u8'a'`
            '16bit' or     -- E.g. `u'貓'`, but not `u'🍌'`
            '32bit' or     -- E.g. `U'貓'`, but not `U'🍌'`
            'wide' or      -- E.g. `L'β'` or `L'貓'`
            'multichar'    -- E.g. `'AB'`
        }
      },
      Type = {
        Int = {
          kind = 'short' or 'int' or 'long' or 'long long',
          signed = boolean,
          atomic = boolean,
          constant = boolean,
          volatile = boolean,
          alignment = int or nil
        },
        Float = {
          kind = 'float' or 'double' or 'long double',
          complex = boolean,
          imaginary = boolean,
          atomic = boolean,
          alignment = int or nil
        },
        Pointer = {
          to = nx.c.Node.Type,
          alignment = int
        },
        Reference = {
          to = nx.c.Node.Type,
          alignment = int
        },
        Struct = {

        },
        Enum = {

        },
        Union = {

        },
        Function = {

        },
      },
      TypeDef = {
        id = string,
        target = nx.c.Node.Type or nil
      },
      FunctionDecl = {

      }
    }
  },

  Node = {
    -- Represent any referencable type.
    ['@Type'] = nx.Node.Namespace or
      nx.Node.Trait or
      nx.Node.Struct or
      nx.Node.Enum or
      nx.Node.Primitive or
      nx.Node.TypeAlias

    -- Represent a declaration.
    ['@Decl'] = nx.Node['@Type'] or
      nx.Node.FunctionDecl or
      nx.Node.FunctionDef or
      nx.Node.VarDecl or
      nx.Node.AnnotationDef or
      nx.Node.MacroDef

    -- A namespace node. Any other type declaration
    -- is also considered a name space.
    Namespace = {
      name = string, -- E.g. `'Bar'` for `::Foo::Bar`

      -- Would be nil for the top-level namespace.
      parent = nx.Node['@Type'] or nil,

      declarations = { nx.Node['@Decl'] },

      -- Return a fully qualified path to the namespace in form of
      -- an array of strings, e.g. `{'Foo', 'Bar'}` for `::Foo::Bar`.
      path = function ()
        return {string}
      end
    },

    -- A trait node
    Trait = nx.Node.Namespace + {
      annotations = { nx.Node.AnnotationCall },

      -- A trait may derive from other traits
      derivees = {
        [1] = {
          trait = nx.Node.TypeRef,
          declarations = { nx.Node['@Decl'] }
        }
      }
    },

    -- A struct node derives from the Trait node
    Struct = nx.Node.Trait,

    -- A enum node, which may also be a flag
    Enum = nx.Node.Namespace + {
      is_flag = true or false,

      -- The enum type, which is `$int` by default
      type = nx.Node.TypeRef,

      elements = { nx.Node.Enum.Element },
      annotations = { nx.Node.TypeRef  },

      -- A enum element
      Element = {
        name = string,
        value = nx.Node.Literal or nil
      }
    },

    Primitive = nx.Node.Namespace,

    FunctionDecl = {
      parent = nx.Node['@Type'],

      visibility = 'public' or 'protected' or 'private' or nil,
      storage = 'static' or 'instance' or nil,
      safety = 'threadsafe' or 'fragile' or 'unsafe' or nil,
      mutability = 'mut' or 'const' or nil,

      name = string,
      arguments = { nx.Node.ArgDecl },

      annotations = { nx.Node.AnnotationCall }
    },

    FunctionDef = {
      parent = nx.Node['@Type'],

      proto = nx.Node.FunctionDecl, -- A prototype per specialization
      body = { nx.Node.Expr },

      annotations = { nx.Node.AnnotationCall }
    },

    VarDecl = {
      parent = nx.Node['@Type'],

      -- Would be nil if undefined
      is_static = true or false or nil,

      -- Would be nil if undefined
      visibility = 'public' or 'protected' or 'private' or nil,

      -- Always defined
      is_final = true or false,

      -- Would be false for `set foo`, always defined
      has_getter = true or false,

      -- Would be false for `get foo` or `final foo`, always defined
      has_setter = true or false,

      name = 'MyVar',
      type = nx.Node.TypeRef or nil,
      annotations = { nx.Node.AnnotationCall }
    },

    -- An annotation definition node
    AnnotationDef = {
      parent = nx.Node['@Type'],
      name = string,

      -- An annotation consists of macro code (may be empty)
      macros = { nx.Node.Macro },

      -- Resolve a full path to the annotation
      path = function,

      -- Annotations may be annotated themselves!
      annotations = { nx.Node.AnnotationCall }
    },

    -- A macro definition node
    MacroDef = {
      parent = nx.Node['@Type'],
      is_builtin = boolean,
      visibility = 'public' or 'protected' or 'private' or nil,
      name = string,
      arguments = { nx.Node.ArgDecl },
      body = { nx.Node.Macro }
    }

    -- An annotation call (i.e. the act of annotating) node
    AnnotationCall = {
      annotation = nx.Node.AnnotationDef,
      arguments = { nx.Node.ArgCall }
    },

    TypeAlias = {
      parent = nx.Node['@Type'],

      name = string,
      arguments = { nx.Node.ArgDecl },

      target_type = nx.Node['@Type'],
      target_arguments = { nx.Node.ArgCall }
    },

    TypeRef = {
      type = nx.Node['@Type'],
      arguments = { nx.Node.ArgCall }
    },

    ArgDecl = {
      name = string or nil,
      alias = string or nil,
      is_static = boolean,
      type = nx.Node.TypeRef or nil,
      annotations = { nx.Node.AnnotationCall },
      has_default_value = boolean
    },

    ArgCall = {
      parent = { nx.Node.TypeRef or nx.Node.FunctionCall },

      -- A link to the target argument declaration, if resolved
      declaration = nx.Node.ArgDecl or nil,

      -- How the argument is referenced.
      -- Would be a number for `[0]:` reference,
      -- a string for named reference,
      -- and nil for a simple sequence
      ref = number or string or nil,

      value = nx.Node.Expr
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_glossary"><a class="link" href="#_glossary">Glossary</a></h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Standard</dt>
<dd>
<p>A widely accepted specification.</p>
</dd>
<dt class="hdlist1">Specification</dt>
</dl>
</div>
<div class="quoteblock">
<blockquote>
A document that states requirements.
</blockquote>
<div class="attribution">
&#8212; ISO 9000:2015 § 3.8.7
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Abstract character</dt>
<dd>
<p>A entry in a <em>character set</em> representing a <em>grapheme</em> or a <em>sememe</em>, usually mapped to a single <em>codepoint</em>.</p>
<div class="paragraph">
<p>A grapheme may be represented in multiple ways in a single character set, and also as a sequence of multiple abstract characters.
For example ⟨å⟩ in Unicode is <code>å</code> (U+61 followed by U+030A) and also <code>å</code> (U+00E5).</p>
</div>
</dd>
<dt class="hdlist1">Allograph</dt>
<dd>
<p>One of many <em>glyphs</em> representing the same <em>grapheme</em>.</p>
</dd>
<dt class="hdlist1">Character set</dt>
<dd>
<p>A mapping of <em>abstract characters</em> to <em>codepoints</em>.
Examples of character set are ISO/IEC 10646, ISO/IEC 646:US.</p>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Codepoint</dt>
<dd>
<p>A numerical value representing an <em>abstract character</em> from a <em>character set</em>.</p>
<div class="paragraph">
<p>A codepoint may be <em>encoded</em> in one or multiple <em>codeunits</em>.</p>
</div>
</dd>
</dl>
</div>
<div id="term-codeunit" class="dlist">
<dl>
<dt class="hdlist1">Codeunit</dt>
<dd>
<p>A sequence of bits in a certain <em>encoding</em>.</p>
<div class="paragraph">
<p>Depending on the encoding, a single or multiple codeunits make up a <em>codepoint</em>.</p>
</div>
</dd>
<dt class="hdlist1">Combined grapheme</dt>
<dd>
<p>A <em>grapheme</em> containing at least one <em>combining abstract character</em>.</p>
</dd>
<dt class="hdlist1">Combining abstract character</dt>
<dd>
<p>An <em>abstract character</em> usually representing a <em>sememe</em> and intended to modify other abstract characters when in a sequence, e.g. <code>◌̊</code> (U+030A).</p>
</dd>
<dt class="hdlist1">Character encoding</dt>
<dd>
<p>A way to encode a <em>codepoint</em> into a sequence of bits.</p>
<div class="paragraph">
<p>Character encoding is not to be confused with <em>character set</em>.
However, sometimes a character encoding has the name of the character set, for example ISO/IEC 646:US (a.k.a. US-ASCII).</p>
</div>
<div class="paragraph">
<p>Other examples of character encoding are UTF-8, UCS-2.</p>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Glyph</dt>
<dd>
<p>An elemental printable symbol intended to represent a <em>grapheme</em>.</p>
</dd>
<dt class="hdlist1">Grapheme</dt>
<dd>
<p>In the scope of this standard, a grapheme is what Unicode defines as a printable character</p>
<div class="quoteblock">
<blockquote>
A unit of writing which is (1) lexically distinctive, (2) has linguistic value (mostly by referring to phonemes, syllables, morphemes, etc.), and is (3) minimal.
</blockquote>
<div class="attribution">
&#8212; Meletis, D.<br>
<cite><a href="https://www.tandfonline.com/doi/full/10.1080/17586801.2019.1697412">Writing Systems Research (2019)</a></cite>
</div>
</div>
<div class="paragraph">
<p>Graphemes include not only letters and digits, but also other printable symbols, such as arrows.
A grapheme is notated with angle brackets, e.g. ⟨a⟩, ⟨A⟩, ⟨å⟩, ⟨1⟩, ⟨→⟩.</p>
</div>
<div class="paragraph">
<p>In a <em>character set</em>, a grapheme is represented by one or multiple <em>abstract characters</em>.</p>
</div>
</dd>
<dt class="hdlist1">Sememe</dt>
<dd>
<p>An abstract semantic unit of meaning.</p>
<div class="paragraph">
<p>In a character set, a sememe is an <em>abstract character</em>.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. An example definition.
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.0.0<br>
Last updated 2020-08-23 17:50:37 UTC
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>